<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>DB CRM ‚Äî Tenant Rep</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:#f4f6f9; --surface:#ffffff; --surface2:#f0f3f7; --border:#dde3ec;
  --border2:#c8d1e0; --text:#0f1929; --text2:#4a5568; --text3:#8a96a8;
  --accent:#1e6fbf; --accent2:#1558a0; --accent-bg:#e8f0fa; --accent-border:#c0d8f5;
  --sidebar:#0f1929; --sidebar-text:#8a9bbf; --sidebar-active:#ffffff; --sidebar-activebg:#1e2d4a;
  --topbar:#ffffff; --topbar-border:#dde3ec;
  --green:#16a34a; --green-bg:#dcfce7; --green-border:#86efac;
  --red:#dc2626; --red-bg:#fee2e2; --red-border:#fca5a5;
  --yellow:#ca8a04; --yellow-bg:#fef9c3; --yellow-border:#fde047;
  --orange:#ea580c; --orange-bg:#ffedd5; --orange-border:#fdba74;
  --purple:#7c3aed; --purple-bg:#ede9fe; --purple-border:#c4b5fd;
  --blue:#1d4ed8; --blue-bg:#dbeafe; --blue-border:#93c5fd;
  --shadow:0 1px 4px rgba(0,0,0,.08); --shadow2:0 4px 16px rgba(0,0,0,.12);
  --radius:8px; --font:'Barlow Condensed','Segoe UI',sans-serif;
}
[data-dark="1"] {
  --bg:#050505; --surface:#0d0d0d; --surface2:#111111; --border:#1e1e1e;
  --border2:#2a2a2a; --text:#e0e0e0; --text2:#888888; --text3:#444444;
  --accent:#3b82f6; --accent2:#2563eb; --accent-bg:#0f1e33; --accent-border:#1e3d66;
  --sidebar:#030303; --sidebar-text:#3a4a6a; --sidebar-active:#ffffff; --sidebar-activebg:#141e30;
  --topbar:#080808; --topbar-border:#1a1a1a;
  --green:#22c55e; --green-bg:#052e16; --green-border:#166534;
  --red:#ef4444; --red-bg:#2d0a0a; --red-border:#7f1d1d;
  --yellow:#eab308; --yellow-bg:#1c1600; --yellow-border:#713f12;
  --orange:#f97316; --orange-bg:#1c0a00; --orange-border:#7c2d12;
  --purple:#a855f7; --purple-bg:#1e0a33; --purple-border:#4a1d8a;
  --blue:#60a5fa; --blue-bg:#0c1d3a; --blue-border:#1e3d7a;
  --shadow:0 1px 4px rgba(0,0,0,.4); --shadow2:0 4px 16px rgba(0,0,0,.6);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font);height:100vh;overflow:hidden;font-size:13px;transition:background .2s,color .2s;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
input,textarea,select{font-family:var(--font);background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);padding:6px 9px;font-size:12px;outline:none;width:100%;transition:border-color .15s;}
input:focus,textarea:focus,select:focus{border-color:var(--accent);}
button{font-family:var(--font);cursor:pointer;}
a{color:var(--accent);text-decoration:none;}
a:hover{text-decoration:underline;}
@keyframes fadeUp{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.card{animation:fadeUp .15s ease;}
.blink{animation:blink 1.8s ease-in-out infinite;}
/* Layout */
#app{display:flex;height:100vh;}
#sidebar{width:214px;background:var(--sidebar);display:flex;flex-direction:column;flex-shrink:0;transition:background .2s;}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#topbar{height:48px;background:var(--topbar);border-bottom:1px solid var(--topbar-border);display:flex;align-items:center;padding:0 20px;gap:10px;flex-shrink:0;box-shadow:var(--shadow);}
#content{flex:1;overflow-y:auto;padding:20px 22px;}
/* Sidebar */
.logo-area{padding:16px 14px 12px;border-bottom:1px solid #1a2840;display:flex;align-items:center;gap:10px;}
.logo-title{font-size:22px;font-weight:800;color:#fff;letter-spacing:.06em;line-height:1;}
.logo-sub{font-size:9px;color:#3a5070;letter-spacing:.18em;text-transform:uppercase;margin-top:1px;}
.quick-area{padding:10px;border-bottom:1px solid #1a2840;display:flex;flex-direction:column;gap:5px;}
.qbtn{width:100%;padding:8px 0;border-radius:6px;font-size:12px;font-weight:700;letter-spacing:.04em;transition:all .15s;border:none;}
.qbtn.primary{background:var(--accent);color:#fff;}
.qbtn.primary:hover{background:var(--accent2);}
.qbtn.secondary{background:#1a2840;color:#6a8ab0;font-size:11px;font-weight:600;}
.qbtn.secondary:hover{background:#1e3050;color:#a0c0e0;}
nav{flex:1;padding:6px 0;overflow-y:auto;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;cursor:pointer;color:var(--sidebar-text);font-size:13px;border-left:2px solid transparent;transition:all .12s;user-select:none;}
.nav-item:hover{color:#a0b8d8;background:#0d1830;}
.nav-item.active{color:var(--sidebar-active);background:var(--sidebar-activebg);border-left-color:var(--accent);}
.nav-item .ni{font-size:12px;width:14px;text-align:center;}
.nav-item .badge{margin-left:auto;background:var(--accent);color:#fff;border-radius:8px;font-size:9px;padding:1px 5px;font-weight:800;}
.sidebar-bottom{padding:8px 10px;border-top:1px solid #1a2840;}
.sbtn{width:100%;padding:5px 0;background:transparent;border:1px solid #1a2840;border-radius:4px;color:#3a5070;font-size:10px;margin-bottom:3px;cursor:pointer;transition:color .1s;}
.sbtn:hover{color:#7090b0;border-color:#2a3850;}
/* Topbar */
.page-title{flex:1;font-size:15px;font-weight:700;color:var(--text);letter-spacing:.04em;}
#search-box{padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;color:var(--text);font-size:12px;width:200px;outline:none;}
#search-box:focus{border-color:var(--accent);}
#clock{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
#save-ind{font-size:10px;color:var(--text3);letter-spacing:.06em;}
.undo-btn{padding:5px 12px;background:var(--accent-bg);border:1px solid var(--accent-border);border-radius:5px;color:var(--accent);font-size:11px;display:none;}
.undo-btn:hover{background:var(--accent);color:#fff;}
.settings-btn{padding:5px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:14px;}
.settings-btn:hover{background:var(--accent-bg);color:var(--accent);border-color:var(--accent-border);}
/* Buttons */
.btn{padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;letter-spacing:.02em;transition:all .12s;font-weight:600;}
.btn:hover{border-color:var(--border2);background:var(--surface2);}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn.primary:hover{background:var(--accent2);border-color:var(--accent2);}
.btn.ghost{background:transparent;border-color:var(--border);color:var(--text2);}
.btn.ghost:hover{color:var(--text);border-color:var(--border2);}
.btn.danger{background:var(--red-bg);border-color:var(--red-border);color:var(--red);}
.btn.danger:hover{background:var(--red);color:#fff;}
.btn.success{background:var(--green-bg);border-color:var(--green-border);color:var(--green);}
.btn.success:hover{background:var(--green);color:#fff;}
.btn.sm{padding:4px 9px;font-size:11px;}
.btn.xs{padding:2px 6px;font-size:10px;}
/* Status Badge Colors */
.sbadge{font-size:9px;padding:2px 8px;border-radius:4px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap;border:1px solid transparent;}
/* Cards */
.item-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:11px 14px;cursor:pointer;margin-bottom:6px;box-shadow:var(--shadow);transition:border-color .12s,box-shadow .12s;}
.item-card:hover{border-color:var(--border2);box-shadow:var(--shadow2);}
.item-card.selected-card{border-color:var(--accent);background:var(--accent-bg);}
.item-card.checked{border-color:var(--accent);background:var(--accent-bg);}
/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:18px;}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow);}
.kpi-lbl{font-size:8px;color:var(--text3);letter-spacing:.15em;text-transform:uppercase;margin-bottom:4px;}
.kpi-val{font-size:22px;font-weight:800;line-height:1;font-family:'DM Mono',monospace;}
/* Dash */
.dash-grid{display:grid;gap:12px;}
.dash-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;box-shadow:var(--shadow);}
.dash-hdr{font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.14em;text-transform:uppercase;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.dash-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;}
.dash-row:last-child{border-bottom:none;}
/* Detail panel */
.detail-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;overflow-y:auto;flex:1;box-shadow:var(--shadow2);}
/* Forms */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.field label{font-size:9px;color:var(--text3);display:block;margin-bottom:3px;letter-spacing:.1em;text-transform:uppercase;font-weight:700;}
.section-wrap{margin-bottom:16px;}
.section-title{font-size:9px;font-weight:700;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;padding-bottom:6px;border-bottom:1px solid var(--border);margin-bottom:10px;cursor:pointer;display:flex;justify-content:space-between;}
/* Commission block */
.comm-block{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:14px;}
.comm-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);}
.comm-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px;}
.comm-cell{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:9px;text-align:center;}
.comm-cell .cl{font-size:8px;color:var(--text3);letter-spacing:.12em;display:block;margin-bottom:3px;}
.comm-cell .cv{font-size:16px;font-weight:800;font-family:'DM Mono',monospace;}
/* Pipeline strip */
.pipeline-strip{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:18px;box-shadow:var(--shadow);}
/* Kanban */
.kanban-wrap{display:flex;gap:10px;overflow-x:auto;padding-bottom:12px;}
.k-col{min-width:195px;border-radius:var(--radius);padding:10px;flex:0 0 195px;}
.k-col-hdr{display:flex;justify-content:space-between;margin-bottom:10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}
.k-col-hdr .cnt{border-radius:8px;padding:1px 6px;font-weight:600;font-size:9px;}
.k-card{border:1px solid transparent;border-radius:6px;padding:9px 11px;margin-bottom:6px;cursor:grab;font-size:12px;box-shadow:var(--shadow);}
/* Progress */
.prog-bar{display:flex;gap:2px;margin:5px 0;}
.prog-seg{flex:1;height:3px;border-radius:2px;}
/* Filter row */
.sf-row{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;}
.sf-btn{padding:4px 9px;border-radius:5px;font-size:10px;letter-spacing:.04em;border:1px solid transparent;font-weight:700;transition:all .1s;cursor:pointer;}
/* Notes */
.note-card{padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;margin-bottom:6px;}
.note-meta{font-size:9px;color:var(--text3);margin-bottom:2px;font-family:'DM Mono',monospace;}
/* Ticker */
.ticker-box{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:9px 12px;display:flex;justify-content:space-between;align-items:center;}
.ticker-lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;}
.ticker-val{font-size:20px;font-weight:800;font-family:'DM Mono',monospace;}
/* Calendar */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{min-height:70px;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:4px;}
.cal-day.today{background:var(--accent-bg);border-color:var(--accent);}
.cal-day-num{font-size:10px;color:var(--text3);margin-bottom:2px;font-weight:600;}
.cal-day.today .cal-day-num{color:var(--accent);font-weight:800;}
.cal-ev{font-size:9px;border-radius:3px;padding:1px 4px;margin-bottom:1px;cursor:pointer;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
/* Exp bar */
.exp-bar-wrap{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:12px;}
/* Drive */
.drive-wrap{background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--radius);padding:11px 14px;margin-bottom:12px;display:flex;align-items:center;gap:10px;}
/* Mass bar */
.mass-bar{background:var(--accent-bg);border:1px solid var(--accent-border);border-radius:var(--radius);padding:9px 14px;display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
/* Activity */
.act-row{display:grid;grid-template-columns:90px 80px 100px 1fr;padding:9px 14px;border-bottom:1px solid var(--border);font-size:12px;align-items:center;}
/* Market table */
.mkt-table{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
.mkt-hdr{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 36px;padding:8px 14px;border-bottom:1px solid var(--border);font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;background:var(--surface2);}
.mkt-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 36px;padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;align-items:center;}
/* Closed */
.big-ticker{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:22px;text-align:center;margin-bottom:16px;}
.fu-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
.fu-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;text-align:center;}
/* Templates */
.tpl-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;cursor:pointer;margin-bottom:6px;transition:border-color .1s;}
.tpl-item:hover{border-color:var(--border2);}
.tpl-item.selected{border-color:var(--accent);background:var(--accent-bg);}
/* Upcoming */
.upcoming-ev{padding:7px 0;border-bottom:1px solid var(--border);}
.upcoming-ev:last-child{border-bottom:none;}
/* Trash */
.trash-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:13px 15px;margin-bottom:7px;display:flex;gap:12px;align-items:flex-start;box-shadow:var(--shadow);}
.trash-type{font-size:9px;padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.06em;font-weight:700;flex-shrink:0;margin-top:2px;}
/* Referral */
.ref-col{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;flex:1;box-shadow:var(--shadow);}
.ref-card{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:6px;}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center;}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;max-width:660px;width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.25);}
/* Toast / Undo bar */
#toast{position:fixed;bottom:22px;right:22px;background:var(--text);color:var(--surface);padding:10px 18px;border-radius:8px;font-size:13px;font-weight:600;z-index:9999;box-shadow:var(--shadow2);display:none;}
#undo-bar{position:fixed;bottom:64px;right:22px;background:var(--surface);border:1px solid var(--accent-border);border-radius:8px;padding:9px 14px;display:none;align-items:center;gap:10px;font-size:12px;z-index:9998;box-shadow:var(--shadow2);color:var(--text);}
/* Status monitor */
.status-monitor{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:14px;}
/* Checkbox */
.cb{width:15px;height:15px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;}
/* Chart */
#comm-chart-canvas{border-radius:var(--radius);}
/* Drag indicator */
.drag-handle{cursor:grab;color:var(--text3);font-size:14px;margin-right:6px;}
.dash-card.drag-over{border-color:var(--accent);background:var(--accent-bg);}
/* Settings */
.settings-section{margin-bottom:20px;}
.settings-section-title{font-size:10px;font-weight:700;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.toggle{width:38px;height:20px;background:var(--border2);border-radius:10px;cursor:pointer;position:relative;transition:background .2s;border:none;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);}
.toggle.on::after{transform:translateX(18px);}
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="logo-area">
      <svg width="36" height="36" viewBox="0 0 80 80" fill="none">
        <ellipse cx="40" cy="50" rx="14" ry="17" fill="#c8d8f0"/>
        <path d="M40 30 C35 25 20 27 10 22 C15 30 23 32 30 35 L40 50 L50 35 C57 32 65 30 70 22 C60 27 45 25 40 30Z" fill="#e8f0ff"/>
        <path d="M10 22 C5 19 1 24 3 31 C8 29 13 26 10 22Z" fill="#a0b8e0"/>
        <path d="M70 22 C75 19 79 24 77 31 C72 29 67 26 70 22Z" fill="#a0b8e0"/>
        <circle cx="40" cy="32" r="7" fill="#e8f0ff"/>
        <circle cx="37.5" cy="30.5" r="2" fill="#0f1929"/>
        <circle cx="42.5" cy="30.5" r="2" fill="#0f1929"/>
        <path d="M36.5 35.5 Q40 38 43.5 35.5" stroke="#6080a0" stroke-width="1.2" fill="none"/>
        <path d="M30 55 Q40 65 50 55" fill="#c8d8f0"/>
        <path d="M33 55 Q40 61 47 55" fill="#a0b8d8"/>
      </svg>
      <div><div class="logo-title">DB CRM</div><div class="logo-sub">Tenant Rep</div></div>
    </div>
    <div class="quick-area">
      <button class="qbtn primary" onclick="openModal('new-deal')">+ New Deal</button>
      <button class="qbtn secondary" onclick="openModal('quick-prospect')">‚ö° Quick Prospect</button>
    </div>
    <nav id="nav"></nav>
    <div class="sidebar-bottom">
      <button class="sbtn" onclick="openCalcModal()" style="background:var(--purple-bg,#2d1a4d);color:var(--purple,#a855f7);border-color:var(--purple-border,#7e22ce);font-weight:700">üßÆ CRE Calculator</button>
      <button class="sbtn" onclick="exportBackup()" style="background:#1a2d1a;color:#4ade80;border-color:#166534;font-weight:700;letter-spacing:.04em">üíæ Backup Full CRM</button>
      <button class="sbtn" onclick="importBackup()">‚Üë Restore Backup</button>
      <button class="sbtn" onclick="exportCSV(state.deals,'db-deals.csv')">‚Üì Export Deals CSV</button>
      <button class="sbtn" onclick="exportCSV(state.prospects,'db-prospects.csv')">‚Üì Export Prospects CSV</button>
    </div>
  </div>
  <div id="main">
    <div id="topbar">
      <div class="page-title" id="page-title">Command Center</div>
      <span id="save-ind">‚óè Saved</span>
      <button class="undo-btn" id="undo-btn" onclick="doUndo()">‚Ü© Undo</button>
      <input id="search-box" placeholder="üîç  Search entire CRM‚Ä¶" oninput="onSearchInput()"/>
      <div id="clock"></div>
      <button class="settings-btn" onclick="openModal('settings')" title="Settings">‚öô</button>
    </div>
    <div id="content"></div>
  </div>
</div>
<div id="toast"></div>
<div id="undo-bar"><span id="undo-msg"></span><button class="btn sm primary" onclick="doUndo()">Undo</button><button class="btn sm ghost" style="margin-left:4px" onclick="q('undo-bar').style.display='none'">‚úï</button></div>
<div id="modal-overlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" id="modal-box"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê
const SK='dbcrm_v7';
let state=load();
let settings=loadSettings();
let currentView='dashboard';
let selectedDeal=null,selectedProspect=null,selectedClosed=null,selectedTpl=null,evalDealId=null,evalDealType='lease';
let dealFilter='All',prosFilter='All',actFilter='All',closedFilter='All';
let dealActType='Call',prosActType='Call';
let calM=new Date().getMonth(),calY=new Date().getFullYear();
let undoStack=[],undoLabels=[];
let dragItem=null;
let dealSel=new Set(),prosSel=new Set(),closedSel=new Set(),closedSelMode=false;
let dealSelMode=false,prosSelMode=false;
let dashOrder=['pipeline','urgent','priority','stale','upcoming','active','commission'];

function load(){try{const r=localStorage.getItem(SK);if(r)return{...defState(),...JSON.parse(r)};}catch(e){}return defState();}
function defState(){return{deals:[],prospects:[],activities:[],calendar:[],comps:[],emailTemplates:defTpls(),trash:[],referrals:{referred:[],given:[]}};}
function saveState(){try{localStorage.setItem(SK,JSON.stringify(state));}catch(e){}const si=q('save-ind');if(si){si.textContent='‚óè Saved';si.style.color='var(--green)';setTimeout(()=>{if(si)si.style.color='var(--text3)';},2000);}}
function loadSettings(){try{const r=localStorage.getItem(SK+'_settings');if(r)return{...defSettings(),...JSON.parse(r)};}catch(e){}return defSettings();}
function defSettings(){return{dark:false,taxRate:30,dashOrder:['pipeline','urgent','priority','stale','upcoming','active','commission']};}
function saveSettings(){try{localStorage.setItem(SK+'_settings',JSON.stringify(settings));}catch(e){}applyTheme();}
function applyTheme(){document.documentElement.setAttribute('data-dark',settings.dark?'1':'0');}

function pushUndo(lbl){undoStack.push(JSON.stringify(state));undoLabels.push(lbl);if(undoStack.length>30){undoStack.shift();undoLabels.shift();}const b=q('undo-btn');if(b)b.style.display='block';}
function doUndo(){if(!undoStack.length)return;state=JSON.parse(undoStack.pop());const lbl=undoLabels.pop();saveState();toast('Undone: '+lbl);q('undo-bar').style.display='none';if(!undoStack.length){const b=q('undo-btn');if(b)b.style.display='none';}render();}
function showUndoBar(msg){const b=q('undo-bar'),m=q('undo-msg');if(b&&m){m.textContent=msg;b.style.display='flex';setTimeout(()=>b.style.display='none',7000);}}

// ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê
const CLIENT_ST=['First Touch','Site Selection','Touring','Proposal/LOI','Negotiating','Leased/Purchased'];
const ACTIVE_ST=CLIENT_ST.filter(s=>s!=='Leased/Purchased'); // Pipeline only ‚Äî no closed
const PROSP_ST=['First Touch','Second Touch','Third Touch','Warm','Not Interested','Keep in Mind'];
const ACT_TYPES=['Call','Email','Tour','Mailer','Canvassing','Note'];
const TRASH_DAYS=180;

function stColor(s){
  const m={
    'First Touch':       {bg:'var(--surface2)',text:'var(--text3)',border:'var(--border)'},
    'Site Selection':    {bg:'var(--blue-bg)',text:'var(--blue)',border:'var(--blue-border)'},
    'Touring':           {bg:'var(--yellow-bg)',text:'var(--yellow)',border:'var(--yellow-border)'},
    'Proposal/LOI':      {bg:'var(--orange-bg)',text:'var(--orange)',border:'var(--orange-border)'},
    'Negotiating':       {bg:'var(--green-bg)',text:'var(--green)',border:'var(--green-border)'},
    'Leased/Purchased':  {bg:'#d1fae5',text:'#065f46',border:'#6ee7b7'},
    'Lost':              {bg:'var(--red-bg)',text:'var(--red)',border:'var(--red-border)'},
    'Second Touch':      {bg:'var(--blue-bg)',text:'var(--blue)',border:'var(--blue-border)'},
    'Third Touch':       {bg:'var(--purple-bg)',text:'var(--purple)',border:'var(--purple-border)'},
    'Warm':              {bg:'var(--yellow-bg)',text:'var(--yellow)',border:'var(--yellow-border)'},
    'Not Interested':    {bg:'var(--red-bg)',text:'var(--red)',border:'var(--red-border)'},
    'Keep in Mind':      {bg:'var(--purple-bg)',text:'var(--purple)',border:'var(--purple-border)'},
  };
  return m[s]||{bg:'var(--surface2)',text:'var(--text3)',border:'var(--border)'};
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
const uid=()=>Math.random().toString(36).slice(2,9)+Date.now().toString(36);
const tod=()=>new Date().toISOString().slice(0,10);
const fmt=d=>d?new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';
const daysUntil=d=>d?Math.ceil((new Date(d+'T12:00:00')-new Date())/86400000):null;
const daysSince=d=>d?Math.floor((new Date()-new Date(d+'T12:00:00'))/86400000):null;
const usd=n=>'$'+Number(n||0).toLocaleString('en-US',{maximumFractionDigits:0});
const num=n=>isNaN(parseFloat(n))?0:parseFloat(n);
const esc=s=>(s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const q=id=>document.getElementById(id);
const srch=()=>(q('search-box')||{}).value||'';
function actC(t){return{Call:'#1e6fbf',Email:'#7c3aed',Tour:'#ca8a04',Mailer:'#ea580c',Canvassing:'#16a34a',Note:'#6b7280'}[t]||'#6b7280';}
function priColor(p){return{High:'var(--red)',Medium:'var(--yellow)',Low:'var(--text3)'}[p]||'var(--text3)';}
function calcLeaseTotal(sf,psf,termYrs,escPct){
  // Calculate total lease value accounting for annual escalations
  // escPct = percentage like 3 meaning 3% per year
  if(!sf||!psf||!termYrs)return{annual:sf*psf,total:sf*psf*termYrs,monthly:(sf*psf)/12,breakdown:[]};
  const esc=num(escPct)/100;
  const annual=sf*psf;
  let total=0,breakdown=[];
  for(let yr=0;yr<termYrs;yr++){
    const yAmt=annual*Math.pow(1+esc,yr);
    total+=yAmt;
    breakdown.push({yr:yr+1,annual:yAmt,monthly:yAmt/12,psf:psf*Math.pow(1+esc,yr)});
  }
  return{annual,total,monthly:annual/12,breakdown};
}
function calcComm(deal){
  const isLease=(!deal.dealType||deal.dealType==='Lease');
  const pct=num(deal.commPct||3);
  const taxRate=num(settings.taxRate||30)/100;
  let gross=0,annual=0,total=0,monthly=0,breakdown=[];
  if(isLease){
    const sf=num(deal.size),psf=num(deal.budget||deal.costPsf),term=num(deal.leaseTerm),esc=num(deal.annualEscalation||0);
    const lt=calcLeaseTotal(sf,psf,term,esc);
    annual=lt.annual;total=lt.total;monthly=lt.monthly;breakdown=lt.breakdown;
    gross=total*(pct/100);
    // Effective rent includes op ex for total occupancy cost
    const opEx=num(deal.opEx||0);
    const effectiveAnnual=annual+(opEx*sf);
    const effectiveMonthly=effectiveAnnual/12;
  } else {
    // Purchase ‚Äî commission on purchase price
    const price=num(deal.purchasePrice);
    const sf=num(deal.size);
    if(price){gross=price*(pct/100);}
    annual=price;total=price;monthly=0;
  }
  const split=gross*.7,take=split*.7,afterTax=take*(1-taxRate);
  const opEx=num(deal.opEx||0),sf2=num(deal.size);const effectiveAnnual=annual+(opEx*sf2);const effectiveMonthly=effectiveAnnual/12;
  return{annual,total,monthly,gross,split,take,afterTax,pct,breakdown,effectiveAnnual,effectiveMonthly,opEx};
}
function toast(msg,ms=3200){const t=q('toast');if(!t)return;t.textContent=msg;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',ms);}
function nilHtml(txt){return`<div style="color:var(--text3);font-size:12px;padding:14px 0;text-align:center">${txt}</div>`;}

// ‚ïê‚ïê‚ïê STATUS BADGE ‚ïê‚ïê‚ïê
function sbadge(s){const c=stColor(s);return`<span class="sbadge" style="background:${c.bg};color:${c.text};border-color:${c.border}">${esc(s||'‚Äî')}</span>`;}
function sfRow(statuses,active,varName){return`<div class="sf-row">${statuses.map(s=>{const c=s==='All'?{bg:'var(--accent)',text:'#fff',border:'var(--accent)'}:stColor(s);const isA=active===s;return`<button class="sf-btn" style="background:${isA?c.bg:'var(--surface2)'};color:${isA?c.text:'var(--text3)'};border-color:${isA?c.border:'var(--border)'}" onclick="${varName}='${s}';renderContent()">${s}</button>`;}).join('')}</div>`;}
function statusBtns(statuses,current,onclickStr){return`<div class="sf-row" style="margin-bottom:14px">${statuses.map(s=>{const c=stColor(s);const isA=current===s;const isClose=s==='Leased/Purchased';const clickAction=isClose&&current!=='Leased/Purchased'?`if(confirm('Mark as closed? Deal will move to Closed Deals.')){${onclickStr}}`:onclickStr;return`<button class="sf-btn" style="background:${isA?c.bg:isClose?'#f0fdf4':'var(--surface2)'};color:${isA?c.text:isClose?'var(--green)':'var(--text3)'};border-color:${isA?c.border:isClose?'#6ee7b7':'var(--border)'}" data-s="${s}" onclick="${clickAction}" title="${isClose?'‚úÖ Close deal ‚Äî moves to Closed Deals':s}">${isClose?'‚úÖ Closed':s}</button>`;}).join('')}</div>`;}
function priDot(p){if(!p)return'';return`<span style="font-size:9px;color:${priColor(p)};font-weight:700;margin-top:3px;display:block">‚óè ${p.toUpperCase()}</span>`;}
function progBar(step,total,statuses){return`<div class="prog-bar">${Array.from({length:total+1},(_,i)=>{const c=stColor(statuses[i]);return`<div class="prog-seg" style="background:${i<=step?c.text:'var(--border)'}"></div>`;}).join('')}</div>`;}

// ‚ïê‚ïê‚ïê TRASH ‚ïê‚ïê‚ïê
function trashItem(type,item,label){pushUndo('Delete '+label);state[type]=state[type].filter(x=>x.id!==item.id);state.trash.push({id:uid(),type,data:JSON.parse(JSON.stringify(item)),deletedAt:tod(),label:label||'Item'});purgeTrash();saveState();showUndoBar('Deleted: '+label);render();}
function trashMany(type,ids,label){pushUndo('Delete '+ids.size+' '+type);const items=state[type].filter(x=>ids.has(x.id));items.forEach(item=>state.trash.push({id:uid(),type,data:JSON.parse(JSON.stringify(item)),deletedAt:tod(),label:item.companyName||item.tenantName||'Item'}));state[type]=state[type].filter(x=>!ids.has(x.id));purgeTrash();saveState();toast('Deleted '+items.length);if(type==='deals'){dealSel=new Set();dealSelMode=false;if(selectedDeal&&ids.has(selectedDeal.id))selectedDeal=null;}if(type==='prospects'){prosSel=new Set();prosSelMode=false;if(selectedProspect&&ids.has(selectedProspect.id))selectedProspect=null;}render();}
function restoreTrash(tid){pushUndo('Restore');const ti=state.trash.find(x=>x.id===tid);if(!ti)return;state[ti.type]=[...state[ti.type],ti.data];state.trash=state.trash.filter(x=>x.id!==tid);saveState();toast('Restored: '+ti.label);render();}
function permDelete(tid){if(!confirm('Permanently delete?'))return;state.trash=state.trash.filter(x=>x.id!==tid);saveState();toast('Permanently deleted');render();}
function purgeTrash(){const cut=new Date();cut.setDate(cut.getDate()-TRASH_DAYS);state.trash=state.trash.filter(x=>new Date(x.deletedAt)>=cut);}
function emptyTrash(){if(!confirm('Empty entire trash?'))return;pushUndo('Empty trash');state.trash=[];saveState();toast('Trash emptied');render();}

// ‚ïê‚ïê‚ïê CRUD ‚ïê‚ïê‚ïê
function addDeal(d){pushUndo('Add deal');state.deals.push({...d,id:uid(),createdAt:tod(),updatedAt:tod(),notes:[],activities:[]});saveState();toast('Deal added');render();}
function updDeal(id,p){
  state.deals=state.deals.map(d=>d.id===id?{...d,...p,updatedAt:tod()}:d);
  if(selectedDeal&&selectedDeal.id===id)selectedDeal=state.deals.find(d=>d.id===id);
  saveState();
  // If deal just got marked Leased/Purchased, auto-route to closed deals
  if(p.status==='Leased/Purchased'){
    const d=state.deals.find(x=>x.id===id);
    selectedDeal=null;
    selectedClosed=id;
    toast('‚úÖ Deal closed! Moved to Closed Deals.');
    setView('closed');
    return;
  }
  renderContent();
}
function delDeal(id){const d=state.deals.find(x=>x.id===id);if(!d)return;trashItem('deals',d,d.tenantName||d.companyName||'Deal');if(selectedDeal&&selectedDeal.id===id)selectedDeal=null;}
function addProspect(p){pushUndo('Add prospect');state.prospects.push({...p,id:uid(),createdAt:tod(),lastTouched:tod(),notes:[],activities:[]});saveState();toast('Prospect added');render();}
function updProspect(id,p){state.prospects=state.prospects.map(x=>x.id===id?{...x,...p}:x);if(selectedProspect&&selectedProspect.id===id)selectedProspect=state.prospects.find(x=>x.id===id);saveState();renderContent();}
function delProspect(id){const p=state.prospects.find(x=>x.id===id);if(!p)return;trashItem('prospects',p,p.companyName||'Prospect');if(selectedProspect&&selectedProspect.id===id)selectedProspect=null;}
function prospectToDeal(id){const p=state.prospects.find(x=>x.id===id);if(!p)return;pushUndo('Convert to deal');const deal={tenantName:p.companyName,contactName:p.contactName,contactPhone:p.phone,contactEmail:p.email,currentAddress:p.companyAddress,size:p.currentSf||'',budget:p.currentPsf||'',leaseExpiration:p.leaseExp||'',status:'First Touch',priority:p.priority||'Medium',commPct:'3',notes:[...p.notes||[]],activities:[...p.activities||[]],id:uid(),createdAt:tod(),updatedAt:tod()};state.deals.push(deal);state.prospects=state.prospects.filter(x=>x.id!==id);state.trash.push({id:uid(),type:'prospects',data:p,deletedAt:tod(),label:(p.companyName||'Prospect')+' ‚Üí converted'});saveState();toast('Converted to Deal');selectedProspect=null;setView('deals');}
function moveManyProspects(ns){if(!prosSel.size)return;pushUndo('Move prospects');state.prospects=state.prospects.map(p=>prosSel.has(p.id)?{...p,status:ns}:p);saveState();toast('Moved '+prosSel.size);prosSel=new Set();prosSelMode=false;renderContent();}
function moveManyDeals(ns){
  if(!dealSel.size)return;
  pushUndo('Move deals');
  const count=dealSel.size;
  state.deals=state.deals.map(d=>dealSel.has(d.id)?{...d,status:ns,updatedAt:tod()}:d);
  saveState();
  dealSel=new Set();dealSelMode=false;
  if(ns==='Leased/Purchased'){
    toast('‚úÖ '+count+' deal'+( count!==1?'s':'')+' closed and moved to Closed Deals!');
    setView('closed');
  } else {
    toast('Moved '+count+' deal'+(count!==1?'s':'')+' to '+ns);
    renderContent();
  }
}
function convertSelToDeals(){if(!prosSel.size)return;pushUndo('Convert prospects');[...prosSel].forEach(id=>{const p=state.prospects.find(x=>x.id===id);if(!p)return;state.deals.push({tenantName:p.companyName,contactName:p.contactName,contactPhone:p.phone,contactEmail:p.email,currentAddress:p.companyAddress,size:p.currentSf||'',budget:p.currentPsf||'',leaseExpiration:p.leaseExp||'',status:'First Touch',priority:p.priority||'Medium',commPct:'3',notes:[...p.notes||[]],activities:[...p.activities||[]],id:uid(),createdAt:tod(),updatedAt:tod()});state.trash.push({id:uid(),type:'prospects',data:p,deletedAt:tod(),label:(p.companyName||'Prospect')+' ‚Üí converted'});});state.prospects=state.prospects.filter(p=>!prosSel.has(p.id));saveState();toast('Converted '+prosSel.size+' prospects');prosSel=new Set();prosSelMode=false;setView('deals');}
function addEvent(ev){pushUndo('Add event');state.calendar.push({...ev,id:uid(),createdAt:tod()});saveState();toast('Event saved');render();}
function delEvent(id){const e=state.calendar.find(x=>x.id===id);if(!e)return;trashItem('calendar',e,e.title||'Event');}
function addComp(c){pushUndo('Add comp');state.comps.push({...c,id:uid(),createdAt:tod()});saveState();toast('Comp added');render();}
function delComp(id){const c=state.comps.find(x=>x.id===id);if(!c)return;trashItem('comps',c,c.address||'Comp');}
function updComp(id,p){state.comps=state.comps.map(c=>c.id===id?{...c,...p}:c);saveState();}
let editCompId=null;
function startEditComp(id){editCompId=id;renderContent();}
function saveEditComp(){const c=state.comps.find(x=>x.id===editCompId);if(!c)return;pushUndo('Edit comp');updComp(editCompId,{address:q('ec-addr')?.value||c.address,submarket:q('ec-sub')?.value||'',size:q('ec-sz')?.value||'',askingPsf:q('ec-psf')?.value||'',leaseTerm:q('ec-lt')?.value||'',landlord:q('ec-ll')?.value||'',vacancyRate:q('ec-vac')?.value||'',notes:q('ec-notes')?.value||''});editCompId=null;toast('Comp updated');renderContent();}
function cancelEditComp(){editCompId=null;renderContent();}
function logActivity(entityId,type,noteText){const a={id:uid(),entityId,type,note:noteText,date:tod(),createdAt:new Date().toISOString()};state.activities.unshift(a);const d=state.deals.find(x=>x.id===entityId);if(d)updDeal(entityId,{lastActivity:tod()});else{const p=state.prospects.find(x=>x.id===entityId);if(p)updProspect(entityId,{lastTouched:tod()});}saveState();}

// ‚ïê‚ïê‚ïê REFERRALS ‚ïê‚ïê‚ïê
function addReferral(type,data){pushUndo('Add referral');if(!state.referrals)state.referrals={referred:[],given:[]};state.referrals[type].push({...data,id:uid(),createdAt:tod()});saveState();toast('Referral saved');renderContent();}
function delReferral(type,id){pushUndo('Delete referral');state.referrals[type]=state.referrals[type].filter(x=>x.id!==id);saveState();renderContent();}

// ‚ïê‚ïê‚ïê CSV ‚ïê‚ïê‚ïê
function parseCSV(text){const lines=text.trim().split(/\r?\n/);if(lines.length<2)return[];const hdrs=lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim().toLowerCase().replace(/[\s\/\-]+/g,'_').replace(/[^a-z0-9_]/g,''));return lines.slice(1).map(line=>{const vals=[];let cur='',inQ=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"')inQ=!inQ;else if(c===','&&!inQ){vals.push(cur);cur='';}else cur+=c;}vals.push(cur);const obj={};hdrs.forEach((h,i)=>{obj[h]=(vals[i]||'').replace(/^"|"$/g,'').trim();});return obj;});}
const DMAPS={tenantName:['tenantname','company','companyname'],contactName:['contactname','contact','name'],contactPhone:['contactphone','phone'],contactEmail:['contactemail','email'],location:['location','address'],size:['size','sf'],budget:['budget','psf','rate'],leaseTerm:['leaseterm','term'],status:['status'],priority:['priority'],leaseExpiration:['leaseexpiration','expiration'],driveUrl:['driveurl','drive','google_drive_file','googledrivefile'],requirements:['requirement','requirements'],notes:['notes'],annualEscalation:['annualescalation','escalation','annual_escalation']};
const PMAPS={companyName:['companyname','company','company_name'],contactName:['contactname','contact','name','contact_name'],phone:['phone','contactphone','contact_phone'],email:['email','contactemail','contact_email'],companyAddress:['companyaddress','address','company_address'],source:['source'],status:['status'],priority:['priority'],leaseExp:['leaseexp','expiration'],currentSf:['currentsf'],currentPsf:['currentpsf'],notes:['notes'],lastTouched:['lasttouch','lasttouchdate','last_touch_date','last_touch']};
const CMAPS={address:['address','property'],city:['city'],submarket:['submarket','area'],buildingClass:['buildingclass','building_class','class'],size:['size','sf','leasedsf','leased_sf'],totalSf:['totalsf','total_sf'],leaseTerm:['leaseterm','term','sales_lease_term_mo','salesleasetermmo'],leaseType:['leasetype','lease_type','type'],askingPsf:['askingpsf','psf','rate','sales_lease_rate','salesleaserate'],landlord:['landlord'],vacancyRate:['vacancyrate','vacancy'],notes:['notes','comments']};
function mapRow(row,maps){const out={};Object.entries(maps).forEach(([f,als])=>{const k=als.find(a=>row[a]!==undefined&&row[a]!=='');if(k)out[f]=row[k];});return out;}
// Status normalization maps
const PROSP_STATUS_MAP={'keep in mind':'Keep in Mind','keep in mind':'Keep in Mind','loopnet lead':'First Touch','loopnet':'First Touch','first touch':'First Touch','second touch':'Second Touch','third touch':'Third Touch','warm':'Warm','not interested':'Not Interested','hot':'Warm'};
const DEAL_STATUS_MAP={'rfp / loi':'Proposal/LOI','rFP/LOI':'Proposal/LOI','rfp/loi':'Proposal/LOI','negotiations':'Negotiating','negotiating lease':'Negotiating','negotiating':'Negotiating','proposal/loi':'Proposal/LOI','proposal':'Proposal/LOI','loi':'Proposal/LOI','touring':'Touring','first touch':'First Touch','site selection':'Site Selection','leased':'Leased/Purchased','leased/purchased':'Leased/Purchased','closed':'Leased/Purchased'};
function normalizeStatus(raw,map){if(!raw)return null;const k=raw.toLowerCase().trim();return map[k]||null;}
function importCSV(type,rows){pushUndo('Import '+type);const maps=type==='deals'?DMAPS:type==='prospects'?PMAPS:CMAPS;const col=type==='deals'?'deals':type==='prospects'?'prospects':'comps';const added=rows.map(r=>{const m=mapRow(r,maps);const base={id:uid(),createdAt:tod(),notes:[],activities:[]};
  if(col==='prospects'){
    base.lastTouched=m.lastTouched||tod();
    const ns=normalizeStatus(m.status,PROSP_STATUS_MAP);
    m.status=ns||m.status||'First Touch';
    // Handle notes field
    if(m.notes&&m.notes.trim()){const noteObj={id:uid(),text:m.notes.trim(),date:tod()};base.notes=[noteObj];}
    delete m.notes;
    // Fix Unknown contacts
    if(!m.contactName||m.contactName.toLowerCase()==='unknown')m.contactName='';
  }
  if(col==='deals'){
    const ns=normalizeStatus(m.status,DEAL_STATUS_MAP);
    m.status=ns||m.status||'First Touch';
    if(m.notes&&m.notes.trim()){const noteObj={id:uid(),text:m.notes.trim(),date:tod()};base.notes=[noteObj];}
    delete m.notes;
    // Clean size: remove commas
    if(m.size)m.size=m.size.replace(/,/g,'').replace(/\s*SF.*/i,'').trim();
    if(m.budget)m.budget=m.budget.replace(/[$,\s]/g,'').trim();
  }
  if(col==='comps'){
    // Clean PSF: remove $
    if(m.askingPsf)m.askingPsf=m.askingPsf.replace(/[$,\s]/g,'').trim();
    if(m.size)m.size=m.size.replace(/,/g,'').trim();
    if(m.totalSf)m.totalSf=m.totalSf.replace(/,/g,'').trim();
    // Skip rows with no address and no PSF
    if(!m.address&&!m.askingPsf)return null;
  }
  return{...base,...m};}).filter(Boolean);
state[col]=[...state[col],...added];saveState();toast('Imported '+added.length+' '+col);render();}
function exportCSV(rows,fn){if(!rows||!rows.length){toast('Nothing to export');return;}const skip=['notes','activities','id'];const keys=Object.keys(rows[0]).filter(k=>!skip.includes(k));const csv=[keys.join(','),...rows.map(r=>keys.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','))].join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=fn;a.click();}

// ‚ïê‚ïê‚ïê FULL BACKUP ‚ïê‚ïê‚ïê
function exportBackup(){
  const backup={version:'v8',exportedAt:new Date().toISOString(),state};
  const json=JSON.stringify(backup,null,2);
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([json],{type:'application/json'}));
  a.download='db-crm-backup-'+tod()+'.json';
  a.click();
  toast('‚úÖ Full backup downloaded ‚Äî keep this file safe!',4000);
}
function importBackup(){const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const file=e.target.files?.[0];if(!file)return;const r=new FileReader();r.onload=ev=>{try{const bk=JSON.parse(ev.target.result);if(!bk.state){toast('Invalid backup file');return;}if(!confirm('This will REPLACE all current data with the backup. Continue?'))return;pushUndo('Import backup');state={...defState(),...bk.state};saveState();render();toast('‚úÖ Backup restored: '+file.name,4000);}catch(err){toast('Error reading backup file');}};r.readAsText(file);};inp.click();}

// ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê
const NAV=[
  {id:'dashboard',icon:'‚¨°',label:'Command Center'},
  {id:'search',icon:'üîç',label:'Global Search'},
  {id:'deals',icon:'‚óá',label:'Deal Tracker'},
  {id:'kanban-deals',icon:'‚äû',label:'Deal Pipeline'},
  {id:'closed',icon:'‚ú¶',label:'Closed Deals'},
  {id:'kanban-leads',icon:'‚äü',label:'Leads Pipeline'},
  {id:'prospects',icon:'‚óé',label:'Prospects'},
  {id:'referrals',icon:'‚Üî',label:'Referrals'},
  {id:'market',icon:'‚äï',label:'Market Intel'},
  {id:'evaluator',icon:'‚öñ',label:'Deal Evaluator'},
  {id:'calendar',icon:'‚ó∑',label:'Calendar'},
  {id:'templates',icon:'‚úâ',label:'Templates'},
  {id:'expirations',icon:'‚ö†',label:'Expirations'},
  {id:'activity',icon:'‚ñ∏',label:'Activity Log'},
  {id:'trash',icon:'‚äò',label:'Trash (180d)'},
];
function renderNav(){const expCnt=[...state.deals,...state.prospects].filter(d=>{const dy=daysUntil(d.leaseExpiration||d.leaseExp);return dy!=null&&dy<=180&&dy>=0;}).length;const trashCnt=state.trash.length;q('nav').innerHTML=NAV.map(n=>{const badge=n.id==='expirations'&&expCnt>0?`<span class="badge">${expCnt}</span>`:n.id==='trash'&&trashCnt>0?`<span class="badge" style="background:#4a5568">${trashCnt}</span>`:'';return`<div class="nav-item${currentView===n.id?' active':''}" onclick="setView('${n.id}')"><span class="ni">${n.icon}</span><span>${n.label}</span>${badge}</div>`;}).join('');}
function setView(v){
  const changed=currentView!==v;
  currentView=v;
  const pt=q('page-title');if(pt)pt.textContent=NAV.find(n=>n.id===v)?.label||v;
  if(changed){q('search-box').value='';const c=q('content');if(c)c.scrollTop=0;}
  renderNav();renderContent();
}
function render(){renderNav();renderContent();}
function onSearchInput(){const s=srch().trim();if(s.length>=1&&currentView!=='search'){setView('search');}else if(s.length===0&&currentView==='search'){setView('dashboard');}else{renderContent();}}
function renderContent(){const c=q('content');if(!c)return;
  // Preserve scroll position so clicks don't jump to top
  const scrollEl=c;// #content is the scrollable container
  const scrollY=scrollEl.scrollTop;
  switch(currentView){
  case'dashboard':c.innerHTML=renderDashboard();setTimeout(drawCommChart,50);break;
  case'search':c.innerHTML=renderGlobalSearch();break;
  case'deals':c.innerHTML=renderDeals();break;
  case'kanban-deals':c.innerHTML=renderKanban(state.deals.filter(d=>d.status!=='Leased/Purchased'),ACTIVE_ST,'deal');break;
  case'closed':c.innerHTML=renderClosed();break;
  case'prospects':c.innerHTML=renderProspects();break;
  case'kanban-leads':c.innerHTML=renderKanban(state.prospects,PROSP_ST,'prospect');break;
  case'referrals':c.innerHTML=renderReferrals();break;
  case'market':c.innerHTML=renderMarket();break;
  case'evaluator':c.innerHTML=renderEvaluator();break;
  case'calendar':c.innerHTML=renderCalendar();break;
  case'templates':c.innerHTML=renderTemplates();break;
  case'expirations':c.innerHTML=renderExpirations();break;
  case'activity':c.innerHTML=renderActivity();break;
  case'trash':c.innerHTML=renderTrash();break;
  default:c.innerHTML=renderDashboard();setTimeout(drawCommChart,50);
}
  // Restore scroll after re-render
  requestAnimationFrame(()=>{scrollEl.scrollTop=scrollY;});
}


// ‚ïê‚ïê‚ïê GLOBAL SEARCH ‚ïê‚ïê‚ïê
function renderGlobalSearch(){
  const src=srch().toLowerCase().trim();
  if(!src)return nilHtml('Type in the search bar above to search the entire CRM');
  const hits=[];
  // Deals
  state.deals.filter(d=>[d.tenantName,d.companyName,d.contactName,d.contactPhone,d.contactEmail,d.location,d.currentAddress,d.size,d.status,d.requirements,d.landlord,d.submarket].join(' ').toLowerCase().includes(src)).forEach(d=>hits.push({type:'deal',label:d.tenantName||d.companyName||'‚Äî',sub:d.location||d.contactName||'‚Äî',status:d.status,id:d.id}));
  // Prospects
  state.prospects.filter(p=>[p.companyName,p.contactName,p.phone,p.email,p.companyAddress,p.source,p.status].join(' ').toLowerCase().includes(src)).forEach(p=>hits.push({type:'prospect',label:p.companyName||'‚Äî',sub:(p.contactName&&p.contactName!=='Unknown'?p.contactName+' ¬∑ ':'')+( p.phone||p.email||''),status:p.status,id:p.id}));
  // Calendar
  state.calendar.filter(e=>[e.title,e.type,e.date].join(' ').toLowerCase().includes(src)).forEach(e=>hits.push({type:'event',label:e.title||'‚Äî',sub:fmt(e.date)+' ¬∑ '+(e.type||''),status:e.done?'Done':'Upcoming',id:e.id}));
  // Comps
  state.comps.filter(c=>[c.address,c.submarket,c.landlord,c.notes,c.city].join(' ').toLowerCase().includes(src)).forEach(c=>hits.push({type:'comp',label:c.address||'‚Äî',sub:(c.submarket||'')+(c.askingPsf?' ¬∑ $'+c.askingPsf+'/SF':''),status:'',id:c.id}));
  // Activities
  state.activities.filter(a=>{const ent=state.deals.find(d=>d.id===a.entityId)||state.prospects.find(p=>p.id===a.entityId);return [a.note,a.type,ent?.tenantName,ent?.companyName].join(' ').toLowerCase().includes(src);}).slice(0,10).forEach(a=>{const ent=state.deals.find(d=>d.id===a.entityId)||state.prospects.find(p=>p.id===a.entityId);hits.push({type:'activity',label:a.note||'‚Äî',sub:(ent?.tenantName||ent?.companyName||'‚Äî')+' ¬∑ '+a.type+' ¬∑ '+a.date,status:'',id:a.id});});
  // Closed
  // (already in deals)
  const typeColors={deal:'var(--accent)',prospect:'var(--green)',event:'var(--yellow)',comp:'var(--purple)',activity:'var(--text3)'};
  const typeIcons={deal:'‚óá',prospect:'‚óé',event:'‚ó∑',comp:'‚äï',activity:'‚ñ∏'};
  return`<div>
    <div style="font-weight:800;color:var(--text);font-size:18px;margin-bottom:4px">Search Results</div>
    <div style="font-size:12px;color:var(--text3);margin-bottom:14px">${hits.length} result${hits.length!==1?'s':''} for "<strong style="color:var(--text)">${esc(src)}</strong>" across deals, prospects, calendar, comps, activities</div>
    ${hits.length===0?nilHtml('No matches found'):''}
    ${hits.map(h=>`<div class="item-card card" style="display:flex;gap:12px;align-items:center;cursor:pointer" onclick="searchJump('${h.type}','${h.id}')">
      <div style="width:32px;height:32px;background:${typeColors[h.type]}22;border:1px solid ${typeColors[h.type]}44;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;color:${typeColors[h.type]}">${typeIcons[h.type]}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:700;color:var(--text);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(h.label)}</div>
        <div style="font-size:10px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(h.sub)}</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        ${h.status?`<span style="font-size:9px;color:var(--text3);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 7px;white-space:nowrap">${esc(h.status)}</span>`:''}
        <span style="font-size:10px;color:${typeColors[h.type]};font-weight:700;letter-spacing:.06em;text-transform:uppercase">${h.type}</span>
      </div>
    </div>`).join('')}
  </div>`;
}
function searchJump(type,id){
  if(type==='deal'){selectedDeal=state.deals.find(d=>d.id===id);setView('deals');}
  else if(type==='prospect'){selectedProspect=state.prospects.find(p=>p.id===id);setView('prospects');}
  else if(type==='event'){setView('calendar');}
  else if(type==='comp'){setView('market');}
  else if(type==='activity'){setView('activity');}
  q('search-box').value='';
}

// ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê
function renderDashboard(){
  const active=state.deals.filter(d=>d.status!=='Leased/Purchased'&&d.status!=='Lost');
  const closed=state.deals.filter(d=>d.status==='Leased/Purchased');
  let tg=0,ts=0,tt=0,tax=0;
  closed.forEach(d=>{const c=calcComm(d);tg+=c.gross;ts+=c.split;tt+=c.take;tax+=c.afterTax;});
  let activeTotalValue=0,activePotComm=0;
  active.forEach(d=>{const c=calcComm(d);activeTotalValue+=c.total||0;activePotComm+=c.gross||0;});
  const urgent=[...state.deals,...state.prospects].filter(d=>{const dy=daysUntil(d.leaseExpiration||d.leaseExp);return dy!=null&&dy<=90&&dy>=0;});
  const stale=state.prospects.filter(p=>daysSince(p.lastTouched)>14&&p.status!=='Not Interested');
  const pipe={};CLIENT_ST.forEach(s=>pipe[s]=state.deals.filter(d=>d.status===s).length);
  const upcoming=state.calendar.filter(e=>e.date>=tod()).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,6);
  const do_=settings.dashOrder||dashOrder;

  const widgets={
    pipeline:`<div class="pipeline-strip card" draggable="true" ondragstart="dashDragStart('pipeline')" ondragover="event.preventDefault()" ondrop="dashDrop('pipeline',event)">
      <div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="font-size:9px;color:var(--text3);letter-spacing:.15em;text-transform:uppercase;font-weight:700">Deal Pipeline</span><span class="drag-handle">‚†ø</span></div>
      <div style="display:flex;gap:6px">${CLIENT_ST.map(s=>{const cc=stColor(s);const n=pipe[s]||0;return`<div style="flex:1;text-align:center;background:${n>0?cc.bg:'var(--surface2)'};border:1px solid ${n>0?cc.border:'var(--border)'};border-radius:6px;padding:10px 4px"><div style="font-size:20px;font-weight:800;color:${n>0?cc.text:'var(--text3)'};font-family:'DM Mono',monospace">${n}</div><div style="font-size:8px;color:${n>0?cc.text:'var(--text3)'};margin-top:2px;text-transform:uppercase;letter-spacing:.04em;line-height:1.3">${s}</div></div>`;}).join('')}</div>
    </div>`,
    urgent:`<div class="dash-card card" draggable="true" ondragstart="dashDragStart('urgent')" ondragover="event.preventDefault()" ondrop="dashDrop('urgent',event)">
      <div class="dash-hdr">‚ö† Expiring &lt;90 Days<span class="drag-handle">‚†ø</span><button class="btn xs ghost" onclick="setView('expirations')">All ‚Üí</button></div>
      ${urgent.length===0?nilHtml('None in 90-day window'):urgent.slice(0,5).map(d=>{const dy=daysUntil(d.leaseExpiration||d.leaseExp);return`<div class="dash-row"><span style="color:var(--text)">${esc(d.tenantName||d.companyName||'‚Äî')}</span><span class="${dy<=30?'blink':''}" style="font-weight:800;color:${dy<=30?'var(--red)':dy<=60?'var(--orange)':'var(--yellow)'};font-family:monospace">${dy}d</span></div>`;}).join('')}
    </div>`,
    priority:`<div class="dash-card card" draggable="true" ondragstart="dashDragStart('priority')" ondragover="event.preventDefault()" ondrop="dashDrop('priority',event)">
      <div class="dash-hdr">üî• High Priority<span class="drag-handle">‚†ø</span></div>
      ${state.prospects.filter(p=>p.priority==='High').length===0?nilHtml('None'):state.prospects.filter(p=>p.priority==='High').slice(0,5).map(p=>`<div class="dash-row"><span>${esc(p.companyName||'‚Äî')}</span>${sbadge(p.status)}</div>`).join('')}
    </div>`,
    stale:`<div class="dash-card card" draggable="true" ondragstart="dashDragStart('stale')" ondragover="event.preventDefault()" ondrop="dashDrop('stale',event)">
      <div class="dash-hdr">Stale 14d+<span class="drag-handle">‚†ø</span></div>
      ${stale.length===0?nilHtml('All recently touched ‚úì'):stale.slice(0,5).map(p=>{const ds=daysSince(p.lastTouched);return`<div class="dash-row"><span>${esc(p.companyName||'‚Äî')}</span><span class="blink" style="color:var(--red);font-weight:800;font-family:monospace">${ds}d</span></div>`;}).join('')}
    </div>`,
    upcoming:`<div class="dash-card card" draggable="true" ondragstart="dashDragStart('upcoming')" ondragover="event.preventDefault()" ondrop="dashDrop('upcoming',event)">
      <div class="dash-hdr">‚ó∑ Upcoming<span class="drag-handle">‚†ø</span><button class="btn xs ghost" onclick="setView('calendar')">All ‚Üí</button></div>
      ${upcoming.length===0?nilHtml('No upcoming events'):upcoming.map(e=>`<div class="dash-row"><span style="font-size:11px">${esc(e.title||'‚Äî')}</span><span style="font-size:10px;color:var(--text3)">${fmt(e.date)}</span></div>`).join('')}
    </div>`,
    active:`<div class="dash-card card" draggable="true" ondragstart="dashDragStart('active')" ondragover="event.preventDefault()" ondrop="dashDrop('active',event)">
      <div class="dash-hdr">Active Deals<span class="drag-handle">‚†ø</span></div>
      ${active.length===0?nilHtml('No active deals'):active.slice(0,6).map(d=>`<div class="dash-row"><span>${esc(d.tenantName||d.companyName||'‚Äî')}</span>${sbadge(d.status)}</div>`).join('')}
    </div>`,
    commission:`<div class="dash-card card" style="grid-column:span 3" draggable="true" ondragstart="dashDragStart('commission')" ondragover="event.preventDefault()" ondrop="dashDrop('commission',event)">
      <div class="dash-hdr">Commission Tracker<span class="drag-handle">‚†ø</span><div style="display:flex;gap:14px;font-size:10px;font-weight:400"><span style="color:var(--accent)">‚ñ† Gross</span><span style="color:var(--green)">‚ñ† Take-Home</span><span style="color:var(--purple)">‚ñ† After Tax (${settings.taxRate||30}%)</span></div></div>
      <div style="display:flex;gap:16px;margin-bottom:12px">
        ${[['Gross Comm',tg,'var(--accent)'],['Take-Home',tt,'var(--green)'],['After Tax',tax,'var(--purple)']].map(([l,v,col])=>`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 16px"><div style="font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;margin-bottom:3px">${l}</div><div style="font-size:20px;font-weight:800;color:${col};font-family:'DM Mono',monospace">${usd(v)}</div></div>`).join('')}
      </div>
      <canvas id="comm-chart-canvas" width="800" height="200" style="width:100%;height:200px;display:block"></canvas>
    </div>`
  };

  const rows=[do_.slice(0,1),do_.slice(1,4),do_.slice(4,7)];
  return`
  <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
    <div><div style="font-size:28px;font-weight:800;color:var(--text);letter-spacing:.04em;line-height:1">Command Center</div>
    <div style="font-size:12px;color:var(--text3);margin-top:2px">${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</div></div>
  </div>
  <div class="kpi-grid">
    ${[['Active Deals',active.length,'var(--accent)'],['Closed',closed.length,'var(--green)'],['Prospects',state.prospects.length,'var(--blue)'],['Pipeline Value',usd(activeTotalValue),'var(--blue)'],['Pot. Commission',usd(activePotComm),'var(--yellow)'],['Closed Gross',usd(tg),'var(--yellow)'],['Take-Home',usd(tt),'var(--green)'],['After Tax',usd(tax),'var(--purple)']].map(([l,v,c])=>`<div class="kpi-card card"><div class="kpi-lbl">${l}</div><div class="kpi-val" style="color:${c}">${v}</div></div>`).join('')}
  </div>
  ${widgets['pipeline']}
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
    ${(do_.filter(k=>k!=='pipeline'&&k!=='commission').slice(0,6)).map(k=>widgets[k]||'').join('')}
  </div>
  ${widgets['commission']}`;
}

let dashDragKey=null;
function dashDragStart(key){dashDragKey=key;}
function dashDrop(targetKey){
  if(!dashDragKey||dashDragKey===targetKey)return;
  const order=settings.dashOrder||[...dashOrder];
  const fi=order.indexOf(dashDragKey),ti=order.indexOf(targetKey);
  if(fi<0||ti<0)return;
  order.splice(fi,1);order.splice(ti,0,dashDragKey);
  settings.dashOrder=order;saveSettings();dashDragKey=null;renderContent();
}

// ‚ïê‚ïê‚ïê COMMISSION CHART ‚ïê‚ïê‚ïê
function drawCommChart(){
  const canvas=q('comm-chart-canvas');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  canvas.width=canvas.offsetWidth*dpr;canvas.height=200*dpr;
  ctx.scale(dpr,dpr);
  const W=canvas.offsetWidth,H=200;
  const isDark=settings.dark;
  const bgColor=isDark?'#0d0d0d':'#f8fafc';
  const gridColor=isDark?'rgba(255,255,255,.06)':'rgba(0,0,0,.06)';
  const textColor=isDark?'#888':'#8a96a8';
  ctx.fillStyle=bgColor;ctx.fillRect(0,0,W,H);

  const closed=state.deals.filter(d=>d.status==='Leased/Purchased').slice(-12);
  if(!closed.length){ctx.fillStyle=textColor;ctx.font='13px Barlow Condensed,sans-serif';ctx.textAlign='center';ctx.fillText('No closed deals yet ‚Äî commissions will appear here',W/2,H/2);return;}

  const pad={t:20,r:16,b:40,l:60};
  const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;
  const comms=closed.map(d=>{const c=calcComm(d);return{label:d.tenantName||d.companyName||'Deal',gross:c.gross,take:c.take,afterTax:c.afterTax};});
  const maxV=Math.max(...comms.map(c=>c.gross),1);
  const barW=Math.min(60,cW/comms.length*.6);
  const grpW=cW/comms.length;

  // Grid lines
  for(let i=0;i<=4;i++){const y=pad.t+cH*(1-i/4);ctx.strokeStyle=gridColor;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+cW,y);ctx.stroke();ctx.fillStyle=textColor;ctx.font='10px DM Mono,monospace';ctx.textAlign='right';ctx.fillText('$'+Math.round(maxV*i/4/1000)+'k',pad.l-4,y+3);}

  comms.forEach((c,i)=>{
    const x=pad.l+grpW*i+grpW/2;
    const bars=[{v:c.gross,col:isDark?'#3b82f6':'#1e6fbf'},{v:c.take,col:isDark?'#22c55e':'#16a34a'},{v:c.afterTax,col:isDark?'#a855f7':'#7c3aed'}];
    const totalW=barW*3+4;const startX=x-totalW/2;
    bars.forEach((b,bi)=>{
      const bh=cH*(b.v/maxV);const bx=startX+bi*(barW+2);const by=pad.t+cH-bh;
      ctx.fillStyle=b.col;
      ctx.beginPath();ctx.roundRect(bx,by,barW,bh,2);ctx.fill();
    });
    ctx.fillStyle=textColor;ctx.font='9px Barlow Condensed,sans-serif';ctx.textAlign='center';
    const lbl=(c.label||'').slice(0,10);ctx.fillText(lbl,x,pad.t+cH+14);
  });
}

// ‚ïê‚ïê‚ïê DEALS ‚ïê‚ïê‚ïê
function renderDeals(){
  const src=srch().toLowerCase();
  // Pipeline: NEVER show Leased/Purchased here ‚Äî those live in Closed Deals
  const deals=state.deals.filter(d=>{
    if(d.status==='Leased/Purchased')return false;
    const ms=!src||[d.tenantName,d.companyName,d.location,d.status,d.contactName].join(' ').toLowerCase().includes(src);
    return ms&&(dealFilter==='All'||d.status===dealFilter);
  });
  const deal=selectedDeal?state.deals.find(d=>d.id===selectedDeal.id):null;
  const massBar=dealSelMode&&dealSel.size>0?`<div class="mass-bar">
    <span style="font-size:12px;font-weight:600;color:var(--accent)">${dealSel.size} selected</span>
    <button class="btn xs ghost" onclick="selectAllDeals()">Select All (${deals.length})</button>
    <button class="btn sm danger" onclick="trashMany('deals',dealSel,'deals')">üóë Delete</button>
    <select id="deal-mv-sel" style="width:auto">${ACTIVE_ST.map(s=>`<option>${s}</option>`).join('')}</select>
    <button class="btn sm primary" onclick="moveManyDeals(q('deal-mv-sel').value)">Move to Status</button>
    <button class="btn sm success" onclick="moveManyDeals('Leased/Purchased')" style="background:var(--green);color:#fff;border-color:var(--green)">‚úÖ Mark Closed</button>
    <button class="btn xs ghost" onclick="dealSel=new Set();dealSelMode=false;renderContent()">Clear</button>
  </div>`:'';
  return`<div style="display:flex;gap:16px;height:calc(100vh - 110px)">
  <div style="width:${deal?'310px':'100%'};flex-shrink:0;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span style="font-weight:800;color:var(--text);font-size:16px">Deals <span style="color:var(--text3);font-size:13px;font-weight:400">(${deals.length})</span></span>
      <div style="display:flex;gap:6px">
        <button class="btn sm ghost" onclick="dealSelMode=!dealSelMode;dealSel=new Set();renderContent()">${dealSelMode?'Cancel':'‚òë Select'}</button>
        <button class="btn sm" onclick="csvImportClick('deals')">‚¨Ü CSV</button>
        <input type="file" id="csv-deals" accept=".csv" onchange="handleCSVFile(this,'deals')"/>
        <button class="btn sm primary" onclick="openModal('new-deal')">+ New</button>
      </div>
    </div>
    ${massBar}
    ${sfRow(['All',...ACTIVE_ST],dealFilter,'dealFilter')}
    ${deals.map(d=>{const c=calcComm(d);const cc=stColor(d.status);const isSel=dealSel.has(d.id);return`<div class="item-card${selectedDeal&&selectedDeal.id===d.id?' selected-card':''}${isSel?' checked':''} card" onclick="${dealSelMode?`toggleDealSel('${d.id}',event)`:`selectDeal('${d.id}')`}" style="border-left:3px solid ${cc.border}">
      <div style="display:flex;gap:8px">
        ${dealSelMode?`<input type="checkbox" class="cb" ${isSel?'checked':''} onchange="toggleDealSel('${d.id}',event)" onclick="event.stopPropagation()"/>`:''}
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span style="font-weight:800;color:var(--text);font-size:13px">${esc(d.tenantName||d.companyName||'Unnamed')}</span>
            ${sbadge(d.status)}
          </div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:3px">${esc(d.location||'‚Äî')} ${d.size?'¬∑ '+d.size+' SF':''}</div>
          ${c.take>0?`<div style="font-size:10px;color:var(--green);font-family:monospace">est take-home: ${usd(c.take)}</div>`:''}
          ${priDot(d.priority)}
        </div>
      </div>
    </div>`;}).join('')||nilHtml('No deals match')}
  </div>
  ${deal?dealDetailHTML(deal):''}
  </div>`;
}
function toggleDealSel(id,e){e.stopPropagation();if(dealSel.has(id))dealSel.delete(id);else dealSel.add(id);renderContent();}
function selectAllDeals(){const src=srch().toLowerCase();const visible=state.deals.filter(d=>{if(d.status==='Leased/Purchased')return false;const ms=!src||[d.tenantName,d.companyName,d.location,d.status,d.contactName].join(' ').toLowerCase().includes(src);return ms&&(dealFilter==='All'||d.status===dealFilter);});visible.forEach(d=>dealSel.add(d.id));renderContent();}
function selectDeal(id){selectedDeal=state.deals.find(d=>d.id===id);renderContent();}
function toggleClosedSel(id,e){e.stopPropagation();if(closedSel.has(id))closedSel.delete(id);else closedSel.add(id);renderContent();}
function selectAllClosed(subset){subset.forEach(d=>closedSel.add(d.id));renderContent();}
function deleteManyClosedDeals(){
  if(!closedSel.size)return;
  const count=closedSel.size;
  if(!confirm('Delete '+count+' selected deal'+(count!==1?'s':'')+' permanently? This goes to trash.'))return;
  pushUndo('Delete '+count+' closed deals');
  closedSel.forEach(id=>delDeal(id));
  closedSel=new Set();closedSelMode=false;
  renderContent();
}
function exportSelectedClosed(){
  const toExport=state.deals.filter(d=>closedSel.has(d.id));
  if(!toExport.length){toast('Nothing selected');return;}
  const cols=['tenantName','dealType','contactName','contactPhone','contactEmail','location','submarket','size','budget','leaseTerm','leaseStart','leaseEnd','closedDate','purchasePrice','capRate','landlord','commPct','manualGross','manualSplit','manualTakeHome','opEx','leaseStructure','dealNotes'];
  const rows=[cols.join(','),...toExport.map(d=>cols.map(k=>{const v=d[k]||'';return`"${String(v).replace(/"/g,'""')}"`;}).join(','))];
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='closed-selected-'+tod()+'.csv';a.click();
  toast('Exported '+toExport.length+' deals');
}
function reopenClosedDeal(id){
  pushUndo('Reopen deal');
  state.deals=state.deals.map(d=>d.id===id?{...d,status:'First Touch',updatedAt:tod()}:d);
  saveState();selectedClosed=null;
  toast('Deal moved back to Pipeline as "First Touch"');
  setView('deals');
}

function dealDetailHTML(deal){
  const c=calcComm(deal);const acts=state.activities.filter(a=>a.entityId===deal.id);const hasGDrive=deal.driveUrl&&deal.driveUrl.trim();
  return`<div class="detail-panel card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
      <div><div style="font-size:22px;font-weight:800;color:var(--text)">${esc(deal.tenantName||deal.companyName||'Unnamed')}</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Updated ${fmt(deal.updatedAt)}</div></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
        ${hasGDrive?`<a href="${esc(deal.driveUrl)}" target="_blank" class="btn sm success" style="text-decoration:none">üìÅ Drive</a>`:''}
        <button class="btn sm ghost" onclick="openModal('template-picker',{type:'deal',id:'${deal.id}'})">‚úâ Email</button>
        <button class="btn sm success" onclick="if(confirm('Mark this deal as closed? It will move to Closed Deals.')){updDeal('${deal.id}',{status:'Leased/Purchased'})}" style="background:var(--green);color:#fff;border-color:var(--green)">‚úÖ Close Deal</button>
        <button class="btn sm danger" onclick="delDeal('${deal.id}')">Delete</button>
        <button class="btn sm ghost" onclick="selectedDeal=null;renderContent()">‚úï</button>
      </div>
    </div>
    ${statusBtns(CLIENT_ST,deal.status,`updDeal('${deal.id}',{status:this.dataset.s})`)}
    ${commBlockHtml(c,deal)}
    ${expBarHtml(deal.leaseExpiration,deal.leaseStart)}
    <div class="drive-wrap">
      <span style="font-size:20px">üìÅ</span>
      <div style="flex:1"><div style="font-size:9px;color:var(--green);letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px;font-weight:700">Google Drive Folder</div>
        <input value="${esc(deal.driveUrl||'')}" placeholder="Paste Google Drive folder URL‚Ä¶" onchange="updDeal('${deal.id}',{driveUrl:this.value})"/>
        ${hasGDrive?`<a href="${esc(deal.driveUrl)}" target="_blank" style="font-size:11px;color:var(--green);margin-top:4px;display:block">‚Üó Open folder in Google Drive</a>`:''}
      </div>
    </div>
    ${section('Deal Information',dealFieldsHtml(deal))}
    ${section('Log Activity',logActHtml('deal',deal.id))}
    ${section('Notes',notesHtml(deal,'deal'))}
    ${section('Activity History',actHistHtml(acts))}
    ${section('Add Reminder',quickEvHtml(deal.tenantName||deal.companyName))}
  </div>`;
}
function dealFieldsHtml(d){const fields=[['Tenant/Company','tenantName','text'],['Contact Name','contactName','text'],['Phone','contactPhone','text'],['Email','contactEmail','text'],['Current Address','currentAddress','text'],['Target Location','location','text'],['Size (SF)','size','text'],['Budget / Rate PSF','budget','text'],['Lease Term (years)','leaseTerm','text'],['Annual Escalation (%)','annualEscalation','text'],['Commission %','commPct','text'],['Lease Expiration','leaseExpiration','date'],['Lease Start','leaseStart','date'],['Lease End','leaseEnd','date'],['Requirements','requirements','text'],['Op Ex ($/SF/yr)','opEx','text'],['NNN vs Gross','leaseStructure','text']];return`<div class="form-grid">${fields.map(([l,k,t])=>`<div class="field"><label>${l}</label><input type="${t}" value="${esc(d[k]||'')}" onchange="updDeal('${d.id}',{${k}:this.value})"/></div>`).join('')}<div class="field"><label>Deal Type</label><select onchange="updDeal('${d.id}',{dealIntent:this.value})"><option${(!d.dealIntent||d.dealIntent==='Leasing')?' selected':''} value="Leasing">üìÑ Leasing</option><option${d.dealIntent==='Buying'?' selected':''} value="Buying">üè¢ Buying / Purchase</option></select></div><div class="field"><label>Priority</label><select onchange="updDeal('${d.id}',{priority:this.value})">${['High','Medium','Low'].map(o=>`<option${d.priority===o?' selected':''}>${o}</option>`).join('')}</select></div></div>`;}

// ‚ïê‚ïê‚ïê CLOSED DEALS ‚ïê‚ïê‚ïê
const CLOSED_MAPS={tenantName:['tenantname','company','companyname','tenant','client'],dealType:['dealtype','type','transactiontype','status'],contactName:['contactname','contact','name'],contactPhone:['contactphone','phone'],contactEmail:['contactemail','email'],location:['location','address','property','propertyaddress','building'],submarket:['submarket','area','neighborhood'],size:['size','sf','squarefeet','sqft','square_footage','squarefootage'],budget:['budget','costpsf','psf','rate','rentpsf','total_deal_value_psf','totaldealvaluepsf'],leaseTerm:['leaseterm','term','term_length','termlength'],leaseStart:['leasestart','start','commencement_date','commencementdate','commecement_date','commecementdate'],leaseEnd:['leaseend','end','expirationdate','expiration_date'],closedDate:['closeddate','closedate','date'],purchasePrice:['purchaseprice','price','saleprice'],capRate:['caprate','cap'],landlord:['landlord','owner','seller'],commPct:['commpct','commission','pct'],manualGross:['manualgross','gross','grosscomm','grosscommission','total_comission','totalcomission'],manualSplit:['manualsplit','split','aftersplit','after_split'],manualTakeHome:['manualtakehome','takehome','take','after_taxes','aftertaxes'],driveUrl:['driveurl','drive'],dealNotes:['notes','note','comments'],annualEscalation:['annualescalation','escalation','annual_escalation','esc','annualesc']};
function normalizeDeal(d){
  // Merge all known field aliases into canonical keys so editing always works
  const out={...d};
  // Company/Tenant
  if(!out.tenantName&&out.companyName)out.tenantName=out.companyName;
  if(!out.tenantName&&out.company)out.tenantName=out.company;
  if(!out.tenantName&&out.client)out.tenantName=out.client;
  // Contact
  if(!out.contactPhone&&out.phone)out.contactPhone=out.phone;
  if(!out.contactEmail&&out.email)out.contactEmail=out.email;
  if(!out.contactName&&out.name&&!out.tenantName)out.contactName=out.name;
  // Location/Address
  if(!out.location&&out.address)out.location=out.address;
  if(!out.location&&out.property)out.location=out.property;
  if(!out.location&&out.propertyAddress)out.location=out.propertyAddress;
  // Size
  if(!out.size&&out.sf)out.size=out.sf;
  if(!out.size&&out.squareFeet)out.size=out.squareFeet;
  if(!out.size&&out.sqft)out.size=out.sqft;
  // Rate/Budget
  if(!out.budget&&out.costPsf)out.budget=out.costPsf;
  if(!out.budget&&out.psf)out.budget=out.psf;
  if(!out.budget&&out.rate)out.budget=out.rate;
  if(!out.budget&&out.rentPsf)out.budget=out.rentPsf;
  // Dates
  if(!out.leaseStart&&out.commencement)out.leaseStart=out.commencement;
  if(!out.leaseEnd&&out.expiration)out.leaseEnd=out.expiration;
  if(!out.leaseEnd&&out.leaseExpiration)out.leaseEnd=out.leaseExpiration;
  // Commission
  if(!out.commPct&&out.commission)out.commPct=out.commission;
  if(!out.commPct&&out.pct)out.commPct=out.pct;
  // Manual commission overrides
  if(!out.manualGross&&out.gross)out.manualGross=out.gross;
  if(!out.manualGross&&out.grossComm)out.manualGross=out.grossComm;
  if(!out.manualSplit&&out.split)out.manualSplit=out.split;
  if(!out.manualSplit&&out.afterSplit)out.manualSplit=out.afterSplit;
  if(!out.manualTakeHome&&out.takeHome)out.manualTakeHome=out.takeHome;
  if(!out.manualTakeHome&&out.take)out.manualTakeHome=out.take;
  // Landlord/Seller
  if(!out.landlord&&out.owner)out.landlord=out.owner;
  if(!out.landlord&&out.seller)out.landlord=out.seller;
  // Notes
  if(!out.dealNotes&&out.notes&&typeof out.notes==='string')out.dealNotes=out.notes;
  // Deal type normalization
  if(out.dealType){
    const dt=String(out.dealType).toLowerCase().trim();
    if(dt==='purchase'||dt==='sale'||dt==='buying'||dt==='buy')out.dealType='Purchase';
    else out.dealType='Lease';
  } else {
    out.dealType='Lease';
  }
  return out;
}
function repairDeal(id){
  pushUndo('Repair deal fields');
  state.deals=state.deals.map(d=>d.id===id?normalizeDeal(d):d);
  saveState();renderContent();
  toast('‚úÖ Deal fields repaired and normalized');
}
function importClosed(rows){
  pushUndo('Import closed deals');
  const added=rows.map(r=>{
    const m=mapRow(r,CLOSED_MAPS);
    return normalizeDeal({...m,id:uid(),status:'Leased/Purchased',createdAt:tod(),updatedAt:tod(),notes:[],activities:[]});
  });
  state.deals=[...state.deals,...added];
  saveState();
  toast('Imported '+added.length+' closed deals');
  render();
}

function renderClosed(){
  const src=srch().toLowerCase();
  const allClosed=state.deals.filter(d=>d.status==='Leased/Purchased');
  const filtered=allClosed.filter(d=>{
    const ms=!src||[d.tenantName,d.companyName,d.location,d.contactName,d.dealType,d.submarket,d.landlord].join(' ').toLowerCase().includes(src);
    return ms&&(closedFilter==='All'||d.dealType===closedFilter||(closedFilter==='Lease'&&!d.dealType));
  }).sort((a,b)=>new Date(b.closedDate||b.createdAt||0)-new Date(a.closedDate||a.createdAt||0));
  const deal=selectedClosed?state.deals.find(d=>d.id===selectedClosed):null;
  const leaseCount=allClosed.filter(d=>!d.dealType||d.dealType==='Lease').length;
  const purchaseCount=allClosed.filter(d=>d.dealType==='Purchase').length;
  let totalGross=0,totalTake=0;
  allClosed.forEach(d=>{const c=calcComm(d);totalGross+=d.manualGross?num(d.manualGross):c.gross;totalTake+=d.manualTakeHome?num(d.manualTakeHome):c.take;});
  const leases=filtered.filter(d=>!d.dealType||d.dealType==='Lease');
  const purchases=filtered.filter(d=>d.dealType==='Purchase');
  const showBoth=closedFilter==='All';
  return`<div style="display:flex;gap:16px;height:calc(100vh - 110px)">
  <div style="width:${deal?'340px':'100%'};flex-shrink:0;overflow-y:auto">

    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
      <div>
        <div style="font-weight:800;color:var(--text);font-size:20px">üèÜ Closed Deals</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px">
          üìÑ ${leaseCount} Leases &nbsp;¬∑&nbsp; üè¢ ${purchaseCount} Purchases &nbsp;¬∑&nbsp;
          <span style="color:var(--yellow)">Gross ${usd(totalGross)}</span> &nbsp;¬∑&nbsp;
          <span style="color:var(--green)">Take-Home ${usd(totalTake)}</span>
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn sm ghost" onclick="closedSelMode=!closedSelMode;closedSel=new Set();renderContent()">${closedSelMode?'Cancel':'‚òë Select'}</button>
        <button class="btn sm ghost" onclick="exportClosedCSV()" title="Export all closed deals to CSV">‚¨á Export</button>
        <button class="btn sm" onclick="csvImportClick('closed')" title="Import from CSV file">‚¨Ü Import CSV</button>
        <input type="file" id="csv-closed" accept=".csv" onchange="handleCSVFile(this,'closed')" style="display:none"/>
        <button class="btn sm primary" onclick="openModal('new-closed')">Ôºã Add Deal</button>
      </div>
    </div>
    ${closedSelMode&&closedSel.size>0?`<div class="mass-bar">
      <span style="font-size:12px;font-weight:600;color:var(--accent)">${closedSel.size} selected</span>
      <button class="btn xs ghost" onclick="selectAllClosed(filtered)">Select All (${filtered.length})</button>
      <button class="btn xs ghost" onclick="selectAllClosed(leases)">All Leases (${leases.length})</button>
      <button class="btn xs ghost" onclick="selectAllClosed(purchases)">All Purchases (${purchases.length})</button>
      <button class="btn sm ghost" onclick="exportSelectedClosed()">‚¨á Export Selected</button>
      <button class="btn sm danger" onclick="deleteManyClosedDeals()">üóë Delete Selected</button>
      <button class="btn xs ghost" onclick="closedSel=new Set();renderContent()">Clear</button>
    </div>`:''}

    <!-- Filter tabs -->
    <div style="display:flex;gap:6px;margin-bottom:14px">
      ${['All','Lease','Purchase'].map(f=>{const isA=closedFilter===f;return`<button style="padding:6px 16px;border-radius:20px;border:1.5px solid ${isA?'var(--accent-border)':'var(--border)'};background:${isA?'var(--accent-bg)':'var(--surface2)'};color:${isA?'var(--accent)':'var(--text3)'};font-size:12px;font-weight:700;cursor:pointer" onclick="closedFilter='${f}';renderContent()">${f==='Lease'?'üìÑ Leases':f==='Purchase'?'üè¢ Purchases':'All'}</button>`;}).join('')}
    </div>

    <!-- CSV hint + Repair All -->
    <div style="background:var(--surface2);border:1px dashed var(--border);border-radius:var(--radius);padding:8px 12px;margin-bottom:8px;font-size:10px;color:var(--text3)">
      <b style="color:var(--text2)">CSV Import columns:</b> tenantName, dealType (Lease/Purchase), location, size, closedDate, leaseStart, leaseEnd, leaseTerm, budget (PSF), commPct, landlord, purchasePrice, capRate, contactName, contactPhone, contactEmail, gross, split, takehome, notes
    </div>
    ${allClosed.some(d=>!d.tenantName&&(d.companyName||d.company||d.client))?`<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:var(--radius);padding:8px 12px;margin-bottom:8px;font-size:10px;display:flex;align-items:center;justify-content:space-between">
      <span style="color:#92400e">‚ö†Ô∏è Some imported deals may have blank fields due to column naming differences.</span>
      <button class="btn xs" style="background:#f59e0b;color:#fff;border-color:#f59e0b" onclick="pushUndo('Repair all closed deals');state.deals=state.deals.map(d=>d.status==='Leased/Purchased'?normalizeDeal(d):d);saveState();renderContent();toast('‚úÖ All closed deals repaired!')">üîß Fix All</button>
    </div>`:''}  

    ${showBoth||closedFilter==='Lease'?`
    <!-- LEASES section -->
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div style="width:3px;height:18px;background:var(--blue);border-radius:2px"></div>
        <div style="font-size:13px;font-weight:800;color:var(--blue);letter-spacing:.04em">LEASES</div>
        <div style="font-size:10px;color:var(--text3)">${leases.length} deal${leases.length!==1?'s':''}</div>
      </div>
      ${leases.length?leases.map(d=>closedCardHTML(d)).join(''):`<div style="font-size:12px;color:var(--text3);padding:14px;text-align:center;background:var(--surface2);border-radius:var(--radius)">No leases yet ‚Äî add one above.</div>`}
    </div>`:''}

    ${showBoth||closedFilter==='Purchase'?`
    <!-- PURCHASES section -->
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div style="width:3px;height:18px;background:var(--purple);border-radius:2px"></div>
        <div style="font-size:13px;font-weight:800;color:var(--purple);letter-spacing:.04em">PURCHASES / SALES</div>
        <div style="font-size:10px;color:var(--text3)">${purchases.length} deal${purchases.length!==1?'s':''}</div>
      </div>
      ${purchases.length?purchases.map(d=>closedCardHTML(d)).join(''):`<div style="font-size:12px;color:var(--text3);padding:14px;text-align:center;background:var(--surface2);border-radius:var(--radius)">No purchases yet ‚Äî add one above.</div>`}
    </div>`:''}

    ${!showBoth&&filtered.length===0?`<div style="font-size:12px;color:var(--text3);padding:20px;text-align:center;background:var(--surface2);border-radius:var(--radius)">No ${closedFilter.toLowerCase()} deals found.</div>`:''}
  </div>
  ${deal?closedDetailHTML(deal):''}
  </div>`;
}

function closedCardHTML(d){
  const isLease=(!d.dealType||d.dealType==='Lease');
  const dl=daysUntil(d.leaseEnd);const urg=dl!=null&&dl<=180;
  const c=calcComm(d);
  const dispTake=d.manualTakeHome?num(d.manualTakeHome):c.take;
  const dispGross=d.manualGross?num(d.manualGross):c.gross;
  const typeBorder=isLease?'var(--blue-border)':'var(--purple-border)';
  const isSelected=selectedClosed===d.id;
  const isChecked=closedSel.has(d.id);
  return`<div class="item-card${isSelected?' selected-card':''}${isChecked?' checked':''} card" style="border-left:4px solid ${typeBorder};margin-bottom:8px;cursor:pointer" onclick="${closedSelMode?`toggleClosedSel('${d.id}',event)`:`selectedClosed='${d.id}';renderContent()`}">
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:flex-start">
      ${closedSelMode?`<input type="checkbox" class="cb" ${isChecked?'checked':''} onchange="toggleClosedSel('${d.id}',event)" onclick="event.stopPropagation()" style="margin-top:2px;flex-shrink:0"/>`:''}
      <div style="flex:1;min-width:0">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap">
          <span style="font-weight:800;color:var(--text);font-size:14px">${esc(d.tenantName||d.companyName||'Unnamed')}</span>
          ${d.closedDate?`<span style="font-size:9px;color:var(--text3)">Closed ${fmt(d.closedDate)}</span>`:''}
        </div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:3px">${esc(d.location||'‚Äî')}${d.submarket?` <span style="color:var(--text3)">¬∑ ${esc(d.submarket)}</span>`:''}</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px">
          ${d.size?`<span style="font-size:10px;color:var(--text3)">üìê ${d.size} SF</span>`:''}
          ${isLease&&d.budget?`<span style="font-size:10px;color:var(--text3)">$${d.budget}/SF</span>`:''}
          ${isLease&&d.leaseTerm?`<span style="font-size:10px;color:var(--text3)">‚è± ${d.leaseTerm} yr</span>`:''}
          ${!isLease&&d.purchasePrice?`<span style="font-size:10px;color:var(--text3)">üí≤ ${usd(num(d.purchasePrice))}</span>`:''}
          ${d.landlord?`<span style="font-size:10px;color:var(--text3)">${isLease?'LL':'Seller'}: ${esc(d.landlord)}</span>`:''}
        </div>
        ${dispTake>0||dispGross>0?`<div style="display:flex;gap:10px;margin-top:6px;padding-top:6px;border-top:1px solid var(--border)">
          ${dispGross?`<span style="font-size:10px;color:var(--yellow);font-weight:700">Gross: ${usd(dispGross)}</span>`:''}
          ${dispTake?`<span style="font-size:10px;color:var(--green);font-weight:700">Take-Home: ${usd(dispTake)}</span>`:''}
          ${d.manualGross||d.manualTakeHome?`<span style="font-size:9px;color:var(--accent)">‚ö° manual</span>`:''}
        </div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;margin-left:4px;flex-shrink:0">
        ${isLease&&dl!=null?`<span class="${urg?'blink':''}" style="font-family:'DM Mono',monospace;font-size:12px;font-weight:800;color:${dl<=90?'var(--red)':dl<=180?'var(--orange)':'var(--green)'}" title="Days until lease expires">${dl>=0?dl+'d':'EXP'}</span>`:''}
        <button class="btn xs ghost" onclick="event.stopPropagation();reopenClosedDeal('${d.id}')" title="Move back to active pipeline" style="font-size:9px">‚Ü© Reopen</button>
        <button class="btn xs danger" onclick="event.stopPropagation();if(confirm('Delete this deal?')){delDeal('${d.id}');if(selectedClosed==='${d.id}'){selectedClosed=null;}renderContent();}" title="Delete">üóë</button>
        <button class="btn xs ghost" onclick="event.stopPropagation();selectedClosed='${d.id}';renderContent();" title="Edit">‚úé</button>
      </div>
    </div>
  </div>`;
}

function exportClosedCSV(){
  const closed=state.deals.filter(d=>d.status==='Leased/Purchased');
  if(!closed.length){toast('No closed deals to export');return;}
  const cols=['tenantName','dealType','contactName','contactPhone','contactEmail','location','submarket','size','budget','leaseTerm','leaseStart','leaseEnd','closedDate','purchasePrice','capRate','landlord','commPct','manualGross','manualSplit','manualTakeHome','driveUrl','dealNotes'];
  const rows=[cols.join(','),...closed.map(d=>cols.map(k=>{const v=d[k]||'';return`"${String(v).replace(/"/g,'""')}"`;}).join(','))];
  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='closed-deals-'+tod()+'.csv';a.click();
  toast('Exported '+closed.length+' closed deals');
}

function closedDetailHTML(deal){
  const isLease=(!deal.dealType||deal.dealType==='Lease');
  const dl=daysUntil(deal.leaseEnd);
  const tot=deal.leaseStart&&deal.leaseEnd?Math.ceil((new Date(deal.leaseEnd+'T12:00:00')-new Date(deal.leaseStart+'T12:00:00'))/86400000):null;
  const pct=tot&&dl!=null?Math.max(0,Math.min(100,(dl/tot)*100)):null;
  const c=calcComm(deal);
  const dispGross=deal.manualGross?num(deal.manualGross):c.gross;
  const dispSplit=deal.manualSplit?num(deal.manualSplit):c.split;
  const dispTake=deal.manualTakeHome?num(deal.manualTakeHome):c.take;
  const dispAfterTax=dispTake*(1-(num(settings.taxRate||30)/100));
  const typeColor=isLease?'var(--blue)':'var(--purple)';
  const typeBg=isLease?'var(--blue-bg)':'var(--purple-bg)';
  const typeBorder=isLease?'var(--blue-border)':'var(--purple-border)';
  const FU=[{l:'18 MO',d:548},{l:'12 MO',d:365},{l:'6 MO',d:180},{l:'3 MO',d:90}];
  return`<div class="detail-panel card" style="flex:1;overflow-y:auto;min-width:0">

    <!-- Top bar -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;gap:10px">
      <div style="min-width:0;flex:1">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:4px">
          <span style="font-size:22px;font-weight:800;color:var(--text);word-break:break-word">${esc(deal.tenantName||deal.companyName||'Unnamed')}</span>
          <span style="background:${typeBg};color:${typeColor};border:1.5px solid ${typeBorder};border-radius:4px;font-size:9px;font-weight:800;padding:3px 9px;letter-spacing:.08em;white-space:nowrap">${isLease?'üìÑ LEASE':'üè¢ PURCHASE'}</span>
        </div>
        <div style="font-size:11px;color:var(--text3)">${esc(deal.location||'')}${deal.submarket?' ¬∑ '+esc(deal.submarket):''}${deal.size?' ¬∑ '+deal.size+' SF':''}${deal.closedDate?' ¬∑ Closed '+fmt(deal.closedDate):''}</div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn sm ghost" onclick="reopenClosedDeal('${deal.id}')" title="Send back to active pipeline">‚Ü© Reopen</button>
        <button class="btn sm ghost" onclick="repairDeal('${deal.id}')" title="Normalize all field names ‚Äî fixes imported deals with blank fields" style="color:var(--accent)">üîß Repair</button>
        <button class="btn sm danger" onclick="if(confirm('Delete this deal? It goes to trash.')){delDeal('${deal.id}');selectedClosed=null;renderContent();}">üóë Delete</button>
        <button class="btn sm ghost" onclick="selectedClosed=null;renderContent()">‚úï</button>
      </div>
    </div>

    ${isLease&&deal.leaseEnd?`<div class="big-ticker" style="margin-bottom:14px">
      <div style="font-size:9px;color:var(--text3);letter-spacing:.15em;text-transform:uppercase;margin-bottom:6px">Days Until Lease Expires</div>
      <div class="${dl!=null&&dl<=180?'blink':''}" style="font-size:52px;font-weight:800;font-family:'DM Mono',monospace;color:${dl!=null&&dl<=90?'var(--red)':dl!=null&&dl<=180?'var(--orange)':'var(--green)'}">${dl!=null?(dl>=0?dl:'EXPIRED'):'‚Äî'}</div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">${fmt(deal.leaseStart||'')} ‚Üí ${fmt(deal.leaseEnd||'')}</div>
      ${pct!=null?`<div style="margin-top:8px;background:var(--border);height:5px;border-radius:3px;overflow:hidden"><div style="height:100%;width:${pct}%;background:var(--green);border-radius:3px;transition:width .3s"></div></div>`:''}
    </div>`:''}

    <!-- Deal Type toggle -->
    <div class="section-wrap">
      <div class="section-title" onclick="toggleSec('cd-type-${deal.id}')"><span>üîÄ Deal Type</span><span style="font-size:9px;color:var(--text3)">‚ñº</span></div>
      <div id="cd-type-${deal.id}" style="display:flex;gap:8px;padding-bottom:6px">
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;background:${isLease?'var(--blue-bg)':'var(--surface2)'};border:2px solid ${isLease?'var(--blue-border)':'var(--border)'};border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:700;color:${isLease?'var(--blue)':'var(--text3)'}"><input type="radio" name="dtype-${deal.id}" value="Lease" ${isLease?'checked':''} onchange="updDeal('${deal.id}',{dealType:'Lease'});renderContent()"/> üìÑ Lease</label>
        <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;background:${!isLease?'var(--purple-bg)':'var(--surface2)'};border:2px solid ${!isLease?'var(--purple-border)':'var(--border)'};border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:700;color:${!isLease?'var(--purple)':'var(--text3)'}"><input type="radio" name="dtype-${deal.id}" value="Purchase" ${!isLease?'checked':''} onchange="updDeal('${deal.id}',{dealType:'Purchase'});renderContent()"/> üè¢ Purchase / Sale</label>
      </div>
    </div>

    <!-- Contact & Company -->
    <div class="section-wrap">
      <div class="section-title" onclick="toggleSec('cd-contact-${deal.id}')"><span>üë§ Contact & Company</span><span style="font-size:9px;color:var(--text3)">‚ñº</span></div>
      <div id="cd-contact-${deal.id}">
        <div class="form-grid">
          <div class="field"><label>Tenant / Client / Company</label><input value="${esc(deal.tenantName||deal.companyName||'')}" onchange="updDeal('${deal.id}',{tenantName:this.value})"/></div>
          <div class="field"><label>Contact Name</label><input value="${esc(deal.contactName||'')}" onchange="updDeal('${deal.id}',{contactName:this.value})"/></div>
          <div class="field"><label>Phone</label><input value="${esc(deal.contactPhone||deal.phone||'')}" onchange="updDeal('${deal.id}',{contactPhone:this.value})"/></div>
          <div class="field"><label>Email</label><input type="email" value="${esc(deal.contactEmail||deal.email||'')}" onchange="updDeal('${deal.id}',{contactEmail:this.value})"/></div>
        </div>
      </div>
    </div>

    <!-- Property Info -->
    <div class="section-wrap">
      <div class="section-title" onclick="toggleSec('cd-prop-${deal.id}')"><span>üè¢ Property Details</span><span style="font-size:9px;color:var(--text3)">‚ñº</span></div>
      <div id="cd-prop-${deal.id}">
        <div class="form-grid">
          <div class="field"><label>Property / Address</label><input value="${esc(deal.location||'')}" onchange="updDeal('${deal.id}',{location:this.value})"/></div>
          <div class="field"><label>Submarket</label><input value="${esc(deal.submarket||'')}" onchange="updDeal('${deal.id}',{submarket:this.value})"/></div>
          <div class="field"><label>Building Size (SF)</label><input value="${esc(deal.size||'')}" onchange="updDeal('${deal.id}',{size:this.value})"/></div>
          <div class="field"><label>Close Date</label><input type="date" value="${esc(deal.closedDate||'')}" onchange="updDeal('${deal.id}',{closedDate:this.value})"/></div>

          ${isLease?`
          <div class="field"><label>Rate (PSF / yr)</label><input type="number" value="${esc(deal.budget||deal.costPsf||'')}" onchange="updDeal('${deal.id}',{budget:this.value,costPsf:this.value})"/></div>
          <div class="field"><label>Lease Term (years)</label><input type="number" value="${esc(deal.leaseTerm||'')}" onchange="updDeal('${deal.id}',{leaseTerm:this.value})"/></div>
          <div class="field"><label>Annual Escalation (%)</label><input type="number" step="0.1" value="${esc(deal.annualEscalation||'')}" placeholder="e.g. 3" onchange="updDeal('${deal.id}',{annualEscalation:this.value})" title="Annual rent increase percentage. Used to calculate total deal value and commission."/></div>
          <div class="field"><label>Lease Start</label><input type="date" value="${esc(deal.leaseStart||'')}" onchange="updDeal('${deal.id}',{leaseStart:this.value})"/></div>
          <div class="field"><label>Lease End / Expiration</label><input type="date" value="${esc(deal.leaseEnd||'')}" onchange="updDeal('${deal.id}',{leaseEnd:this.value})"/></div>
          <div class="field"><label>Landlord / LL Name</label><input value="${esc(deal.landlord||'')}" onchange="updDeal('${deal.id}',{landlord:this.value})"/></div>
          <div class="field"><label>Op Ex ($/SF/yr)</label><input type="number" step="0.01" value="${esc(deal.opEx||'')}" placeholder="e.g. 4.50" onchange="updDeal('${deal.id}',{opEx:this.value})" title="Operating expenses per SF per year (NNN pass-throughs, CAM, taxes, insurance)"/></div>
          <div class="field"><label>Lease Structure</label><select onchange="updDeal('${deal.id}',{leaseStructure:this.value})"><option value="">‚Äî</option>${['NNN','Gross','Modified Gross','Full Service'].map(o=>`<option${deal.leaseStructure===o?' selected':''}>${o}</option>`).join('')}</select></div>
          `:`
          <div class="field"><label>Purchase Price ($)</label><input type="number" value="${esc(deal.purchasePrice||'')}" onchange="updDeal('${deal.id}',{purchasePrice:this.value})"/></div>
          <div class="field"><label>Price Per SF ($)</label><input type="number" value="${esc(deal.pricePsf||'')}" onchange="updDeal('${deal.id}',{pricePsf:this.value})"/></div>
          <div class="field"><label>Cap Rate (%)</label><input type="number" value="${esc(deal.capRate||'')}" onchange="updDeal('${deal.id}',{capRate:this.value})"/></div>
          <div class="field"><label>Property Type</label><input value="${esc(deal.propertyType||'')}" placeholder="Office, Retail, Industrial‚Ä¶" onchange="updDeal('${deal.id}',{propertyType:this.value})"/></div>
          <div class="field"><label>Seller / Owner</label><input value="${esc(deal.landlord||'')}" onchange="updDeal('${deal.id}',{landlord:this.value})"/></div>
          <div class="field"><label>Year Built</label><input value="${esc(deal.yearBuilt||'')}" onchange="updDeal('${deal.id}',{yearBuilt:this.value})"/></div>
          `}
          <div class="field"><label>Commission %</label><input type="number" value="${esc(deal.commPct||'3')}" onchange="updDeal('${deal.id}',{commPct:this.value})"/></div>
          <div class="field"><label>Priority</label><select onchange="updDeal('${deal.id}',{priority:this.value})"><option ${deal.priority==='High'?'selected':''}>High</option><option ${!deal.priority||deal.priority==='Medium'?'selected':''}>Medium</option><option ${deal.priority==='Low'?'selected':''}>Low</option></select></div>
          <div class="field" style="grid-column:span 2"><label>Google Drive URL</label><input value="${esc(deal.driveUrl||'')}" placeholder="https://drive.google.com/‚Ä¶" onchange="updDeal('${deal.id}',{driveUrl:this.value})"/></div>
          <div class="field" style="grid-column:span 2"><label>Notes / Deal Story</label><textarea rows="3" style="resize:vertical" onchange="updDeal('${deal.id}',{dealNotes:this.value})">${esc(deal.dealNotes||'')}</textarea></div>
        </div>
      </div>
    </div>

    <!-- Commission -->
    <div class="section-wrap">
      <div class="section-title" onclick="toggleSec('cd-comm-${deal.id}')"><span>üí∞ Commission</span>${deal.manualGross||deal.manualTakeHome?`<span style="font-size:9px;color:var(--accent);font-weight:700">‚ö° OVERRIDE</span>`:`<span style="font-size:9px;color:var(--text3)">‚ñº</span>`}</div>
      <div id="cd-comm-${deal.id}">
        <div class="comm-block">
          <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-bottom:10px;font-weight:700">${deal.manualGross||deal.manualSplit||deal.manualTakeHome?'‚ö° Manual Override Active ‚Äî auto-calc is bypassed':'Auto-Calculated from Deal Info'}</div>
          ${isLease&&c.total>0?`
          <div style="display:grid;grid-template-columns:repeat(${c.opEx>0?'5':'3'},1fr);gap:8px;margin-bottom:10px">
            ${[['Monthly (Base)','$'+Math.round(c.monthly).toLocaleString(),'var(--blue)'],['Annual (Base)','$'+Math.round(c.annual).toLocaleString(),'var(--accent)'],['Total Value','$'+Math.round(c.total).toLocaleString(),'var(--yellow)'],...(c.opEx>0?[['Eff. Monthly','$'+Math.round(c.effectiveMonthly).toLocaleString(),'var(--orange)'],['Eff. Annual','$'+Math.round(c.effectiveAnnual).toLocaleString(),'var(--red)']]:[] )].map(([l,v,col])=>`
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:10px;text-align:center">
              <div style="font-size:8px;color:var(--text3);text-transform:uppercase;margin-bottom:3px;letter-spacing:.1em">${l}</div>
              <div style="font-size:14px;font-weight:800;color:${col};font-family:'DM Mono',monospace">${v}</div>
            </div>`).join('')}
          </div>`:``}
          ${dispGross||dispTake?`
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:10px">
            ${[['Gross Comm',dispGross,'var(--yellow)'],['After Split',dispSplit,'var(--accent)'],['Take-Home',dispTake,'var(--green)'],['After Tax '+(settings.taxRate||30)+'%',dispAfterTax,'var(--purple)']].map(([l,v,col])=>`
            <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:10px;text-align:center">
              <div style="font-size:9px;color:var(--text3);text-transform:uppercase;margin-bottom:4px">${l}</div>
              <div style="font-size:15px;font-weight:800;color:${col};font-family:'DM Mono',monospace">${usd(v)}</div>
            </div>`).join('')}
          </div>`:`<div style="font-size:12px;color:var(--text3);padding:8px 0">Enter deal details above or override manually below.</div>`}
          ${isLease&&c.breakdown&&c.breakdown.length>1&&deal.annualEscalation?`
          <details style="margin-top:8px">
            <summary style="font-size:9px;color:var(--text3);cursor:pointer;letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:6px">üìà Escalation Schedule (${deal.annualEscalation}% / yr)</summary>
            <div style="display:grid;grid-template-columns:auto 1fr 1fr 1fr;gap:4px 10px;font-size:10px;padding:8px 0">
              <span style="font-weight:700;color:var(--text3)">Yr</span><span style="font-weight:700;color:var(--text3)">PSF</span><span style="font-weight:700;color:var(--text3)">Annual</span><span style="font-weight:700;color:var(--text3)">Monthly</span>
              ${c.breakdown.map(b=>`<span style="color:var(--text3)">${b.yr}</span><span style="color:var(--accent);font-family:'DM Mono',monospace">$${b.psf.toFixed(2)}</span><span style="color:var(--text);font-family:'DM Mono',monospace">$${Math.round(b.annual).toLocaleString()}</span><span style="color:var(--text2);font-family:'DM Mono',monospace">$${Math.round(b.monthly).toLocaleString()}</span>`).join('')}
            </div>
          </details>`:``}
        </div>
        <div style="background:var(--accent-bg);border:1px solid var(--accent-border);border-radius:var(--radius);padding:12px;margin-top:10px">
          <div style="font-size:9px;color:var(--accent);letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:8px">‚ö° Manual Override</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div class="field"><label>Gross Commission ($)</label><input type="number" placeholder="e.g. 45000" value="${deal.manualGross||''}" onchange="updDeal('${deal.id}',{manualGross:this.value})"/></div>
            <div class="field"><label>After Split ($)</label><input type="number" placeholder="e.g. 31500" value="${deal.manualSplit||''}" onchange="updDeal('${deal.id}',{manualSplit:this.value})"/></div>
            <div class="field"><label>Take-Home ($)</label><input type="number" placeholder="e.g. 22050" value="${deal.manualTakeHome||''}" onchange="updDeal('${deal.id}',{manualTakeHome:this.value})"/></div>
          </div>
          ${(deal.manualGross||deal.manualSplit||deal.manualTakeHome)?`<button class="btn xs ghost" style="margin-top:8px" onclick="updDeal('${deal.id}',{manualGross:'',manualSplit:'',manualTakeHome:''})">‚Ü∫ Clear overrides ‚Äî revert to auto-calc</button>`:''}
        </div>
      </div>
    </div>

    ${isLease&&deal.leaseEnd?`<div class="section-wrap">
      <div class="section-title" onclick="toggleSec('cd-fu-${deal.id}')"><span>‚è∞ Renewal Follow-Up Reminders</span><span style="font-size:9px;color:var(--text3)">‚ñº</span></div>
      <div id="cd-fu-${deal.id}"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">${FU.map(fu=>{const fuDate=deal.leaseEnd?new Date(new Date(deal.leaseEnd+'T12:00:00').getTime()-fu.d*86400000).toISOString().slice(0,10):null;const passed=fuDate&&fuDate<tod();return`<div class="fu-card"><div style="font-size:16px;font-weight:800;color:${passed?'var(--text3)':'var(--text)'}">${fu.l}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">${fuDate?fmt(fuDate):'‚Äî'}</div>${!passed&&fuDate?`<button class="btn sm primary" style="margin-top:6px" onclick="addEvent({title:'${fu.l} Renewal Follow-up: ${esc(deal.tenantName||deal.companyName||'')}',date:'${fuDate}',type:'Follow Up',notes:'Lease renewal follow-up'})">+ Remind</button>`:passed?`<div style="font-size:9px;color:var(--text3);margin-top:4px">Passed</div>`:''}</div>`;}).join('')}</div></div>
    </div>`:''}

    ${googleDriveSection(deal)}
  </div>`;
}


function renderProspects(){
  const src=srch().toLowerCase();
  const pros=state.prospects.filter(p=>{const ms=!src||[p.companyName,p.contactName,p.email,p.phone,p.status].join(' ').toLowerCase().includes(src);return ms&&(prosFilter==='All'||p.status===prosFilter);}).sort((a,b)=>{const po={High:0,Medium:1,Low:2};const pa=po[a.priority]??2,pb=po[b.priority]??2;return pa!==pb?pa-pb:new Date(b.lastTouched||0)-new Date(a.lastTouched||0);});
  const px=selectedProspect?state.prospects.find(x=>x.id===selectedProspect.id):null;
  const massBar=prosSelMode&&prosSel.size>0?`<div class="mass-bar">
    <span style="font-size:12px;font-weight:600;color:var(--accent)">${prosSel.size} selected</span>
    <button class="btn xs ghost" onclick="selectAllProspects()">Select All (${pros.length})</button>
    <button class="btn sm danger" onclick="trashMany('prospects',prosSel,'prospects')">üóë Delete</button>
    <select id="pros-mv-sel" style="width:auto">${PROSP_ST.map(s=>`<option>${s}</option>`).join('')}</select>
    <button class="btn sm primary" onclick="moveManyProspects(q('pros-mv-sel').value)">Move Status</button>
    <button class="btn sm success" onclick="convertSelToDeals()">‚Üí Convert to Deals</button>
    <button class="btn xs ghost" onclick="prosSel=new Set();prosSelMode=false;renderContent()">Clear</button>
  </div>`:'';
  return`<div style="display:flex;gap:16px;height:calc(100vh - 110px)">
  <div style="width:${px?'310px':'100%'};flex-shrink:0;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span style="font-weight:800;color:var(--text);font-size:16px">Prospects <span style="color:var(--text3);font-size:13px;font-weight:400">(${pros.length})</span></span>
      <div style="display:flex;gap:6px">
        <button class="btn sm ghost" onclick="prosSelMode=!prosSelMode;prosSel=new Set();renderContent()">${prosSelMode?'Cancel':'‚òë Select'}</button>
        <button class="btn sm" onclick="csvImportClick('prospects')">‚¨Ü CSV</button>
        <input type="file" id="csv-prospects" accept=".csv" onchange="handleCSVFile(this,'prospects')"/>
        <button class="btn sm primary" onclick="openModal('quick-prospect')">+ Add</button>
      </div>
    </div>
    ${massBar}
    ${sfRow(['All',...PROSP_ST],prosFilter,'prosFilter')}
    ${pros.map(p=>{const ds=daysSince(p.lastTouched),stale=ds>14;const cc=stColor(p.status);const isSel=prosSel.has(p.id);const step=PROSP_ST.indexOf(p.status);
    return`<div class="item-card${selectedProspect&&selectedProspect.id===p.id?' selected-card':''}${isSel?' checked':''} card" style="border-left:3px solid ${cc.border}" onclick="${prosSelMode?`toggleProsSel('${p.id}',event)`:`selectProspect('${p.id}')`}">
      <div style="display:flex;gap:8px">
        ${prosSelMode?`<input type="checkbox" class="cb" ${isSel?'checked':''} onchange="toggleProsSel('${p.id}',event)" onclick="event.stopPropagation()"/>`:''}
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:800;color:var(--text);font-size:13px">${esc(p.companyName||'Unknown')}</span>${sbadge(p.status)}</div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:5px">${esc(p.contactName||'‚Äî')} ¬∑ ${esc(p.phone||'‚Äî')}</div>
          ${progBar(step,PROSP_ST.length-1,PROSP_ST)}
          <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:10px">
            <span style="color:var(--text3)">${esc(p.source||'')}</span>
            <span class="${stale?'blink':''}" style="color:${stale?'var(--red)':'var(--text3)'};font-weight:${stale?700:400}">${ds===0?'Today':ds+'d ago'}</span>
          </div>
        </div>
      </div>
    </div>`;}).join('')||nilHtml('No prospects')}
  </div>
  ${px?prospectDetailHTML(px):''}
  </div>`;
}
function toggleProsSel(id,e){e.stopPropagation();if(prosSel.has(id))prosSel.delete(id);else prosSel.add(id);renderContent();}
function selectAllProspects(){const src=srch().toLowerCase();const visible=state.prospects.filter(p=>{const ms=!src||[p.companyName,p.contactName,p.email,p.phone,p.status].join(' ').toLowerCase().includes(src);return ms&&(prosFilter==='All'||p.status===prosFilter);});visible.forEach(p=>prosSel.add(p.id));renderContent();}
function selectProspect(id){selectedProspect=state.prospects.find(p=>p.id===id);renderContent();}

function prospectDetailHTML(p){const ds=daysSince(p.lastTouched);const step=PROSP_ST.indexOf(p.status);const acts=state.activities.filter(a=>a.entityId===p.id);const cc=stColor(p.status);
return`<div class="detail-panel card">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
    <div><div style="font-size:22px;font-weight:800;color:var(--text)">${esc(p.companyName||'Unknown')}</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Last touched: ${fmt(p.lastTouched)}</div></div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn sm success" onclick="prospectToDeal('${p.id}')">‚Üí Move to Deals</button>
      <button class="btn sm ghost" onclick="openModal('template-picker',{type:'prospect',id:'${p.id}'})">‚úâ Email</button>
      <button class="btn sm danger" onclick="delProspect('${p.id}')">Delete</button>
      <button class="btn sm ghost" onclick="selectedProspect=null;renderContent()">‚úï</button>
    </div>
  </div>
  <div class="status-monitor">
    <div style="font-size:9px;color:var(--text3);letter-spacing:.15em;text-transform:uppercase;margin-bottom:12px;font-weight:700">Status Monitor</div>
    <div style="display:flex;position:relative">${PROSP_ST.map((s,i)=>{const done=i<step,active=i===step;const sc=stColor(s);return`<div style="flex:1;text-align:center;cursor:pointer;position:relative;z-index:1" onclick="updProspect('${p.id}',{status:'${s}'})">
      <div style="width:22px;height:22px;border-radius:50%;background:${done||active?sc.bg:'var(--surface2)'};border:2px solid ${done||active?sc.border:'var(--border)'};display:flex;align-items:center;justify-content:center;margin:0 auto 5px;font-size:9px;color:${done||active?sc.text:'var(--text3)'};font-weight:700;box-shadow:${active?`0 0 8px ${sc.border}`:'none'}">${done?'‚úì':i+1}</div>
      <div style="font-size:8px;color:${active?sc.text:done?'var(--text2)':'var(--text3)'};text-transform:uppercase;line-height:1.3">${s}</div>
      ${i<PROSP_ST.length-1?`<div style="position:absolute;top:10px;left:50%;width:100%;height:2px;background:${done?sc.border:'var(--border)'};z-index:-1"></div>`:''}
    </div>`;}).join('')}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px">
      <div class="ticker-box" style="border:1px solid ${ds>14?'var(--red-border)':ds>7?'var(--yellow-border)':'var(--green-border)'}">
        <span class="ticker-lbl">Last Contact</span>
        <span class="${ds>7?'blink':''} ticker-val" style="color:${ds>14?'var(--red)':ds>7?'var(--yellow)':'var(--green)'}">${ds===0?'TODAY':ds+'D AGO'}</span>
      </div>
      ${p.leaseExp?`<div class="ticker-box" style="border:1px solid ${daysUntil(p.leaseExp)<=90?'var(--red-border)':'var(--border)'}"><span class="ticker-lbl">Lease Exp</span><span class="ticker-val" style="color:${daysUntil(p.leaseExp)<=90?'var(--red)':'var(--green)'}">${daysUntil(p.leaseExp)}D</span></div>`:''}
    </div>
  </div>
  ${statusBtns(PROSP_ST,p.status,`updProspect('${p.id}',{status:this.dataset.s})`)}
  ${section('Contact Info',`<div class="form-grid">
    ${[['Company','companyName'],['Contact','contactName'],['Phone','phone'],['Email','email'],['Address','companyAddress'],['Current SF','currentSf'],['Current PSF','currentPsf']].map(([l,k])=>`<div class="field"><label>${l}</label><input value="${esc(p[k]||'')}" onchange="updProspect('${p.id}',{${k}:this.value})"/></div>`).join('')}
    <div class="field"><label>Source</label><select onchange="updProspect('${p.id}',{source:this.value})">${['Cold Call','Email','Mailer','Canvassing','Referral','LinkedIn','Other'].map(o=>`<option${p.source===o?' selected':''}>${o}</option>`).join('')}</select></div>
    <div class="field"><label>Priority</label><select onchange="updProspect('${p.id}',{priority:this.value})">${['High','Medium','Low'].map(o=>`<option${p.priority===o?' selected':''}>${o}</option>`).join('')}</select></div>
    <div class="field"><label>Lease Expiration</label><input type="date" value="${esc(p.leaseExp||'')}" onchange="updProspect('${p.id}',{leaseExp:this.value})"/></div>
  </div>`)}
  ${section('Log Outreach',logActHtml('prospect',p.id))}
  ${section('Notes',notesHtml(p,'prospect'))}
  ${section('Activity History',actHistHtml(acts))}
</div>`;}

// ‚ïê‚ïê‚ïê KANBAN ‚ïê‚ïê‚ïê
function renderKanban(items,cols,type){const get=col=>items.filter(i=>i.status===col);return`<div>
  <div style="font-weight:700;color:var(--text);font-size:14px;margin-bottom:14px">Pipeline ‚Äî drag cards to update status</div>
  <div class="kanban-wrap">${cols.map(col=>{const cc=stColor(col);const colItems=get(col);return`<div class="k-col" style="background:${cc.bg};border:1px solid ${cc.border}" ondragover="event.preventDefault()" ondrop="kanbanDrop('${col}','${type}')">
    <div class="k-col-hdr" style="color:${cc.text}">${col}<span class="cnt" style="background:${cc.border}44;color:${cc.text}">${colItems.length}</span></div>
    ${colItems.map(item=>{
      const intentTag=type==='deal'&&item.dealIntent?`<span style="font-size:8px;padding:1px 5px;border-radius:3px;font-weight:700;letter-spacing:.05em;margin-top:3px;display:inline-block;background:${item.dealIntent==='Buying'?'var(--purple-bg)':'var(--blue-bg)'};color:${item.dealIntent==='Buying'?'var(--purple)':'var(--blue)'};border:1px solid ${item.dealIntent==='Buying'?'var(--purple-border)':'var(--blue-border)'}">${item.dealIntent==='Buying'?'üè¢ BUYING':'üìÑ LEASING'}</span>`:'';
      return`<div class="k-card" style="background:var(--surface);border-color:${cc.border}66;color:var(--text)" draggable="true" ondragstart="dragItem={id:'${item.id}',type:'${type}'}" onclick="${type==='deal'?`selectDeal('${item.id}');setView('deals')`:`selectProspect('${item.id}');setView('prospects')`}">
      <div style="font-weight:700;margin-bottom:2px">${esc(item.companyName||item.tenantName||'Unnamed')}</div>
      <div style="color:var(--text3);font-size:10px">${esc(item.location||item.companyAddress||'')}</div>
      ${item.size?`<div style="color:var(--text3);font-size:10px;margin-top:2px">${item.size} SF</div>`:''}
      ${intentTag}
      ${priDot(item.priority)}
    </div>`;}).join('')}
    <div style="color:${cc.border};font-size:11px;text-align:center;padding:12px 0;opacity:.6">Drop here</div>
  </div>`;}).join('')}</div></div>`;}
function kanbanDrop(status,type){if(!dragItem)return;if(type==='deal')updDeal(dragItem.id,{status});else updProspect(dragItem.id,{status});dragItem=null;}

// ‚ïê‚ïê‚ïê REFERRALS ‚ïê‚ïê‚ïê
function renderReferrals(){
  const refs=state.referrals||{referred:[],given:[]};
  return`<div>
    <div style="font-weight:800;color:var(--text);font-size:18px;margin-bottom:4px">Referrals</div>
    <div style="font-size:12px;color:var(--text3);margin-bottom:18px">Track opportunities you've referred out and been referred in.</div>
    <div style="display:flex;gap:16px">
      <div class="ref-col">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div><div style="font-size:14px;font-weight:800;color:var(--text)">üì• Referred In</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Tenants referred to me</div></div>
          <button class="btn sm primary" onclick="toggleSec('add-ref-in')">+ Add</button>
        </div>
        <div id="add-ref-in" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:14px" class="card">
          <div class="form-grid">
            <div class="field"><label>Tenant Name / Company</label><input id="ri-tenant"/></div>
            <div class="field"><label>Referred By</label><input id="ri-refby" placeholder="Who sent this to me"/></div>
            <div class="field"><label>Space Need (SF)</label><input id="ri-sf"/></div>
            <div class="field"><label>Timeline</label><input id="ri-tl" placeholder="e.g. Q1 2026"/></div>
            <div class="field" style="grid-column:span 2"><label>Notes</label><textarea id="ri-notes" rows="2" style="resize:vertical"></textarea></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn sm primary" onclick="saveRefIn()">Save</button>
            <button class="btn sm ghost" onclick="toggleSec('add-ref-in')">Cancel</button>
          </div>
        </div>
        ${refs.referred.length===0?nilHtml('No referred-in opportunities yet'):''}
        ${refs.referred.map(r=>`<div class="ref-card">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <div style="font-weight:700;color:var(--text)">${esc(r.tenantName||'‚Äî')}</div>
            <button onclick="delReferral('referred','${r.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px">‚úï</button>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:3px">Referred by: <span style="color:var(--accent);font-weight:600">${esc(r.refBy||'‚Äî')}</span></div>
          ${r.sf?`<div style="font-size:11px;color:var(--text3)">Space: ${r.sf} SF</div>`:''}
          ${r.timeline?`<div style="font-size:11px;color:var(--text3)">Timeline: ${r.timeline}</div>`:''}
          ${r.notes?`<div style="font-size:11px;color:var(--text2);margin-top:5px;padding-top:5px;border-top:1px solid var(--border)">${esc(r.notes)}</div>`:''}
          <div style="font-size:9px;color:var(--text3);margin-top:4px">${fmt(r.createdAt)}</div>
        </div>`).join('')}
      </div>
      <div class="ref-col">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div><div style="font-size:14px;font-weight:800;color:var(--text)">üì§ Referred Out</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Tenants I've referred to others</div></div>
          <button class="btn sm primary" onclick="toggleSec('add-ref-out')">+ Add</button>
        </div>
        <div id="add-ref-out" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:14px" class="card">
          <div class="form-grid">
            <div class="field"><label>Tenant Name / Company</label><input id="ro-tenant"/></div>
            <div class="field"><label>Referred To</label><input id="ro-refto" placeholder="Who I sent this to"/></div>
            <div class="field"><label>Space Need (SF)</label><input id="ro-sf"/></div>
            <div class="field"><label>Timeline</label><input id="ro-tl"/></div>
            <div class="field" style="grid-column:span 2"><label>Notes</label><textarea id="ro-notes" rows="2" style="resize:vertical"></textarea></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn sm primary" onclick="saveRefOut()">Save</button>
            <button class="btn sm ghost" onclick="toggleSec('add-ref-out')">Cancel</button>
          </div>
        </div>
        ${refs.given.length===0?nilHtml('No referred-out opportunities yet'):''}
        ${refs.given.map(r=>`<div class="ref-card">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <div style="font-weight:700;color:var(--text)">${esc(r.tenantName||'‚Äî')}</div>
            <button onclick="delReferral('given','${r.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px">‚úï</button>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:3px">Referred to: <span style="color:var(--purple);font-weight:600">${esc(r.refTo||'‚Äî')}</span></div>
          ${r.sf?`<div style="font-size:11px;color:var(--text3)">Space: ${r.sf} SF</div>`:''}
          ${r.timeline?`<div style="font-size:11px;color:var(--text3)">Timeline: ${r.timeline}</div>`:''}
          ${r.notes?`<div style="font-size:11px;color:var(--text2);margin-top:5px;padding-top:5px;border-top:1px solid var(--border)">${esc(r.notes)}</div>`:''}
          <div style="font-size:9px;color:var(--text3);margin-top:4px">${fmt(r.createdAt)}</div>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}
function saveRefIn(){const t=q('ri-tenant')?.value?.trim();if(!t){toast('Tenant name required');return;}addReferral('referred',{tenantName:t,refBy:q('ri-refby')?.value||'',sf:q('ri-sf')?.value||'',timeline:q('ri-tl')?.value||'',notes:q('ri-notes')?.value||''});toggleSec('add-ref-in');}
function saveRefOut(){const t=q('ro-tenant')?.value?.trim();if(!t){toast('Tenant name required');return;}addReferral('given',{tenantName:t,refTo:q('ro-refto')?.value||'',sf:q('ro-sf')?.value||'',timeline:q('ro-tl')?.value||'',notes:q('ro-notes')?.value||''});toggleSec('add-ref-out');}

// ‚ïê‚ïê‚ïê MARKET ‚ïê‚ïê‚ïê
function renderMarket(){
  const src=srch().toLowerCase();
  const allComps=state.comps;
  const comps=allComps.filter(c=>!src||[c.address,c.submarket,c.landlord].join(' ').toLowerCase().includes(src));
  const validPsf=comps.filter(c=>parseFloat(c.askingPsf)>0);
  const validSz=comps.filter(c=>parseInt(c.size)>0);
  const validTerm=comps.filter(c=>parseFloat(c.leaseTerm)>0);
  const avgPsf=validPsf.length?(validPsf.reduce((s,c)=>s+parseFloat(c.askingPsf),0)/validPsf.length).toFixed(2):null;
  const avgSf=validSz.length?Math.round(validSz.reduce((s,c)=>s+parseInt(c.size),0)/validSz.length):null;
  const avgTerm=validTerm.length?(validTerm.reduce((s,c)=>s+parseFloat(c.leaseTerm),0)/validTerm.length).toFixed(1):null;
  // Group by building address (strip suite number)
  const byAddr={};
  const buildingNames={};// key ‚Üí display name
  comps.forEach(c=>{
    const parsed=parseCompAddress(c.address||'Unknown');
    const key=parsed.building.toLowerCase().replace(/[,\.]/g,'').trim();
    if(!byAddr[key]){byAddr[key]=[];buildingNames[key]=parsed.building;}
    byAddr[key].push({...c,_suite:parsed.suite,_building:parsed.building});
  });
  const addrKeys=Object.keys(byAddr).sort();
return`<div>
  <div style="font-weight:800;color:var(--text);font-size:18px;margin-bottom:4px">Market Intelligence</div>
  <div style="font-size:12px;color:var(--text3);margin-bottom:16px">Comps grouped by address ‚Äî click to expand. Add multiple comps per address to track changes over time.</div>
  ${comps.length>0?`<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">
    ${[['Comps',comps.length,'var(--accent)'],['Avg PSF',avgPsf?'$'+avgPsf:'‚Äî','var(--yellow)'],['Avg SF',avgSf?avgSf.toLocaleString():'‚Äî','var(--green)'],['Avg Term',avgTerm?avgTerm+'yr':'‚Äî','var(--purple)'],['Addresses',addrKeys.length,'var(--blue)']].map(([l,v,col])=>`<div class="kpi-card card"><div class="kpi-lbl">${l}</div><div class="kpi-val" style="font-size:20px;color:${col}">${v}</div></div>`).join('')}
  </div>`:''}
  <div style="display:flex;gap:8px;margin-bottom:12px">
    <button class="btn" onclick="toggleSec('add-comp-form')">+ Add Comp</button>
    <button class="btn" onclick="csvImportClick('comps')">‚¨Ü Import CSV</button>
    <input type="file" id="csv-comps" accept=".csv" onchange="handleCSVFile(this,'comps')"/>
    <button class="btn ghost" onclick="exportCSV(state.comps,'db-comps.csv')">‚Üì Export</button>
  </div>
  <div id="add-comp-form" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:14px" class="card">
    <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:10px">Add New Comp</div>
    <div class="form-grid">${[['Address','compAddr'],['Submarket','compSub'],['Size (SF)','compSz'],['Asking PSF','compPsf'],['Lease Term (yr)','compLt'],['Landlord','compLL'],['Vacancy %','compVac']].map(([l,id])=>`<div class="field"><label>${l}</label><input id="${id}"/></div>`).join('')}</div>
    <div class="field" style="margin-top:8px"><label>Notes</label><textarea id="compNotes" rows="2" style="resize:vertical"></textarea></div>
    <div style="display:flex;gap:8px;margin-top:10px"><button class="btn sm primary" onclick="saveComp()">Save</button><button class="btn sm ghost" onclick="toggleSec('add-comp-form')">Cancel</button></div>
  </div>
  ${addrKeys.length===0?`<div style="padding:28px;text-align:center;color:var(--text3)">No comps yet ‚Äî add one above.</div>`:''}
  ${addrKeys.map(addr=>{
    const group=byAddr[addr];
    const gPsf=group.filter(c=>parseFloat(c.askingPsf)>0);
    const gSz=group.filter(c=>parseInt(c.size)>0);
    const gTerm=group.filter(c=>parseFloat(c.leaseTerm)>0);
    const gAvgPsf=gPsf.length?(gPsf.reduce((s,c)=>s+parseFloat(c.askingPsf),0)/gPsf.length).toFixed(2):null;
    const gAvgSf=gSz.length?Math.round(gSz.reduce((s,c)=>s+parseInt(c.size),0)/gSz.length):null;
    const gAvgTerm=gTerm.length?(gTerm.reduce((s,c)=>s+parseFloat(c.leaseTerm),0)/gTerm.length).toFixed(1):null;
    const gid='grp-'+addr.replace(/[^a-zA-Z0-9]/g,'').slice(0,20);
    const multi=group.length>1;
    return`<div class="card" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden">
      <div style="padding:12px 14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:var(--surface2)" onclick="toggleSec('${gid}')">
        <div><div style="font-weight:700;color:var(--text);font-size:13px">üìç ${esc(buildingNames[addr]||addr)}</div>
        <div style="font-size:10px;color:var(--text3);margin-top:2px">${group.length} comp${group.length!==1?'s':''}${multi?` ¬∑ Avg PSF: ${gAvgPsf?'$'+gAvgPsf:'‚Äî'} ¬∑ Avg SF: ${gAvgSf?gAvgSf.toLocaleString():'‚Äî'} ¬∑ Avg Term: ${gAvgTerm?gAvgTerm+'yr':'‚Äî'}`:''}</div></div>
        <span style="font-size:9px;color:var(--text3)">‚ñº</span>
      </div>
      <div id="${gid}">
        <div style="padding:6px 14px 2px;background:var(--surface2);border-top:1px solid var(--border)">
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 70px;font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700;padding:4px 0">
            <span>Suite ¬∑ Landlord</span><span>SF</span><span>PSF</span><span>Term</span><span>Type</span><span>Submarket</span><span></span>
          </div>
        </div>
        ${group.map(c=>{const isEditing=editCompId===c.id;return isEditing?
        `<div style="padding:14px;border-top:1px solid var(--border);background:var(--accent-bg)">
          <div style="font-size:10px;font-weight:700;color:var(--accent);letter-spacing:.08em;margin-bottom:10px">EDITING COMP</div>
          <div class="form-grid">${[['Address','ec-addr',esc(c.address||'')],['Submarket','ec-sub',esc(c.submarket||'')],['Size (SF)','ec-sz',esc(c.size||'')],['Asking PSF','ec-psf',esc(c.askingPsf||'')],['Lease Term (yr)','ec-lt',esc(c.leaseTerm||'')],['Landlord','ec-ll',esc(c.landlord||'')],['Vacancy %','ec-vac',esc(c.vacancyRate||'')]].map(([l,id,v])=>`<div class="field"><label>${l}</label><input id="${id}" value="${v}"/></div>`).join('')}</div>
          <div class="field" style="margin-top:8px"><label>Notes</label><textarea id="ec-notes" rows="2" style="resize:vertical">${esc(c.notes||'')}</textarea></div>
          <div style="display:flex;gap:8px;margin-top:10px"><button class="btn sm primary" onclick="saveEditComp()">Save Changes</button><button class="btn sm ghost" onclick="cancelEditComp()">Cancel</button></div>
        </div>`:
        `<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 70px;padding:9px 14px;border-top:1px solid var(--border);font-size:12px;align-items:center">
          <div><div style="color:var(--accent);font-weight:700;font-size:10px;margin-bottom:1px">${c._suite?esc(c._suite):'‚Äî'}</div><div style="color:var(--text);font-weight:600;font-size:11px">${c.landlord?esc(c.landlord):'‚Äî'}</div>${c.notes?`<div style="font-size:9px;color:var(--text3);margin-top:1px">${esc(c.notes)}</div>`:''}</div>
          <span style="color:var(--accent);font-size:11px">${c.size?parseInt(c.size).toLocaleString()+' SF':'‚Äî'}</span>
          <span style="color:var(--yellow);font-weight:700">${c.askingPsf?'$'+c.askingPsf+'/SF':'‚Äî'}</span>
          <span style="color:var(--purple);font-size:11px">${c.leaseTerm?c.leaseTerm+' yr':'‚Äî'}</span>
          <span style="color:var(--text3);font-size:11px">${c.leaseType||c.vacancyRate||'‚Äî'}</span>
          <span style="color:var(--text3);font-size:10px">${c.submarket?esc(c.submarket):'‚Äî'}</span>
          <div style="display:flex;gap:4px">
            <button onclick="startEditComp('${c.id}')" style="background:var(--accent-bg);border:1px solid var(--accent-border);border-radius:4px;color:var(--accent);cursor:pointer;font-size:11px;padding:2px 6px" title="Edit">‚úé</button>
            <button onclick="delComp('${c.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px" title="Delete">‚úï</button>
          </div>
        </div>`;}).join('')}
        ${multi?`<div style="padding:8px 14px;background:var(--green-bg);border-top:1px solid var(--green-border);font-size:10px;color:var(--text2)">
          <span style="font-weight:700;color:var(--green)">üìä Averages:</span>
          ${gAvgPsf?`<span style="margin-left:12px;color:var(--yellow)">PSF <b>$${gAvgPsf}</b></span>`:''}
          ${gAvgSf?`<span style="margin-left:12px;color:var(--accent)">SF <b>${gAvgSf.toLocaleString()}</b></span>`:''}
          ${gAvgTerm?`<span style="margin-left:12px;color:var(--purple)">Term <b>${gAvgTerm} yr</b></span>`:''}
        </div>`:''}
      </div>
    </div>`;}).join('')}
</div>`;}




// ‚ïê‚ïê‚ïê DEAL EVALUATOR ‚ïê‚ïê‚ïê
function renderEvaluator(){
  const allDeals=[...state.deals,...state.deals.filter(d=>d.status==='Leased/Purchased')];
  const evalDeal=evalDealId?state.deals.find(d=>d.id===evalDealId):null;
  const isLease=evalDealType==='lease';
  
  // Pull comps matching the deal type
  const comps=state.comps.filter(c=>{
    if(!c.askingPsf&&!c.size)return false;
    if(isLease&&c.leaseType&&['purchase','sale'].includes((c.leaseType||'').toLowerCase()))return false;
    return true;
  });
  
  // Stats from comps
  const psfVals=comps.map(c=>num(c.askingPsf)).filter(v=>v>0);
  const sfVals=comps.map(c=>num(c.size)).filter(v=>v>0);
  const termVals=comps.map(c=>num(c.leaseTerm)).filter(v=>v>0);
  const avgPsf=psfVals.length?psfVals.reduce((a,b)=>a+b,0)/psfVals.length:0;
  const avgSf=sfVals.length?sfVals.reduce((a,b)=>a+b,0)/sfVals.length:0;
  const avgTerm=termVals.length?termVals.reduce((a,b)=>a+b,0)/termVals.length:0;
  const minPsf=psfVals.length?Math.min(...psfVals):0;
  const maxPsf=psfVals.length?Math.max(...psfVals):0;
  const medPsf=psfVals.length?[...psfVals].sort((a,b)=>a-b)[Math.floor(psfVals.length/2)]:0;
  
  // Deal metrics
  const dealPsf=evalDeal?num(evalDeal.budget||evalDeal.costPsf||0):0;
  const dealSf=evalDeal?num(evalDeal.size||0):0;
  const dealTerm=evalDeal?num(evalDeal.leaseTerm||0):0;
  const dealOpEx=evalDeal?num(evalDeal.opEx||0):0;
  const dealEffPsf=dealPsf+dealOpEx;
  
  // Score the deal: lower PSF vs market avg = better
  function scoreRating(val,avg,lower_is_better){
    if(!val||!avg)return null;
    const pct=(val-avg)/avg*100;
    if(lower_is_better){
      if(pct<=-15)return{label:'Excellent',color:'var(--green)',score:5};
      if(pct<=-5)return{label:'Good',color:'var(--blue)',score:4};
      if(pct<=5)return{label:'Market',color:'var(--yellow)',score:3};
      if(pct<=15)return{label:'Above Market',color:'var(--orange)',score:2};
      return{label:'High',color:'var(--red)',score:1};
    } else {
      if(pct>=15)return{label:'Excellent',color:'var(--green)',score:5};
      if(pct>=5)return{label:'Good',color:'var(--blue)',score:4};
      if(pct>=-5)return{label:'Market',color:'var(--yellow)',score:3};
      if(pct>=-15)return{label:'Below Market',color:'var(--orange)',score:2};
      return{label:'Low',color:'var(--red)',score:1};
    }
  }
  const psfRating=dealPsf&&avgPsf?scoreRating(dealPsf,avgPsf,true):null;
  const sfRating=dealSf&&avgSf?scoreRating(dealSf,avgSf,false):null;
  
  // PSF distribution buckets for histogram
  function psfBucket(psf){return Math.floor(psf/5)*5;}
  const buckets={};
  psfVals.forEach(p=>{const b=psfBucket(p);buckets[b]=(buckets[b]||0)+1;});
  const bKeys=Object.keys(buckets).map(Number).sort((a,b)=>a-b);
  const maxBucket=Math.max(...Object.values(buckets),1);

  return`<div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div>
        <div style="font-size:20px;font-weight:800;color:var(--text)">‚öñ Deal Evaluator</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Compare any deal against your comp database ¬∑ ${comps.length} comps loaded</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn sm ${evalDealType==='lease'?'primary':'ghost'}" onclick="evalDealType='lease';renderContent()">üìÑ Lease</button>
        <button class="btn sm ${evalDealType==='purchase'?'primary':'ghost'}" onclick="evalDealType='purchase';renderContent()">üè¢ Purchase</button>
      </div>
    </div>

    <!-- Market Benchmark Row -->
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:18px">
      ${[
        ['Comps in DB',comps.length,'var(--text)'],
        ['Avg PSF',avgPsf?'$'+avgPsf.toFixed(2):'‚Äî','var(--accent)'],
        ['Median PSF',medPsf?'$'+medPsf.toFixed(2):'‚Äî','var(--blue)'],
        ['PSF Range',minPsf&&maxPsf?'$'+minPsf.toFixed(0)+'-$'+maxPsf.toFixed(0):'‚Äî','var(--text2)'],
        ['Avg Term',avgTerm?avgTerm.toFixed(1)+' yrs':'‚Äî','var(--yellow)'],
      ].map(([l,v,col])=>`<div class="kpi-card card"><div class="kpi-lbl">${l}</div><div class="kpi-val" style="color:${col};font-size:16px">${v}</div></div>`).join('')}
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px">

      <!-- Deal Selector -->
      <div class="card" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
        <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:10px">Select a Deal to Evaluate</div>
        <select onchange="evalDealId=this.value;renderContent()" style="width:100%;margin-bottom:12px">
          <option value="">‚Äî Pick a deal ‚Äî</option>
          ${state.deals.filter(d=>evalDealType==='lease'?(!d.dealType||d.dealType==='Leasing'):d.dealType==='Buying').map(d=>`<option value="${d.id}"${evalDealId===d.id?' selected':''}>${esc(d.tenantName||d.companyName||'Unnamed')} ¬∑ ${esc(d.location||d.size||'‚Äî')}</option>`).join('')}
          <optgroup label="‚îÄ Closed ‚îÄ">
          ${state.deals.filter(d=>d.status==='Leased/Purchased').map(d=>`<option value="${d.id}"${evalDealId===d.id?' selected':''}>${esc(d.tenantName||d.companyName||'Unnamed')} (Closed)</option>`).join('')}
          </optgroup>
        </select>
        ${evalDeal?`
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px;font-size:11px">
          <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:6px">${esc(evalDeal.tenantName||evalDeal.companyName||'‚Äî')}</div>
          ${[['Location',evalDeal.location||'‚Äî'],['Size',dealSf?dealSf.toLocaleString()+' SF':'‚Äî'],['Rate',dealPsf?'$'+dealPsf+'/SF':'‚Äî'],['Op Ex',dealOpEx?'$'+dealOpEx+'/SF':'‚Äî'],['Eff. Rate',dealEffPsf?'$'+dealEffPsf.toFixed(2)+'/SF (incl. OpEx)':'‚Äî'],['Term',dealTerm?dealTerm+' yrs':'‚Äî']].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text3)">${l}</span><span style="color:var(--text);font-weight:600">${v}</span></div>`).join('')}
        </div>`:nilHtml('Select a deal from the dropdown above')}
      </div>

      <!-- Rating Panel -->
      <div class="card" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
        <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:10px">Market Position</div>
        ${evalDeal&&(dealPsf||dealSf)?`
        <div style="display:flex;flex-direction:column;gap:10px">
          ${psfRating?`<div style="background:${psfRating.color}18;border:1px solid ${psfRating.color}44;border-radius:8px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <span style="font-size:11px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.08em">Rate vs Market</span>
              <span style="font-weight:800;color:${psfRating.color};font-size:14px">${psfRating.label}</span>
            </div>
            <div style="font-size:11px;color:var(--text2)">Deal: <strong>$${dealPsf}/SF</strong> ¬∑ Market Avg: <strong>$${avgPsf.toFixed(2)}/SF</strong> ¬∑ ${dealPsf<avgPsf?'<span style="color:var(--green)">‚ñº $'+(avgPsf-dealPsf).toFixed(2)+' below avg</span>':'<span style="color:var(--red)">‚ñ≤ $'+(dealPsf-avgPsf).toFixed(2)+' above avg</span>'}</div>
            ${dealOpEx?`<div style="font-size:10px;color:var(--text3);margin-top:4px">Effective rate (base + op ex): $${dealEffPsf.toFixed(2)}/SF</div>`:''}
          </div>`:nilHtml('Enter deal rate to compare')}
          ${sfRating?`<div style="background:${sfRating.color}18;border:1px solid ${sfRating.color}44;border-radius:8px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <span style="font-size:11px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.08em">Size vs Market</span>
              <span style="font-weight:800;color:${sfRating.color};font-size:14px">${sfRating.label}</span>
            </div>
            <div style="font-size:11px;color:var(--text2)">Deal: <strong>${dealSf.toLocaleString()} SF</strong> ¬∑ Market Avg: <strong>${Math.round(avgSf).toLocaleString()} SF</strong></div>
          </div>`:nilHtml('Enter deal SF to compare')}
          ${psfRating&&sfRating?`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center">
            <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-bottom:6px">Overall Score</div>
            <div style="font-size:28px;font-weight:800;color:${['','var(--red)','var(--orange)','var(--yellow)','var(--blue)','var(--green)'][Math.round((psfRating.score+sfRating.score)/2)]}">${['','üî¥','üü†','üü°','üîµ','üü¢'][Math.round((psfRating.score+sfRating.score)/2)]} ${['','Poor','Below Avg','Market Rate','Good','Excellent'][Math.round((psfRating.score+sfRating.score)/2)]}</div>
          </div>`:''}
        </div>`:nilHtml('Select a deal with rate and SF to see market position')}
      </div>
    </div>

    <!-- PSF Distribution Histogram -->
    ${psfVals.length>0?`<div class="card" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px">
      <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:12px">PSF Distribution ‚Äî All Comps${dealPsf?` ¬∑ Your Deal: <span style="color:var(--accent)">$${dealPsf}/SF</span>`:''}${dealEffPsf&&dealOpEx?` ¬∑ Effective: <span style="color:var(--orange)">$${dealEffPsf.toFixed(2)}/SF</span>`:''}</div>
      <div style="display:flex;align-items:flex-end;gap:4px;height:80px;padding-bottom:4px">
        ${bKeys.map(b=>{
          const h=Math.round((buckets[b]/maxBucket)*72);
          const isCurrent=dealPsf&&dealPsf>=b&&dealPsf<b+5;
          const isEff=dealEffPsf&&dealEffPsf>=b&&dealEffPsf<b+5;
          return`<div style="display:flex;flex-direction:column;align-items:center;flex:1" title="$${b}-$${b+5}/SF ¬∑ ${buckets[b]} comp${buckets[b]!==1?'s':''}">
            <div style="font-size:8px;color:var(--text3);margin-bottom:2px">${buckets[b]}</div>
            <div style="width:100%;background:${isCurrent?'var(--accent)':isEff?'var(--orange)':'var(--blue)'}55;border-top:2px solid ${isCurrent?'var(--accent)':isEff?'var(--orange)':'var(--blue)'};border-radius:2px 2px 0 0;height:${h}px;min-height:4px"></div>
            <div style="font-size:7px;color:var(--text3);margin-top:3px;white-space:nowrap">$${b}</div>
          </div>`;
        }).join('')}
      </div>
      <div style="display:flex;gap:12px;font-size:9px;color:var(--text3);margin-top:4px;flex-wrap:wrap">
        <span><span style="color:var(--blue)">‚ñ†</span> Market comps</span>
        ${dealPsf?`<span><span style="color:var(--accent)">‚ñ†</span> Your deal ($${dealPsf}/SF)</span>`:''}
        ${dealEffPsf&&dealOpEx?`<span><span style="color:var(--orange)">‚ñ†</span> Eff. rate (w/ OpEx)</span>`:''}
      </div>
    </div>`:''}

    <!-- Most Similar Comps Table -->
    ${evalDeal&&dealPsf&&comps.length?`<div class="card" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
      <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:10px">Most Similar Comps (by PSF)</div>
      <div style="overflow-x:auto">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;gap:6px;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;font-weight:700;border-bottom:1px solid var(--border);padding-bottom:6px;min-width:500px">
          <span>Address / Suite</span><span>SF</span><span>PSF</span><span>Type</span><span>vs Your Deal</span><span>Submarket</span>
        </div>
        ${comps.sort((a,b)=>Math.abs(num(a.askingPsf)-dealPsf)-Math.abs(num(b.askingPsf)-dealPsf)).slice(0,10).map(c=>{
          const cpsf=num(c.askingPsf);const diff=cpsf-dealPsf;const diffCol=diff>2?'var(--red)':diff<-2?'var(--green)':'var(--yellow)';
          return`<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;gap:6px;padding:7px 0;border-bottom:1px solid var(--border);font-size:11px;min-width:500px;align-items:center">
            <span style="color:var(--text);font-weight:600">${esc(c.address||'‚Äî')}${c._suite?`<span style="color:var(--accent);font-size:9px;display:block">${esc(c._suite)}</span>`:''}</span>
            <span style="color:var(--text2)">${c.size?Number(c.size).toLocaleString()+' SF':'‚Äî'}</span>
            <span style="color:var(--accent);font-weight:700">${cpsf?'$'+cpsf.toFixed(2):'‚Äî'}</span>
            <span style="color:var(--text3)">${c.leaseType||'‚Äî'}</span>
            <span style="color:${diffCol};font-weight:700">${cpsf?(diff>0?'+':'')+'$'+diff.toFixed(2):''}</span>
            <span style="color:var(--text3)">${c.submarket||'‚Äî'}</span>
          </div>`;
        }).join('')}
      </div>
    </div>`:''}
  </div>`;
}

// ‚ïê‚ïê‚ïê COMP ADDRESS PARSING ‚ïê‚ïê‚ïê
function parseCompAddress(addr){
  if(!addr)return{building:'Unknown',suite:''};
  // Patterns: "123 Main St, Suite 400" / "123 Main St, Ste 400" / "123 Main St, #400" / "123 Main St Suite 400"
  const suiteRx=/[,]?\s*(Suite|Ste\.?|Unit|#|Floor|Fl\.?)\s*[A-Z0-9\-]+$/i;
  const m=addr.match(/^(.*?)(?:[,]?\s*(Suite|Ste\.?|Unit|#|Floor|Fl\.?)\s*)([A-Z0-9\-]+)$/i);
  if(m){return{building:m[1].replace(/,\s*$/,'').trim(),suite:(m[2]+''+m[3]).trim()};}
  return{building:addr.trim(),suite:''};
}
function compBuildingKey(addr){return parseCompAddress(addr).building.toLowerCase().replace(/[,\.]/g,'').trim();}

// ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
function toggleCalDone(id){const ev=state.calendar.find(e=>e.id===id);if(!ev)return;state.calendar=state.calendar.map(e=>e.id===id?{...e,done:!e.done,doneAt:e.done?null:tod()}:e);saveState();renderContent();}
function removeCalEv(id,e){e.stopPropagation();const ev=state.calendar.find(x=>x.id===id);if(!ev)return;trashItem('calendar',ev,ev.title||'Event');}
function renderCalendar(){const first=new Date(calY,calM,1).getDay(),dim=new Date(calY,calM+1,0).getDate();const td=new Date(),ty=td.getFullYear(),tm=td.getMonth(),tdd=td.getDate();const TC={Reminder:'var(--accent)',Tour:'var(--yellow)','Follow Up':'var(--green)',Meeting:'var(--purple)',Deadline:'var(--red)',Other:'var(--text3)'};const upcoming=state.calendar.filter(e=>e.date>=tod()).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,20);const mo=new Date(calY,calM,1).toLocaleDateString('en-US',{month:'long',year:'numeric'}).toUpperCase();function evOn(d){const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;return state.calendar.filter(e=>e.date===ds);}
const doneEvs=state.calendar.filter(e=>e.done).length;
return`<div style="display:grid;grid-template-columns:1fr 260px;gap:16px">
  <div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <button class="btn" onclick="calM--;if(calM<0){calM=11;calY--;}renderContent()">‚Äπ</button>
      <div style="font-weight:800;font-size:16px;color:var(--text);letter-spacing:.06em">${mo}</div>
      <button class="btn" onclick="calM++;if(calM>11){calM=0;calY++;}renderContent()">‚Ä∫</button>
    </div>
    <div class="cal-grid" style="margin-bottom:4px">${['SU','MO','TU','WE','TH','FR','SA'].map(d=>`<div style="text-align:center;font-size:9px;color:var(--text3);padding:4px 0;font-weight:700;letter-spacing:.1em">${d}</div>`).join('')}</div>
    <div class="cal-grid">
      ${Array.from({length:first}).map(()=>'<div></div>').join('')}
      ${Array.from({length:dim},(_,i)=>i+1).map(d=>{const evs=evOn(d),isT=d===tdd&&calM===tm&&calY===ty;return`<div class="cal-day${isT?' today':''}"><div class="cal-day-num">${d}</div>${evs.slice(0,3).map(e=>{const col=TC[e.type]||'var(--text3)';const done=e.done;return`<div class="cal-ev" style="background:${done?'var(--surface2)':col+'22'};color:${done?'var(--text3)':col};text-decoration:${done?'line-through':''};opacity:${done?.6:1};display:flex;align-items:center;gap:3px;cursor:pointer" onclick="toggleCalDone('${e.id}')" title="${done?'Click again to remove':'Click to mark done'}: ${esc(e.title)}"><span style="font-size:9px">${done?'‚òë':'‚òê'}</span><span style="overflow:hidden;white-space:nowrap;text-overflow:ellipsis;flex:1">${esc(e.title||'')}${e.time?' '+fmtTime(e.time):''}</span></div>`;}).join('')}${evs.length>3?`<div style="font-size:8px;color:var(--text3)">+${evs.length-3}</div>`:''}</div>`;}).join('')}
    </div>
    <div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" onclick="toggleSec('add-ev-c')">+ Add Event</button>
      ${doneEvs>0?`<button class="btn sm ghost" onclick="if(confirm('Remove all ${doneEvs} completed events?')){state.calendar=state.calendar.filter(e=>!e.done);saveState();renderContent();}">üóë Clear ${doneEvs} done</button>`:''}
    </div>
    <div id="add-ev-c" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-top:10px" class="card">
      <div class="form-grid">
        <div class="field" style="grid-column:span 2"><label>Title</label><input id="ev-title-c" placeholder="e.g. Tour with Acme Corp"/></div>
        <div class="field"><label>Date</label><input type="date" id="ev-date-c" value="${tod()}"/></div>
        <div class="field"><label>Time (optional)</label><input type="time" id="ev-time-c"/></div>
        <div class="field"><label>Type</label><select id="ev-type-c">${['Reminder','Tour','Follow Up','Meeting','Deadline','Other'].map(o=>`<option>${o}</option>`).join('')}</select></div>
        <div class="field"><label>Notify me</label><select id="ev-notify-c"><option value="">No notification</option><option value="0">At event time</option><option value="15">15 min before</option><option value="30">30 min before</option><option value="60">1 hour before</option><option value="1440">1 day before</option></select></div>
        <div class="field" style="grid-column:span 2"><label>Notes</label><input id="ev-notes-c" placeholder="Optional details‚Ä¶"/></div>
      </div>
      <button class="btn sm primary" style="margin-top:10px" onclick="saveCalEv()">Save Event</button>
    </div>
  </div>
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;overflow-y:auto;box-shadow:var(--shadow)">
    <div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:12px">Upcoming</div>
    ${upcoming.length===0?nilHtml('No upcoming events'):upcoming.map(e=>`<div class="upcoming-ev" style="display:flex;align-items:flex-start;gap:6px;opacity:${e.done?.65:1}"><span style="cursor:pointer;color:${e.done?'var(--green)':'var(--text3)'};font-size:14px;flex-shrink:0;margin-top:1px" onclick="toggleCalDone('${e.id}')" title="${e.done?'Uncheck':'Mark done'}">${e.done?'‚òë':'‚òê'}</span><div style="flex:1"><div style="color:var(--text3);font-size:9px;font-family:monospace;margin-bottom:1px">${fmt(e.date)}${e.time?' ¬∑ '+fmtTime(e.time):''}</div><div style="display:flex;gap:5px;align-items:center"><span style="background:${TC[e.type]||'var(--text3)'}22;color:${TC[e.type]||'var(--text3)'};font-size:8px;padding:1px 4px;border-radius:3px;letter-spacing:.06em">${(e.type||'').toUpperCase()}</span><span style="color:var(--text);font-size:12px;text-decoration:${e.done?'line-through':''}">${esc(e.title||'')}</span></div></div><button onclick="removeCalEv('${e.id}',event)" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;flex-shrink:0;padding:0 2px;opacity:.5" title="Remove">‚úï</button></div>`).join('')}
  </div>
</div>`;}

// ‚ïê‚ïê‚ïê TEMPLATES ‚ïê‚ïê‚ïê
function renderTemplates(){const tpl=selectedTpl?state.emailTemplates.find(t=>t.id===selectedTpl):null;
return`<div style="display:grid;grid-template-columns:240px 1fr;gap:16px">
  <div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-weight:800;color:var(--text);font-size:14px">Templates</span><button class="btn sm primary" onclick="newTpl()">+ New</button></div>
  ${state.emailTemplates.map(t=>`<div class="tpl-item${selectedTpl===t.id?' selected':''}" onclick="selectedTpl='${t.id}';renderContent()"><div style="font-weight:600;color:var(--text);font-size:12px;margin-bottom:2px">${esc(t.name)}</div><div style="font-size:10px;color:var(--text3);overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${esc(t.subject)}</div></div>`).join('')}</div>
  ${tpl?`<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px" class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:14px"><div style="font-weight:800;color:var(--text);font-size:17px">${esc(tpl.name)}</div><div style="display:flex;gap:6px"><button class="btn sm primary" onclick="saveTplEdits('${tpl.id}')">Save</button><button class="btn sm danger" onclick="delTpl('${tpl.id}')">Delete</button></div></div>
    <div class="field" style="margin-bottom:8px"><label>Name</label><input id="tpl-name" value="${esc(tpl.name)}"/></div>
    <div class="field" style="margin-bottom:8px"><label>Subject</label><input id="tpl-subject" value="${esc(tpl.subject)}"/></div>
    <div class="field" style="margin-bottom:14px"><label>Body</label><textarea id="tpl-body" rows="12" style="resize:vertical;line-height:1.7">${esc(tpl.body)}</textarea></div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:12px"><div style="font-size:9px;color:var(--text3);margin-bottom:6px;letter-spacing:.1em;text-transform:uppercase;font-weight:700">Insert Placeholder</div><div style="display:flex;flex-wrap:wrap;gap:5px">${['[First Name]','[Company Name]','[Address]','[Date]','[Time]','[Target Area]','[X]','[Your Name]','[Expiration Date]'].map(p=>`<span onclick="insertPH('${p}')" style="font-size:10px;background:var(--accent-bg);border:1px solid var(--accent-border);border-radius:3px;padding:2px 7px;color:var(--accent);cursor:pointer;font-family:monospace">${p}</span>`).join('')}</div></div>
    <div style="background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--radius);padding:12px;margin-bottom:12px">
      <div style="font-size:9px;color:var(--green);letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:8px">üìß Send This Template</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
        <div class="field"><label>Recipient Email</label><input id="tpl-to" placeholder="contact@company.com"/></div>
        <div class="field"><label>Fill: [First Name]</label><input id="tpl-firstname" placeholder="e.g. John"/></div>
        <div class="field"><label>Fill: [Company Name]</label><input id="tpl-coname" placeholder="e.g. Acme Corp"/></div>
        <div class="field"><label>Fill: [Your Name]</label><input id="tpl-yourname" placeholder="e.g. Daniel"/></div>
      </div>
      <button class="btn sm success" onclick="openMailto('${tpl.id}')">‚úâ Open in Email Client (Gmail / Outlook / Mail)</button>
      <div style="font-size:10px;color:var(--green);margin-top:6px">Opens your default email app with subject and body pre-filled. Fill in placeholders above to auto-replace them first.</div>
    </div>
  </div>`:nilHtml('Select a template')}
</div>`;}

// ‚ïê‚ïê‚ïê EXPIRATIONS ‚ïê‚ïê‚ïê
function renderExpirations(){const all=[...state.deals.map(d=>({...d,_t:'deal'})),...state.prospects.map(p=>({...p,_t:'prospect',leaseExpiration:p.leaseExp}))].filter(d=>d.leaseExpiration);const buckets=[{l:'Critical ‚Äî 0 to 90 Days',min:0,max:90,c:'var(--red)',bg:'var(--red-bg)',b:'var(--red-border)'},{l:'Urgent ‚Äî 91 to 180 Days',min:91,max:180,c:'var(--orange)',bg:'var(--orange-bg)',b:'var(--orange-border)'},{l:'Planning ‚Äî 181 to 365 Days',min:181,max:365,c:'var(--yellow)',bg:'var(--yellow-bg)',b:'var(--yellow-border)'},{l:'Watch ‚Äî 366 to 548 Days',min:366,max:548,c:'var(--blue)',bg:'var(--blue-bg)',b:'var(--blue-border)'},{l:'Expired',min:-9999,max:-1,c:'var(--text3)',bg:'var(--surface2)',b:'var(--border)'}];
return`<div><div style="font-weight:800;color:var(--text);font-size:18px;margin-bottom:4px">Lease Expiration Tracker</div><div style="font-size:12px;color:var(--text3);margin-bottom:18px">Follow up at 18/12/6/3 months. These are your best leads.</div>
${buckets.map(b=>{const items=all.filter(d=>{const dy=daysUntil(d.leaseExpiration);return dy!=null&&dy>=b.min&&dy<=b.max;}).sort((a,c)=>daysUntil(a.leaseExpiration)-daysUntil(c.leaseExpiration));return`<div style="margin-bottom:20px"><div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><div style="width:8px;height:8px;background:${b.c};border-radius:50%"></div><span style="font-weight:700;color:${b.c};font-size:12px;letter-spacing:.08em">${b.l}</span><span style="background:${b.bg};border:1px solid ${b.b};border-radius:8px;padding:1px 7px;font-size:9px;color:${b.c}">${items.length}</span></div>
${items.length===0?`<div style="color:var(--text3);font-size:11px;padding-left:16px">None</div>`:`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px">${items.map(d=>{const dy=daysUntil(d.leaseExpiration);return`<div class="card" style="background:${b.bg};border:1px solid ${b.b};border-radius:var(--radius);padding:13px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-weight:700;color:var(--text)">${esc(d.tenantName||d.companyName||'‚Äî')}</span><span class="${dy<=90?'blink':''}" style="font-weight:800;color:${b.c};font-family:monospace">${dy>=0?dy+'d':'EXP'}</span></div><div style="font-size:10px;color:var(--text3);margin-bottom:6px">${fmt(d.leaseExpiration)} ¬∑ ${d._t}</div><button class="btn xs" onclick="addEvent({title:'Follow up: ${esc(d.tenantName||d.companyName||'')}',date:'${tod()}',type:'Follow Up',notes:'Expiration follow-up'})">+ Reminder</button></div>`;}).join('')}</div>`}
</div>`;}).join('')}</div>`;}

// ‚ïê‚ïê‚ïê ACTIVITY ‚ïê‚ïê‚ïê
function renderActivity(){const types=['All','Call','Email','Tour','Mailer','Canvassing','Note'];const filt=state.activities.filter(a=>actFilter==='All'||a.type===actFilter);return`<div>
  <div style="font-weight:800;color:var(--text);font-size:18px;margin-bottom:14px">Activity Log (${state.activities.length})</div>
  <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:16px">${types.slice(1).map(t=>`<div class="kpi-card card" style="text-align:center"><div class="kpi-val" style="font-size:20px;color:${actC(t)}">${state.activities.filter(a=>a.type===t).length}</div><div class="kpi-lbl">${t}s</div></div>`).join('')}</div>
  ${sfRow(types,actFilter,'actFilter')}
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)">
    <div class="act-row" style="background:var(--surface2);font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700;border-bottom:1px solid var(--border)"><span>Date</span><span>Type</span><span>Contact</span><span>Note</span></div>
    ${filt.length===0?`<div style="padding:20px;color:var(--text3);font-size:12px;text-align:center">No activity yet</div>`:''}
    ${filt.map((a,i)=>{const ent=[...state.deals,...state.prospects].find(d=>d.id===a.entityId);return`<div class="act-row" style="border-bottom:${i<filt.length-1?'1px solid var(--border)':'none'}">
      <span style="color:var(--text3);font-family:monospace;font-size:10px">${a.date}</span>
      <span style="background:${actC(a.type)}22;color:${actC(a.type)};border-radius:3px;padding:2px 6px;font-size:9px;font-weight:700;letter-spacing:.06em">${(a.type||'').toUpperCase()}</span>
      <span style="color:var(--text2);font-size:11px">${esc(ent?.tenantName||ent?.companyName||'‚Äî')}</span>
      <span style="color:var(--text)">${esc(a.note||'')}</span>
    </div>`;}).join('')}
  </div>
</div>`;}

// ‚ïê‚ïê‚ïê TRASH ‚ïê‚ïê‚ïê
function renderTrash(){purgeTrash();const trash=state.trash.slice().sort((a,b)=>new Date(b.deletedAt)-new Date(a.deletedAt));const TC={deals:'var(--accent)',prospects:'var(--green)',calendar:'var(--yellow)',comps:'var(--purple)'};const TL={deals:'Deal',prospects:'Prospect',calendar:'Event',comps:'Comp'};
return`<div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div style="font-weight:800;color:var(--text);font-size:18px">Trash Bin</div>${trash.length>0?`<button class="btn sm danger" onclick="emptyTrash()">Empty Trash</button>`:''}</div>
  <div style="font-size:12px;color:var(--text3);margin-bottom:18px">Items are kept for <strong style="color:var(--text)">180 days</strong>, then permanently removed.</div>
  <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:18px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px">${['deals','prospects','calendar','comps'].map(t=>{const n=trash.filter(x=>x.type===t).length;return`<div style="text-align:center"><div style="font-size:22px;font-weight:800;color:${n>0?TC[t]:'var(--text3)'};font-family:'DM Mono',monospace">${n}</div><div style="font-size:9px;color:var(--text3);letter-spacing:.1em">${TL[t]}s</div></div>`;}).join('')}</div>
  ${trash.length===0?`<div style="text-align:center;padding:48px 0;color:var(--text3);font-size:14px"><div style="font-size:36px;margin-bottom:12px">‚äò</div>Trash is empty</div>`:''}
  ${trash.map(item=>{const dl=TRASH_DAYS-(daysSince(item.deletedAt)||0);const urg=dl<=30;const d=item.data;const sub=d.location||d.companyAddress||d.address||d.submarket||'';return`<div class="trash-card card">
    <span class="trash-type" style="background:${TC[item.type]||'var(--text3)'}22;color:${TC[item.type]||'var(--text3)'};border:1px solid ${TC[item.type]||'var(--border)'}44">${TL[item.type]||item.type}</span>
    <div style="flex:1"><div style="font-weight:700;color:var(--text);font-size:13px;margin-bottom:2px">${esc(item.label||'‚Äî')}</div>${sub?`<div style="font-size:11px;color:var(--text3);margin-bottom:2px">${esc(sub)}</div>`:''}<div style="font-size:10px;color:var(--text3)">Deleted ${fmt(item.deletedAt)} ${d.status?'¬∑ '+d.status:''}</div></div>
    <div style="display:flex;flex-direction:column;gap:5px;flex-shrink:0;align-items:flex-end"><span class="${urg?'blink':''}" style="font-size:10px;font-family:monospace;color:${urg?'var(--red)':'var(--text3)'};font-weight:${urg?700:400}">${dl}d left</span><button class="btn sm success" onclick="restoreTrash('${item.id}')">Restore</button><button class="btn sm danger" onclick="permDelete('${item.id}')">Delete Forever</button></div>
  </div>`;}).join('')}
</div>`;}

// ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê
function renderSettings(){return`
  <div class="settings-section">
    <div class="settings-section-title">Appearance</div>
    <div class="toggle-row">
      <div><div style="font-weight:600;color:var(--text);font-size:13px">Dark Mode</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Switch between light and dark themes</div></div>
      <button class="toggle${settings.dark?' on':''}" onclick="settings.dark=!settings.dark;saveSettings();openModal('settings')"></button>
    </div>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">Notifications</div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:14px">
      <div style="font-size:11px;color:var(--text2);margin-bottom:10px">Browser notifications for calendar events. You must grant permission ‚Äî Chrome/Edge/Safari supported.</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn sm primary" onclick="requestNotifPermission().then?requestNotifPermission():Notification.requestPermission(r=>toast('Notifications: '+r))">üîî Enable Notifications</button>
        <button class="btn sm ghost" onclick="rescheduleAllNotifications();toast('Notifications rescheduled for '+state.calendar.filter(e=>e.notify&&!e.done).length+' events')">‚Ü∫ Reschedule All</button>
        <span id="notif-status" style="font-size:10px;color:var(--text3)">${'Notification' in window?(Notification.permission==='granted'?'‚úÖ Enabled':'‚ö†Ô∏è '+Notification.permission):'‚ùå Not supported'}</span>
      </div>
    </div>
    <div class="settings-section-title">Commission Settings</div>
    <div class="toggle-row">
      <div><div style="font-weight:600;color:var(--text);font-size:13px">Tax Rate for After-Tax Estimate</div><div style="font-size:11px;color:var(--text3);margin-top:2px">Used in commission calculations and dashboard chart</div></div>
      <div style="display:flex;align-items:center;gap:8px"><input type="number" id="tax-rate-inp" value="${settings.taxRate||30}" min="0" max="99" style="width:70px;text-align:center"/>%</div>
    </div>
    <button class="btn sm primary" style="margin-top:10px" onclick="settings.taxRate=parseInt(q('tax-rate-inp').value)||30;saveSettings();toast('Tax rate saved');openModal('settings')">Save</button>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">Dashboard Layout</div>
    <div style="font-size:12px;color:var(--text3);margin-bottom:8px">Drag the dashboard widgets directly on the Command Center to reorder them.</div>
  </div>
  <div class="settings-section">
    <div class="settings-section-title">Data Management</div>
    <div style="background:var(--green-bg);border:1px solid var(--green-border);border-radius:var(--radius);padding:10px 14px;margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;color:var(--green);letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px">üíæ Full CRM Backup (Recommended Weekly)</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn sm success" onclick="exportBackup();closeModal()">üíæ Download Full Backup (.json)</button>
        <button class="btn sm" onclick="importBackup();closeModal()">‚Üë Restore from Backup</button>
      </div>
      <div style="font-size:10px;color:var(--green);margin-top:6px">Backs up ALL data: deals, prospects, calendar, comps, activities, templates, referrals, trash.</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn sm" onclick="exportCSV(state.deals,'db-deals.csv')">‚Üì Export Deals CSV</button>
      <button class="btn sm" onclick="exportCSV(state.prospects,'db-prospects.csv')">‚Üì Export Prospects CSV</button>
      <button class="btn sm" onclick="exportCSV(state.activities,'db-activity.csv')">‚Üì Export Activity</button>
      <button class="btn sm danger" onclick="if(confirm('Reset ALL data? This cannot be undone.')){state=defState();saveState();closeModal();render();}">‚ö† Reset All Data</button>
    </div>
  </div>`;}

// ‚ïê‚ïê‚ïê SHARED HELPERS ‚ïê‚ïê‚ïê
function commBlockHtml(c,deal){
  if(!c||!c.gross)return`<div class="comm-block"><div style="font-size:9px;color:var(--text3);letter-spacing:.15em;text-transform:uppercase;margin-bottom:4px;font-weight:700">Commission Estimate</div><div style="font-size:12px;color:var(--text3)">Enter Size, Budget/PSF, and Lease Term to calculate</div></div>`;
  return`<div class="comm-block">
    <div style="font-size:9px;color:var(--text3);letter-spacing:.15em;text-transform:uppercase;margin-bottom:12px;font-weight:700">Commission Breakdown</div>
    ${[['Annual Rent',c.annual,'var(--text2)'],['Total Rent (full term)',c.total,'var(--text2)'],['Gross Commission ('+c.pct+'%)',c.gross,'var(--yellow)'],['70% Split',c.split,'var(--accent)'],['Take-Home (70% of 70%)',c.take,'var(--green)'],['After Tax ('+( settings.taxRate||30)+'%)',c.afterTax,'var(--purple)']].map(([l,v,col])=>`<div class="comm-row"><span style="font-size:12px;color:var(--text2)">${l}</span><span style="font-size:14px;font-weight:700;color:${col};font-family:'DM Mono',monospace">${usd(v)}</span></div>`).join('')}
    <div class="comm-summary">
      ${[['Gross',c.gross,'var(--yellow)'],['Take-Home',c.take,'var(--green)'],['After Tax',c.afterTax,'var(--purple)']].map(([l,v,col])=>`<div class="comm-cell"><span class="cl">${l}</span><span class="cv" style="color:${col}">${usd(v)}</span></div>`).join('')}
    </div>
  </div>`;}

function expBarHtml(exp,start){const days=daysUntil(exp);if(days===null)return'';const tot=start?Math.ceil((new Date(exp+'T12:00:00')-new Date(start+'T12:00:00'))/86400000):null;const pct=tot&&days?Math.max(0,Math.min(100,(days/tot)*100)):null;const col=days<=90?'var(--red)':days<=180?'var(--orange)':days<=365?'var(--yellow)':'var(--green)';return`<div class="exp-bar-wrap" style="border-color:${col}44"><div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700">Lease Expiration</span><span class="${days<=90?'blink':''}" style="color:${col};font-weight:800;font-family:monospace">${days>=0?days+'d left':'EXPIRED'}</span></div>${pct!=null?`<div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${col};border-radius:2px"></div></div>`:''}${`<div style="font-size:9px;color:var(--text3);margin-top:3px">Expires ${fmt(exp)}</div>`}</div>`;}

function googleDriveSection(deal){const hasUrl=deal.driveUrl&&deal.driveUrl.trim();return`<div class="drive-wrap"><span style="font-size:20px">üìÅ</span><div style="flex:1"><div style="font-size:9px;color:var(--green);letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px;font-weight:700">Google Drive Folder</div><input value="${esc(deal.driveUrl||'')}" placeholder="Paste Google Drive folder URL‚Ä¶" style="background:var(--green-bg);border-color:var(--green-border)" onchange="updDeal('${deal.id}',{driveUrl:this.value})"/>${hasUrl?`<a href="${esc(deal.driveUrl)}" target="_blank" style="font-size:11px;color:var(--green);margin-top:4px;display:block">‚Üó Open folder in Google Drive</a>`:''}  </div>${hasUrl?`<a href="${esc(deal.driveUrl)}" target="_blank" class="btn sm success" style="text-decoration:none;flex-shrink:0">Open Drive</a>`:''}</div>`;}

function section(title,body){const id='sec-'+title.replace(/[^a-zA-Z0-9]/g,'');return`<div class="section-wrap"><div class="section-title" onclick="toggleSec('${id}')"><span>${title}</span><span style="font-size:9px;color:var(--text3)">‚ñº</span></div><div id="${id}">${body}</div></div>`;}

function logActHtml(entityType,entityId){const cur=entityType==='deal'?dealActType:prosActType;return`<div><div class="sf-row">${ACT_TYPES.map(t=>`<button class="sf-btn" style="background:${cur===t?actC(t)+'22':'var(--surface2)'};color:${cur===t?actC(t):'var(--text3)'};border-color:${cur===t?actC(t)+'55':'var(--border)'}" onclick="${entityType==='deal'?'dealActType':'prosActType'}='${t}';renderContent()">${t}</button>`).join('')}</div><div style="display:flex;gap:8px;margin-top:8px"><input id="act-${entityId}" placeholder="Notes from outreach‚Ä¶" style="flex:1" onkeydown="if(event.key==='Enter')saveAct('${entityType}','${entityId}')"/><button class="btn primary" onclick="saveAct('${entityType}','${entityId}')">Log</button></div></div>`;}

function notesHtml(entity,entityType){return`<div><div style="display:flex;gap:8px;margin-bottom:10px"><textarea id="note-${entity.id}" rows="2" placeholder="Note from conversation‚Ä¶" style="flex:1;resize:vertical"></textarea><button class="btn primary" style="align-self:flex-end" onclick="saveNote('${entityType}','${entity.id}')">Save</button></div>${(entity.notes||[]).slice().reverse().map(n=>`<div class="note-card"><div class="note-meta">${n.date}</div><div style="color:var(--text);font-size:12px">${esc(n.text||'')}</div></div>`).join('')}</div>`;}

function actHistHtml(acts){if(!acts||!acts.length)return nilHtml('No activity logged yet');return acts.map(a=>`<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px"><span style="color:${actC(a.type)};min-width:70px;font-weight:700;font-size:9px">${(a.type||'').toUpperCase()}</span><span style="color:var(--text3);min-width:78px;font-size:9px;font-family:monospace">${a.date}</span><span style="color:var(--text)">${esc(a.note||'')}</span></div>`).join('');}

function quickEvHtml(name){return`<div class="form-grid">
  <div class="field" style="grid-column:span 2"><label>Title</label><input id="ev-title" value="${esc(name?'Follow up: '+name:'')}"/></div>
  <div class="field"><label>Date</label><input type="date" id="ev-date" value="${tod()}"/></div>
  <div class="field"><label>Time (optional)</label><input type="time" id="ev-time"/></div>
  <div class="field"><label>Type</label><select id="ev-type">${['Reminder','Tour','Follow Up','Meeting','Deadline','Other'].map(o=>`<option>${o}</option>`).join('')}</select></div>
  <div class="field"><label>Notify me</label><select id="ev-notify"><option value="">No notification</option><option value="0">At event time</option><option value="15">15 min before</option><option value="30">30 min before</option><option value="60">1 hour before</option><option value="1440">1 day before</option></select></div>
</div><button class="btn sm primary" style="margin-top:10px" onclick="saveQEv()">Save Event</button>`;}

// ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê
let activeModal=null;
function openModal(name,data){activeModal=name;const ov=q('modal-overlay'),box=q('modal-box');ov.style.display='flex';box.innerHTML=mWrap(name)+mContent(name,data);box.classList.add('card');}
function closeModal(){q('modal-overlay').style.display='none';activeModal=null;}
function mWrap(name){const titles={'new-deal':'New Deal','new-closed':'+ Add Closed Deal','quick-prospect':'‚ö° Quick Add Prospect','template-picker':'‚úâ Email Templates','settings':'‚öô Settings'};return`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-weight:800;color:var(--text);font-size:16px">${titles[name]||name}</div><button class="btn ghost sm" onclick="closeModal()">‚úï</button></div>`;}
function mContent(name,data){
  if(name==='new-closed')return`
  <div style="margin-bottom:14px">
    <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px">Deal Type</div>
    <div style="display:flex;gap:8px">
      <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;background:var(--blue-bg);border:2px solid var(--blue-border);border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:700;color:var(--blue)"><input type="radio" name="nc-type" value="Lease" checked onchange="toggleClosedType()"/> üìÑ Lease</label>
      <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;background:var(--purple-bg);border:2px solid var(--purple-border);border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:700;color:var(--purple)"><input type="radio" name="nc-type" value="Purchase" onchange="toggleClosedType()"/> üè¢ Purchase / Sale</label>
    </div>
  </div>

  <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">üë§ Contact & Company</div>
  <div class="form-grid">
    <div class="field"><label>Tenant / Client / Company *</label><input id="nc-co" placeholder="Required"/></div>
    <div class="field"><label>Contact Name</label><input id="nc-cn"/></div>
    <div class="field"><label>Phone</label><input id="nc-ph" placeholder="(555) 000-0000"/></div>
    <div class="field"><label>Email</label><input type="email" id="nc-em"/></div>
  </div>

  <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;margin-top:12px">üè¢ Property</div>
  <div class="form-grid">
    <div class="field"><label>Property / Address</label><input id="nc-lo" placeholder="123 Main St, City, ST"/></div>
    <div class="field"><label>Submarket</label><input id="nc-sm" placeholder="e.g. Downtown, Midtown"/></div>
    <div class="field"><label>Building Size (SF)</label><input id="nc-sf" placeholder="e.g. 5000"/></div>
    <div class="field"><label>Close Date</label><input type="date" id="nc-cd" value="${tod()}"/></div>
  </div>

  <div id="nc-lease-fields">
    <div style="font-size:10px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;margin-top:12px">üìÑ Lease Details</div>
    <div class="form-grid">
      <div class="field"><label>Rate (PSF / yr)</label><input id="nc-psf" placeholder="e.g. 28.50"/></div>
      <div class="field"><label>Lease Term (years)</label><input id="nc-lt" placeholder="e.g. 5"/></div>
      <div class="field"><label>Lease Start</label><input type="date" id="nc-ls"/></div>
      <div class="field"><label>Lease End / Expiration</label><input type="date" id="nc-le"/></div>
      <div class="field"><label>Landlord / LL Name</label><input id="nc-ll" placeholder="Landlord or owner name"/></div>
      <div class="field"><label>Commission %</label><input id="nc-cp" value="3" placeholder="3"/></div>
    </div>
  </div>

  <div id="nc-purchase-fields" style="display:none">
    <div style="font-size:10px;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;margin-top:12px">üè¢ Purchase Details</div>
    <div class="form-grid">
      <div class="field"><label>Purchase Price ($)</label><input id="nc-pp" placeholder="e.g. 2500000"/></div>
      <div class="field"><label>Price Per SF ($)</label><input id="nc-ppsf" placeholder="auto-calc or override"/></div>
      <div class="field"><label>Cap Rate (%)</label><input id="nc-cap" placeholder="e.g. 5.5"/></div>
      <div class="field"><label>Property Type</label><input id="nc-ptype" placeholder="Office, Retail, Industrial‚Ä¶"/></div>
      <div class="field"><label>Seller / Owner</label><input id="nc-seller" placeholder="Seller name"/></div>
      <div class="field"><label>Year Built</label><input id="nc-yr" placeholder="e.g. 2002"/></div>
      <div class="field"><label>Commission %</label><input id="nc-cp2" value="3" placeholder="3"/></div>
    </div>
  </div>

  <div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;margin-top:12px">üí∞ Commission ‚Äî leave blank to auto-calculate</div>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
    <div class="field"><label>Gross Commission ($)</label><input id="nc-mg" placeholder="e.g. 45,000"/></div>
    <div class="field"><label>After Split ($)</label><input id="nc-ms" placeholder="e.g. 31,500"/></div>
    <div class="field"><label>Take-Home ($)</label><input id="nc-mt" placeholder="e.g. 22,050"/></div>
  </div>

  <div style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">üìé Additional</div>
  <div class="form-grid">
    <div class="field"><label>Google Drive URL</label><input id="nc-dr" placeholder="https://drive.google.com/‚Ä¶"/></div>
    <div class="field"><label>Priority</label><select id="nc-pr"><option>High</option><option selected>Medium</option><option>Low</option></select></div>
    <div class="field" style="grid-column:span 2"><label>Notes / Deal Story</label><textarea id="nc-notes" rows="2" style="resize:vertical" placeholder="Deal notes, context, story‚Ä¶"></textarea></div>
  </div>
  <div style="display:flex;gap:8px;margin-top:16px">
    <button class="btn primary" onclick="submitClosedDeal()">‚ú¶ Save Closed Deal</button>
    <button class="btn ghost" onclick="closeModal()">Cancel</button>
  </div>`;
  if(name==='new-deal')return`<div class="form-grid">${[['Tenant/Company','nd-co'],['Contact Name','nd-cn'],['Phone','nd-ph'],['Email','nd-em'],['Current Address','nd-ca'],['Target Location','nd-lo'],['Size (SF)','nd-sf'],['Budget/Rate PSF','nd-bu'],['Lease Term (years)','nd-lt'],['Commission %','nd-cp']].map(([l,id])=>`<div class="field"><label>${l}</label><input id="${id}" ${id==='nd-cp'?'value="3"':''}/></div>`).join('')}<div class="field"><label>Deal Type</label><select id="nd-di"><option value="Leasing">üìÑ Leasing</option><option value="Buying">üè¢ Buying / Purchase</option></select></div><div class="field"><label>Status</label><select id="nd-st">${CLIENT_ST.map(s=>`<option>${s}</option>`).join('')}</select></div><div class="field"><label>Priority</label><select id="nd-pr"><option>High</option><option selected>Medium</option><option>Low</option></select></div><div class="field"><label>Lease Expiration</label><input type="date" id="nd-ex"/></div><div class="field"><label>Lease Start</label><input type="date" id="nd-ls"/></div><div class="field" style="grid-column:span 2"><label>Google Drive URL</label><input id="nd-dr" placeholder="https://drive.google.com/drive/folders/‚Ä¶"/></div></div><div style="display:flex;gap:8px;margin-top:14px"><button class="btn primary" onclick="submitDeal()">Save Deal</button><button class="btn ghost" onclick="closeModal()">Cancel</button></div>`;
  if(name==='quick-prospect')return`<div class="form-grid">${[['Company','np-co'],['Contact Name','np-cn'],['Phone','np-ph'],['Email','np-em'],['Address','np-ad'],['Current SF','np-sf'],['Current PSF','np-ps']].map(([l,id])=>`<div class="field"><label>${l}</label><input id="${id}"/></div>`).join('')}<div class="field"><label>Source / Lead Source</label><select id="np-sr">${['Cold Call','Email','Mailer','Canvassing','Referral','LinkedIn','Other'].map(o=>`<option>${o}</option>`).join('')}</select></div><div class="field"><label>Status</label><select id="np-st">${PROSP_ST.map(s=>`<option>${s}</option>`).join('')}</select></div><div class="field"><label>Priority</label><select id="np-pr"><option>High</option><option selected>Medium</option><option>Low</option></select></div><div class="field"><label>Lease Expiration</label><input type="date" id="np-ex"/></div></div><div style="display:flex;gap:8px;margin-top:12px"><button class="btn primary" onclick="submitProspect()">Add Prospect</button><button class="btn ghost" onclick="closeModal()">Cancel</button></div>`;
  if(name==='settings')return renderSettings();
  if(name==='template-picker'){
    const entity=data.type==='deal'?state.deals.find(d=>d.id===data.id):state.prospects.find(p=>p.id===data.id)||{};
    const fill=s=>{if(!s)return s;return s.replace(/\[Company Name\]/g,entity.companyName||entity.tenantName||'').replace(/\[First Name\]/g,(entity.contactName||'').split(' ')[0]||'').replace(/\[Address\]/g,entity.location||'').replace(/\[Current Address\]/g,entity.currentAddress||entity.companyAddress||'').replace(/\[Expiration Date\]/g,fmt(entity.leaseExpiration||entity.leaseExp));};
    return`<div style="display:flex;gap:14px"><div style="width:180px;flex-shrink:0">${state.emailTemplates.map(t=>`<div class="tpl-item" onclick="showTplPrev('${t.id}',${JSON.stringify(fill(t.subject))},${JSON.stringify(fill(t.body))});this.parentNode.querySelectorAll('.tpl-item').forEach(x=>x.classList.remove('selected'));this.classList.add('selected')" style="margin-bottom:5px">${esc(t.name)}</div>`).join('')}</div><div id="tpl-prev" style="flex:1;color:var(--text3);font-size:12px">Select a template</div></div>`;
  }
  return'';
}
let _tplClipboard='';
function showTplPrev(id,subject,body){
  const p=q('tpl-prev');if(!p)return;
  _tplClipboard='Subject: '+subject+'\n\n'+body;
  p.innerHTML=`<div style="font-weight:600;color:var(--text2);margin-bottom:8px">Subject: ${esc(subject)}</div><div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;white-space:pre-wrap;line-height:1.7;max-height:300px;overflow-y:auto;color:var(--text)">${esc(body)}</div><button class="btn primary" style="margin-top:10px" onclick="navigator.clipboard.writeText(_tplClipboard).then(()=>toast('Copied to clipboard!'))">Copy to Clipboard</button>`;
}

// ‚ïê‚ïê‚ïê HANDLERS ‚ïê‚ïê‚ïê
function saveAct(type,entityId){const inp=q('act-'+entityId);if(!inp)return;const note=inp.value.trim();if(!note)return;logActivity(entityId,type==='deal'?dealActType:prosActType,note);inp.value='';renderContent();}
function saveNote(entityType,entityId){const ta=q('note-'+entityId);if(!ta)return;const text=ta.value.trim();if(!text)return;const note={id:uid(),text,date:tod()};if(entityType==='deal')updDeal(entityId,{notes:[...(state.deals.find(d=>d.id===entityId)?.notes||[]),note]});else updProspect(entityId,{notes:[...(state.prospects.find(p=>p.id===entityId)?.notes||[]),note]});renderContent();}
function saveQEv(){
  const t=q('ev-title')?.value?.trim(),d=q('ev-date')?.value;
  if(!t||!d){toast('Title and date required');return;}
  const time=q('ev-time')?q('ev-time').value:'';
  const notify=q('ev-notify')?q('ev-notify').value:'';
  addEvent({title:t,date:d,time,notify,notes:'',type:q('ev-type')?.value||'Reminder'});
  scheduleNotification({title:t,date:d,time,notify,type:q('ev-type')?.value||'Reminder'});
  closeModal();
}
function saveCalEv(){
  const t=q('ev-title-c')?.value?.trim(),d=q('ev-date-c')?.value;
  if(!t||!d){toast('Title and date required');return;}
  const time=q('ev-time-c')?.value||'';
  const notify=q('ev-notify-c')?.value||'';
  const notes=q('ev-notes-c')?.value?.trim()||'';
  addEvent({title:t,date:d,time,notify,notes,type:q('ev-type-c')?.value||'Reminder'});
  scheduleNotification({title:t,date:d,time,notify,type:q('ev-type-c')?.value||'Reminder'});
  q('ev-title-c').value='';q('ev-time-c').value='';q('ev-notes-c').value='';
  toggleSec('add-ev-c');
}
function saveComp(){const addr=q('compAddr')?.value;if(!addr){toast('Address required');return;}addComp({address:addr,submarket:q('compSub')?.value||'',size:q('compSz')?.value||'',askingPsf:q('compPsf')?.value||'',leaseTerm:q('compLt')?.value||'',landlord:q('compLL')?.value||'',vacancyRate:q('compVac')?.value||'',notes:q('compNotes')?.value||''});toggleSec('add-comp-form');}
function submitDeal(){addDeal({tenantName:q('nd-co')?.value||'',contactName:q('nd-cn')?.value||'',contactPhone:q('nd-ph')?.value||'',contactEmail:q('nd-em')?.value||'',currentAddress:q('nd-ca')?.value||'',location:q('nd-lo')?.value||'',size:q('nd-sf')?.value||'',budget:q('nd-bu')?.value||'',leaseTerm:q('nd-lt')?.value||'',commPct:q('nd-cp')?.value||'3',dealIntent:q('nd-di')?.value||'Leasing',status:q('nd-st')?.value||'First Touch',priority:q('nd-pr')?.value||'Medium',leaseExpiration:q('nd-ex')?.value||'',leaseStart:q('nd-ls')?.value||'',driveUrl:q('nd-dr')?.value||''});closeModal();}
function submitProspect(){addProspect({companyName:q('np-co')?.value||'',contactName:q('np-cn')?.value||'',phone:q('np-ph')?.value||'',email:q('np-em')?.value||'',companyAddress:q('np-ad')?.value||'',currentSf:q('np-sf')?.value||'',currentPsf:q('np-ps')?.value||'',source:q('np-sr')?.value||'Cold Call',status:q('np-st')?.value||'First Touch',priority:q('np-pr')?.value||'Medium',leaseExp:q('np-ex')?.value||''});closeModal();}
function toggleClosedType(){const isLease=document.querySelector('input[name="nc-type"]:checked')?.value==='Lease';const lf=q('nc-lease-fields'),pf=q('nc-purchase-fields');if(lf)lf.style.display=isLease?'block':'none';if(pf)pf.style.display=isLease?'none':'block';}
function submitClosedDeal(){
  const co=q('nc-co')?.value?.trim();if(!co){toast('Company name required');return;}
  const isLease=document.querySelector('input[name="nc-type"]:checked')?.value!=='Purchase';
  const deal={
    tenantName:co,
    dealType:isLease?'Lease':'Purchase',
    contactName:q('nc-cn')?.value||'',
    contactPhone:q('nc-ph')?.value||'',
    contactEmail:q('nc-em')?.value||'',
    location:q('nc-lo')?.value||'',
    submarket:q('nc-sm')?.value||'',
    size:q('nc-sf')?.value||'',
    closedDate:q('nc-cd')?.value||tod(),
    manualGross:q('nc-mg')?.value||'',
    manualSplit:q('nc-ms')?.value||'',
    manualTakeHome:q('nc-mt')?.value||'',
    driveUrl:q('nc-dr')?.value||'',
    priority:q('nc-pr')?.value||'Medium',
    dealNotes:q('nc-notes')?.value||'',
    status:'Leased/Purchased',
  };
  if(isLease){
    deal.budget=q('nc-psf')?.value||'';
    deal.costPsf=q('nc-psf')?.value||'';
    deal.leaseTerm=q('nc-lt')?.value||'';
    deal.leaseStart=q('nc-ls')?.value||'';
    deal.leaseEnd=q('nc-le')?.value||'';
    deal.landlord=q('nc-ll')?.value||'';
    deal.commPct=q('nc-cp')?.value||'3';
  } else {
    deal.purchasePrice=q('nc-pp')?.value||'';
    deal.pricePsf=q('nc-ppsf')?.value||'';
    deal.capRate=q('nc-cap')?.value||'';
    deal.propertyType=q('nc-ptype')?.value||'';
    deal.landlord=q('nc-seller')?.value||'';
    deal.yearBuilt=q('nc-yr')?.value||'';
    deal.commPct=q('nc-cp2')?.value||'3';
  }
  addDeal(deal);closeModal();
}
function newTpl(){const t={id:uid(),name:'New Template',subject:'',body:''};pushUndo('Add template');state.emailTemplates.push(t);saveState();selectedTpl=t.id;renderContent();}
function saveTplEdits(id){pushUndo('Edit template');state.emailTemplates=state.emailTemplates.map(t=>t.id===id?{...t,name:q('tpl-name')?.value,subject:q('tpl-subject')?.value,body:q('tpl-body')?.value}:t);saveState();toast('Template saved');renderContent();}
function delTpl(id){if(!confirm('Delete template?'))return;pushUndo('Delete template');state.emailTemplates=state.emailTemplates.filter(t=>t.id!==id);saveState();selectedTpl=null;renderContent();}
function insertPH(p){const ta=q('tpl-body');if(!ta)return;const s=ta.selectionStart,e=ta.selectionEnd;ta.value=ta.value.slice(0,s)+p+ta.value.slice(e);ta.selectionStart=ta.selectionEnd=s+p.length;ta.focus();}
function openMailto(tplId){
  const tpl=state.emailTemplates.find(t=>t.id===tplId);if(!tpl)return;
  const to=q('tpl-to')?.value||'';
  const fn=q('tpl-firstname')?.value||'[First Name]';
  const co=q('tpl-coname')?.value||'[Company Name]';
  const yn=q('tpl-yourname')?.value||'[Your Name]';
  const today=new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  function fill(s){return(s||'').replace(/\[First Name\]/gi,fn).replace(/\[Company Name\]/gi,co).replace(/\[Your Name\]/gi,yn).replace(/\[Date\]/gi,today);}
  const subject=encodeURIComponent(fill(q('tpl-subject')?.value||tpl.subject));
  const body=encodeURIComponent(fill(q('tpl-body')?.value||tpl.body));
  window.open('mailto:'+encodeURIComponent(to)+'?subject='+subject+'&body='+body);
}
function toggleSec(id){const el=q(id);if(!el)return;el.style.display=el.style.display==='none'?'block':'none';}
function csvImportClick(type){const el=q('csv-'+type);if(el)el.click();}
function handleCSVFile(input,type){const file=input.files?.[0];if(!file)return;const r=new FileReader();r.onload=e=>{const rows=parseCSV(e.target.result);if(rows.length){if(type==='closed')importClosed(rows);else importCSV(type,rows);}else toast('No data found');};r.readAsText(file);input.value='';}

// ‚ïê‚ïê‚ïê TEMPLATES DATA ‚ïê‚ïê‚ïê
function defTpls(){return[{id:'t1',name:'Cold Call Follow-Up',subject:'Following up ‚Äì [Company Name]',body:"Hi [First Name],\n\nGreat connecting with you. I specialize in representing tenants exclusively ‚Äî no cost to you, ever.\n\nI'd love to learn more about [Company Name]'s space needs and what's available in [Target Area].\n\nWould you have 15 minutes this week?\n\nBest,\n[Your Name]\nDB CRE | Tenant Rep"},{id:'t2',name:'Tour Confirmation',subject:'Tour Confirmed ‚Äì [Address] on [Date]',body:"Hi [First Name],\n\nLooking forward to touring [Address] with you on [Date] at [Time].\n\nI'll have a market comparison ready so we can make the most of our time.\n\nSee you then!\n\n[Your Name]"},{id:'t3',name:'Lease Renewal Warning',subject:'Your Lease Expires in [X] Months',body:"Hi [First Name],\n\nYour lease at [Current Address] expires [Expiration Date]. This is the ideal window to negotiate.\n\nLandlords negotiate hardest when they know you have options ‚Äî and I can show you what's out there at no cost to you.\n\nWant to connect?\n\n[Your Name]"},{id:'t4',name:'Market Update',subject:'Market Update: [Submarket]',body:"Hi [First Name],\n\nQuick market intel for [Submarket]:\n\n‚Ä¢ Avg asking: $[X] PSF\n‚Ä¢ Vacancy: [X]%\n\nHappy to discuss how this affects [Company Name].\n\n[Your Name]"},{id:'t5',name:'Post-Tour Follow-Up',subject:'Thoughts on [Address]?',body:"Hi [First Name],\n\nThanks for touring [Address]. I'm pulling together more options ‚Äî I'll have those to you by [Date].\n\n[Your Name]"},{id:'t6',name:'Second Touch',subject:'Checking in ‚Äì [Company Name]',body:"Hi [First Name],\n\nJust following up. Wanted to make sure you had my info for when the time is right.\n\n[Your Name]"},];}

// ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê
setInterval(()=>{const c=q('clock');if(c)c.textContent=new Date().toLocaleTimeString();},1000);
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();doUndo();}});
window.addEventListener('resize',()=>{if(currentView==='dashboard')setTimeout(drawCommChart,50);});

// ‚ïê‚ïê‚ïê TIME FORMAT ‚ïê‚ïê‚ïê
function fmtTime(t){if(!t)return'';try{const[h,m]=t.split(':');const hr=parseInt(h);return(hr%12||12)+':'+m+(hr>=12?' PM':' AM');}catch(e){return t;}}

// ‚ïê‚ïê‚ïê NOTIFICATION ENGINE ‚ïê‚ïê‚ïê
let _notifTimers=[];
function requestNotifPermission(){if(!('Notification' in window))return;if(Notification.permission==='default')Notification.requestPermission();}
function scheduleNotification(ev){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  if(ev.notify===undefined||ev.notify==='')return;
  if(!ev.date||!ev.time)return;
  try{
    const[yr,mo,dy]=ev.date.split('-').map(Number);
    const[hr,mn]=ev.time.split(':').map(Number);
    const evMs=new Date(yr,mo-1,dy,hr,mn,0).getTime();
    const notifyMs=evMs-Number(ev.notify)*60000;
    const msUntil=notifyMs-Date.now();
    if(msUntil<0||msUntil>8*24*3600*1000)return;
    const timer=setTimeout(()=>{
      try{new Notification('üìÖ '+ev.title,{body:(ev.notify==='0'?'Starting now':'In '+ev.notify+' min')+(ev.type?' ¬∑ '+ev.type:''),icon:''});}catch(e){}
    },msUntil);
    _notifTimers.push(timer);
  }catch(e){}
}
function rescheduleAllNotifications(){
  _notifTimers.forEach(clearTimeout);_notifTimers=[];
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  state.calendar.filter(e=>!e.done&&e.date&&e.time&&(e.notify||e.notify==='0')).forEach(e=>scheduleNotification(e));
}

window.onload=()=>{purgeTrash();applyTheme();renderNav();setView('dashboard');requestNotifPermission();setTimeout(rescheduleAllNotifications,1500);};

// ‚ïê‚ïê‚ïê CRE CALCULATOR ‚ïê‚ïê‚ïê
let calcMode='lease';
function openCalcModal(){document.getElementById('calc-modal').style.display='block';document.body.style.overflow='hidden';setCalcMode('lease');}
function closeCalcModal(){document.getElementById('calc-modal').style.display='none';document.body.style.overflow='';}
function setCalcMode(m){
  calcMode=m;
  document.getElementById('calc-lease').style.display=m==='lease'?'block':'none';
  document.getElementById('calc-purchase').style.display=m==='purchase'?'block':'none';
  document.getElementById('ctab-lease').className='btn '+(m==='lease'?'primary':'ghost');
  document.getElementById('ctab-purchase').className='btn '+(m==='purchase'?'primary':'ghost');
}
function calcKpiHtml(items){return items.map(([l,v,col])=>`<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px;text-align:center"><div style="font-size:8px;color:var(--text3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">${l}</div><div style="font-size:14px;font-weight:800;color:${col||'var(--text)'};font-family:'DM Mono',monospace">${v}</div></div>`).join('');}

function runLeaseCalc(){
  const sf=parseFloat(document.getElementById('cl-sf').value)||0;
  const psf=parseFloat(document.getElementById('cl-psf').value)||0;
  const opex=parseFloat(document.getElementById('cl-opex').value)||0;
  const structure=document.getElementById('cl-structure').value||'';
  const term=parseFloat(document.getElementById('cl-term').value)||0;
  const esc=parseFloat(document.getElementById('cl-esc').value)||0;
  const commPct=parseFloat(document.getElementById('cl-comm').value)||3;
  const freeRent=parseFloat(document.getElementById('cl-freerent').value)||0;
  const res=document.getElementById('cl-results');
  if(!sf||!psf){res.style.display='none';return;}
  res.style.display='block';

  const effPsf=psf+opex;                      // effective all-in rate
  const monthly=sf*psf/12;                    // base monthly
  const effMonthly=sf*effPsf/12;              // all-in monthly
  const annualBase=sf*psf;
  const effAnnual=sf*effPsf;
  const freeRentCredit=freeRent*monthly;

  // Base total with escalations
  let total=0,effTotal=0,breakdown=[];
  if(term>0){
    for(let yr=0;yr<term;yr++){
      const yPsf=psf*Math.pow(1+esc/100,yr);
      const yEffPsf=yPsf+opex;               // op ex doesn't escalate unless you want it to
      const yAmt=sf*yPsf;
      const yEffAmt=sf*yEffPsf;
      total+=yAmt; effTotal+=yEffAmt;
      breakdown.push({yr:yr+1,psf:yPsf,effPsf:yEffPsf,annual:yAmt,effAnnual:yEffAmt,monthly:yAmt/12,effMonthly:yEffAmt/12});
    }
  } else {total=annualBase;effTotal=effAnnual;}

  const effectiveTotal=Math.max(0,total-freeRentCredit);
  const commBase=effectiveTotal>0?effectiveTotal:total;
  const grossComm=commBase*(commPct/100);
  const afterSplit=grossComm*.7;
  const takeHome=afterSplit*.7;
  const fmt=v=>v>=1000000?'$'+(v/1000000).toFixed(2)+'M':v>=1000?'$'+Math.round(v).toLocaleString():'$'+v.toFixed(2);

  // ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
  const hasOpEx=opex>0;
  const kpiItems=[
    ['Monthly (Base)',fmt(monthly),'var(--blue)'],
    ['Annual (Base)',fmt(annualBase),'var(--accent)'],
    ['Total (Base)',fmt(total),'var(--yellow)'],
    ...(hasOpEx?[
      ['Monthly (All-In)',fmt(effMonthly),'var(--orange)'],
      ['Annual (All-In)',fmt(effAnnual),'var(--red)'],
      ['Total (All-In)',fmt(effTotal),'var(--red)'],
    ]:[]),
    ...(freeRentCredit>0?[['Free Rent Credit','-'+fmt(freeRentCredit),'var(--green)'],['Net Total',fmt(effectiveTotal),'var(--green)']]:[] ),
    ...(hasOpEx?[['Base Rate','$'+psf.toFixed(2)+'/SF','var(--text2)'],['Op Ex','$'+opex.toFixed(2)+'/SF','var(--orange)'],['All-In Rate','$'+effPsf.toFixed(2)+'/SF','var(--red)'],...(structure?[['Structure',structure,'var(--text3)']]:[] )]:[] ),
  ];
  const cols=kpiItems.length<=3?3:kpiItems.length<=6?3:3;
  document.getElementById('cl-kpis').style.gridTemplateColumns=`repeat(${cols},1fr)`;
  document.getElementById('cl-kpis').innerHTML=calcKpiHtml(kpiItems);
  document.getElementById('cl-comm-kpis').innerHTML=calcKpiHtml([
    ['Gross Commission',fmt(grossComm),'var(--yellow)'],
    ['After Split (70%)',fmt(afterSplit),'var(--accent)'],
    ['Take-Home (70%)',fmt(takeHome),'var(--green)'],
    ['After Tax (30%)',fmt(takeHome*.7),'var(--purple)'],
  ]);

  // ‚îÄ‚îÄ Escalation schedule ‚îÄ‚îÄ
  const schedWrap=document.getElementById('cl-sched-wrap');
  if(breakdown.length>1&&esc>0){
    schedWrap.style.display='block';
    const cols2=hasOpEx?'auto 1fr 1fr 1fr 1fr 1fr':'auto 1fr 1fr 1fr';
    document.getElementById('cl-sched').innerHTML=`<div style="overflow-x:auto"><div style="display:grid;grid-template-columns:${cols2};gap:4px 10px;border:1px solid var(--border);border-radius:6px;padding:10px;background:var(--surface);min-width:${hasOpEx?480:300}px">
      <span style="font-weight:700;color:var(--text3);font-size:10px">Yr</span>
      <span style="font-weight:700;color:var(--text3);font-size:10px">Base PSF</span>
      <span style="font-weight:700;color:var(--text3);font-size:10px">Base Annual</span>
      <span style="font-weight:700;color:var(--text3);font-size:10px">Base Monthly</span>
      ${hasOpEx?'<span style="font-weight:700;color:var(--orange);font-size:10px">All-In Annual</span><span style="font-weight:700;color:var(--orange);font-size:10px">All-In Monthly</span>':''}
      ${breakdown.map(b=>`
        <span style="color:var(--text3)">${b.yr}</span>
        <span style="color:var(--accent);font-family:'DM Mono',monospace;font-size:11px">$${b.psf.toFixed(2)}</span>
        <span style="color:var(--text);font-family:'DM Mono',monospace;font-size:11px">$${Math.round(b.annual).toLocaleString()}</span>
        <span style="color:var(--text2);font-family:'DM Mono',monospace;font-size:11px">$${Math.round(b.monthly).toLocaleString()}</span>
        ${hasOpEx?`<span style="color:var(--orange);font-family:'DM Mono',monospace;font-size:11px">$${Math.round(b.effAnnual).toLocaleString()}</span><span style="color:var(--orange);font-family:'DM Mono',monospace;font-size:11px">$${Math.round(b.effMonthly).toLocaleString()}</span>`:''}
      `).join('')}
      <span style="color:var(--text3);padding-top:6px;border-top:1px solid var(--border)">TOTAL</span>
      <span style="padding-top:6px;border-top:1px solid var(--border)"></span>
      <span style="color:var(--yellow);font-family:'DM Mono',monospace;font-weight:800;font-size:11px;padding-top:6px;border-top:1px solid var(--border)">$${Math.round(total).toLocaleString()}</span>
      <span style="padding-top:6px;border-top:1px solid var(--border)"></span>
      ${hasOpEx?`<span style="color:var(--red);font-family:'DM Mono',monospace;font-weight:800;font-size:11px;padding-top:6px;border-top:1px solid var(--border)">$${Math.round(effTotal).toLocaleString()}</span><span style="padding-top:6px;border-top:1px solid var(--border)"></span>`:''}
    </div></div>`;
  } else {schedWrap.style.display='none';}

  // ‚îÄ‚îÄ Market Evaluator ‚îÄ‚îÄ
  calcLeaseMarket(psf,effPsf,sf,hasOpEx);
}

function calcLeaseMarket(dealPsf,dealEffPsf,dealSf,hasOpEx){
  const wrap=document.getElementById('cl-market-wrap');
  const comps=(typeof state!=='undefined'?state.comps:[]).filter(c=>{
    const v=parseFloat(c.askingPsf);return v>0;
  });
  if(!comps.length||!dealPsf){wrap.style.display='none';return;}
  wrap.style.display='block';
  document.getElementById('cl-comp-count').textContent=comps.length+' comps in your database';

  const psfVals=comps.map(c=>parseFloat(c.askingPsf)).filter(v=>v>0);
  const sfVals=comps.map(c=>parseFloat(c.size)).filter(v=>v>0);
  const avgPsf=psfVals.reduce((a,b)=>a+b,0)/psfVals.length;
  const medPsf=[...psfVals].sort((a,b)=>a-b)[Math.floor(psfVals.length/2)];
  const minPsf=Math.min(...psfVals),maxPsf=Math.max(...psfVals);
  const avgSf=sfVals.length?sfVals.reduce((a,b)=>a+b,0)/sfVals.length:0;
  const fmt=v=>'$'+v.toFixed(2);

  document.getElementById('cl-market-kpis').innerHTML=calcKpiHtml([
    ['Market Avg PSF',fmt(avgPsf),'var(--accent)'],
    ['Market Median',fmt(medPsf),'var(--blue)'],
    ['Range','$'+minPsf.toFixed(0)+' ‚Äì $'+maxPsf.toFixed(0),'var(--text2)'],
  ]);

  // Rating
  function rateIt(val,avg){
    const pct=(val-avg)/avg*100;
    if(pct<=-15)return{label:'Excellent ‚Äî Well Below Market',col:'var(--green)',score:5};
    if(pct<=-5)return{label:'Good ‚Äî Below Market',col:'var(--blue)',score:4};
    if(Math.abs(pct)<=5)return{label:'At Market Rate',col:'var(--yellow)',score:3};
    if(pct<=15)return{label:'Above Market',col:'var(--orange)',score:2};
    return{label:'High ‚Äî Significantly Above Market',col:'var(--red)',score:1};
  }
  const baseRating=rateIt(dealPsf,avgPsf);
  const effRating=hasOpEx?rateIt(dealEffPsf,avgPsf):null;
  const diff=dealPsf-avgPsf;
  const diffStr=(diff>0?'‚ñ≤ $'+(diff).toFixed(2)+' above avg':'‚ñº $'+Math.abs(diff).toFixed(2)+' below avg');

  let ratingHtml=`<div style="background:${baseRating.col}18;border:1px solid ${baseRating.col}44;border-radius:8px;padding:12px;margin-bottom:8px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
      <span style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em">Base Rate vs Market</span>
      <span style="font-weight:800;color:${baseRating.col}">${baseRating.label}</span>
    </div>
    <div style="font-size:11px;color:var(--text2)">Your rate: <strong>$${dealPsf.toFixed(2)}/SF</strong> ¬∑ Market avg: <strong>$${avgPsf.toFixed(2)}/SF</strong> ¬∑ <span style="color:${diff>0?'var(--red)':'var(--green)'}">${diffStr}</span></div>
  </div>`;
  if(hasOpEx&&effRating){
    const effDiff=dealEffPsf-avgPsf;
    const effDiffStr=(effDiff>0?'‚ñ≤ $'+effDiff.toFixed(2)+' above avg':'‚ñº $'+Math.abs(effDiff).toFixed(2)+' below avg');
    ratingHtml+=`<div style="background:${effRating.col}18;border:1px solid ${effRating.col}44;border-radius:8px;padding:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <span style="font-size:10px;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:.08em">All-In Rate vs Market (Base + Op Ex)</span>
        <span style="font-weight:800;color:${effRating.col}">${effRating.label}</span>
      </div>
      <div style="font-size:11px;color:var(--text2)">All-in rate: <strong style="color:var(--orange)">$${dealEffPsf.toFixed(2)}/SF</strong> ¬∑ Market avg (base only): <strong>$${avgPsf.toFixed(2)}/SF</strong> ¬∑ <span style="color:${effDiff>0?'var(--red)':'var(--green)'}">${effDiffStr}</span></div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px">Note: market comps may not include op ex ‚Äî compare with caution for NNN leases.</div>
    </div>`;
  }
  document.getElementById('cl-rating-wrap').innerHTML=ratingHtml;

  // Histogram
  const buckets={};
  psfVals.forEach(p=>{const b=Math.floor(p/5)*5;buckets[b]=(buckets[b]||0)+1;});
  const bKeys=Object.keys(buckets).map(Number).sort((a,b)=>a-b);
  const maxB=Math.max(...Object.values(buckets),1);
  const dealBucket=Math.floor(dealPsf/5)*5;
  const effBucket=hasOpEx?Math.floor(dealEffPsf/5)*5:null;
  document.getElementById('cl-histogram-wrap').innerHTML=`
    <div style="font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:6px">PSF Distribution</div>
    <div style="display:flex;align-items:flex-end;gap:3px;height:70px;padding-bottom:2px">
      ${bKeys.map(b=>{
        const h=Math.round((buckets[b]/maxB)*62);
        const isDeal=b===dealBucket;
        const isEff=b===effBucket;
        const col=isDeal?'var(--accent)':isEff?'var(--orange)':'var(--blue)';
        return`<div style="display:flex;flex-direction:column;align-items:center;flex:1" title="$${b}‚Äì$${b+5}/SF ¬∑ ${buckets[b]} comp${buckets[b]!==1?'s':''}">
          <div style="font-size:7px;color:var(--text3);margin-bottom:1px">${buckets[b]}</div>
          <div style="width:100%;background:${col}55;border-top:2px solid ${col};border-radius:2px 2px 0 0;height:${Math.max(h,3)}px"></div>
          <div style="font-size:7px;color:var(--text3);margin-top:2px;white-space:nowrap">$${b}</div>
        </div>`;
      }).join('')}
    </div>
    <div style="display:flex;gap:10px;font-size:9px;color:var(--text3);margin-top:4px;flex-wrap:wrap">
      <span><span style="color:var(--blue)">‚ñ†</span> Comps</span>
      <span><span style="color:var(--accent)">‚ñ†</span> Your base rate ($${dealPsf.toFixed(2)}/SF)</span>
      ${hasOpEx?`<span><span style="color:var(--orange)">‚ñ†</span> All-in rate ($${dealEffPsf.toFixed(2)}/SF)</span>`:''}
    </div>`;

  // Top 8 most similar comps
  const similar=comps
    .filter(c=>parseFloat(c.askingPsf)>0)
    .sort((a,b)=>Math.abs(parseFloat(a.askingPsf)-dealPsf)-Math.abs(parseFloat(b.askingPsf)-dealPsf))
    .slice(0,8);
  if(similar.length){
    document.getElementById('cl-similar-comps').innerHTML=`
      <div style="font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:6px">Closest Comps</div>
      <div style="overflow-x:auto">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:5px;font-size:9px;color:var(--text3);font-weight:700;border-bottom:1px solid var(--border);padding-bottom:5px;min-width:420px;text-transform:uppercase;letter-spacing:.07em">
          <span>Address</span><span>SF</span><span>PSF</span><span>Type</span><span>Œî vs Yours</span>
        </div>
        ${similar.map(c=>{
          const cp=parseFloat(c.askingPsf);
          const d=cp-dealPsf;
          const col=d>2?'var(--red)':d<-2?'var(--green)':'var(--yellow)';
          return`<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:5px;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;min-width:420px;align-items:center">
            <span style="color:var(--text);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(c.address||'').replace(/"/g,'&quot;')}">${c.address||'‚Äî'}${c._suite?`<span style="color:var(--accent);font-size:9px;display:block">${c._suite}</span>`:''}</span>
            <span style="color:var(--text2)">${c.size?Number(c.size).toLocaleString()+' SF':'‚Äî'}</span>
            <span style="color:var(--accent);font-weight:700">$${cp.toFixed(2)}</span>
            <span style="color:var(--text3)">${c.leaseType||c.submarket||'‚Äî'}</span>
            <span style="color:${col};font-weight:700">${(d>0?'+':'')+'$'+d.toFixed(2)}</span>
          </div>`;
        }).join('')}
      </div>`;
  }
}

function runPurchaseCalc(){
  const price=parseFloat(document.getElementById('cp-price').value)||0;
  const sf=parseFloat(document.getElementById('cp-sf').value)||0;
  const acres=parseFloat(document.getElementById('cp-acres').value)||0;
  const commPct=parseFloat(document.getElementById('cp-comm').value)||3;
  const capRate=parseFloat(document.getElementById('cp-cap').value)||0;
  const noi=parseFloat(document.getElementById('cp-noi').value)||0;
  const res=document.getElementById('cp-results');
  if(!price&&!noi){res.style.display='none';return;}
  res.style.display='block';
  const fmt=v=>v>=1000000?'$'+(v/1000000).toFixed(3)+'M':v>=1000?'$'+Math.round(v).toLocaleString():'$'+v.toFixed(2);
  const effectivePrice=price||(noi&&capRate?(noi/(capRate/100)):0);
  const pricePsf=effectivePrice&&sf?effectivePrice/sf:0;
  const pricePerAcre=effectivePrice&&acres?effectivePrice/acres:0;
  const impliedNOI=noi||(effectivePrice&&capRate?effectivePrice*(capRate/100):0);
  const impliedCap=effectivePrice&&impliedNOI?(impliedNOI/effectivePrice*100):0;
  const grossComm=effectivePrice*(commPct/100);
  const afterSplit=grossComm*.7;
  const takeHome=afterSplit*.7;
  const kpis=[];
  if(effectivePrice)kpis.push(['Sale Price',fmt(effectivePrice),'var(--yellow)']);
  if(pricePsf)kpis.push(['Price / SF',fmt(pricePsf),'var(--accent)']);
  if(pricePerAcre)kpis.push(['Price / Acre',fmt(pricePerAcre),'var(--blue)']);
  if(impliedNOI)kpis.push(['NOI (Annual)','$'+Math.round(impliedNOI).toLocaleString(),'var(--green)']);
  if(impliedCap)kpis.push(['CAP Rate',impliedCap.toFixed(2)+'%','var(--orange)']);
  const colCount=Math.min(kpis.length,3);
  document.getElementById('cp-kpis').style.gridTemplateColumns=`repeat(${colCount},1fr)`;
  document.getElementById('cp-kpis').innerHTML=calcKpiHtml(kpis);
  document.getElementById('cp-comm-kpis').innerHTML=calcKpiHtml([
    ['Gross Commission',fmt(grossComm),'var(--yellow)'],
    ['After Split (70%)',fmt(afterSplit),'var(--accent)'],
    ['Take-Home (70%)',fmt(takeHome),'var(--green)'],
    ['After Tax (30%)',fmt(takeHome*.7),'var(--purple)'],
  ]);
  // ‚îÄ‚îÄ Market Evaluator for Purchase ‚îÄ‚îÄ
  calcPurchaseMarket(pricePsf,effectivePrice,sf);
}

function calcPurchaseMarket(dealPsfPrice,dealTotalPrice,dealSf){
  const wrap=document.getElementById('cp-market-wrap');
  // For purchase, use closed deals as comparable sales
  const closedDeals=(typeof state!=='undefined'?state.deals:[])
    .filter(d=>d.status==='Leased/Purchased'&&(d.dealType==='Purchase'||d.dealType==='Buying'));
  const compsAll=(typeof state!=='undefined'?state.comps:[]).filter(c=>parseFloat(c.askingPsf)>0);
  const hasClosed=closedDeals.length>0;
  if(!compsAll.length&&!hasClosed){wrap.style.display='none';return;}
  wrap.style.display='block';

  const psfVals=compsAll.map(c=>parseFloat(c.askingPsf)).filter(v=>v>0);
  const closedPsfVals=closedDeals.map(d=>d.purchasePrice&&d.size?parseFloat(d.purchasePrice)/parseFloat(d.size):0).filter(v=>v>0);
  const allPsfVals=[...closedPsfVals,...(psfVals.length?[]:[] )]; // prefer closed sales, fall back to lease comps
  const useVals=closedPsfVals.length?closedPsfVals:psfVals;
  const avgPpSf=useVals.length?useVals.reduce((a,b)=>a+b,0)/useVals.length:0;
  const medPpSf=useVals.length?[...useVals].sort((a,b)=>a-b)[Math.floor(useVals.length/2)]:0;
  const compSource=closedPsfVals.length?'closed purchase comps':'lease comps (no purchase comps available)';

  document.getElementById('cp-comp-count').textContent=(closedPsfVals.length||psfVals.length)+' '+compSource;

  document.getElementById('cp-market-kpis').innerHTML=calcKpiHtml([
    ['Avg $/SF (Sales)',avgPpSf?'$'+avgPpSf.toFixed(2):'No data','var(--accent)'],
    ['Median $/SF',medPpSf?'$'+medPpSf.toFixed(2):'‚Äî','var(--blue)'],
    ['Comparable Deals',useVals.length.toString(),'var(--text2)'],
  ]);

  // Rate the deal price psf vs comps
  if(dealPsfPrice&&avgPpSf){
    const pct=(dealPsfPrice-avgPpSf)/avgPpSf*100;
    let rating,col;
    if(pct<=-15){rating='Excellent ‚Äî Well Below Market';col='var(--green)';}
    else if(pct<=-5){rating='Good ‚Äî Below Market';col='var(--blue)';}
    else if(Math.abs(pct)<=5){rating='At Market';col='var(--yellow)';}
    else if(pct<=15){rating='Above Market';col='var(--orange)';}
    else{rating='High ‚Äî Significantly Above Market';col='var(--red)';}
    const diff=dealPsfPrice-avgPpSf;
    document.getElementById('cp-rating-wrap').innerHTML=`
      <div style="background:${col}18;border:1px solid ${col}44;border-radius:8px;padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
          <span style="font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em">Price/SF vs Market</span>
          <span style="font-weight:800;color:${col}">${rating}</span>
        </div>
        <div style="font-size:11px;color:var(--text2)">Your price: <strong>$${dealPsfPrice.toFixed(2)}/SF</strong> ¬∑ Avg: <strong>$${avgPpSf.toFixed(2)}/SF</strong> ¬∑ <span style="color:${diff>0?'var(--red)':'var(--green)'}">${diff>0?'‚ñ≤':'‚ñº'} $${Math.abs(diff).toFixed(2)} ${diff>0?'above':'below'} avg</span></div>
      </div>`;
  } else {
    document.getElementById('cp-rating-wrap').innerHTML=`<div style="font-size:11px;color:var(--text3);padding:8px 0">Enter purchase price and SF to see market position.</div>`;
  }

  // Histogram of price/SF from closed deals
  if(useVals.length>1){
    const buckets={};
    useVals.forEach(p=>{const b=Math.floor(p/25)*25;buckets[b]=(buckets[b]||0)+1;});
    const bKeys=Object.keys(buckets).map(Number).sort((a,b)=>a-b);
    const maxB=Math.max(...Object.values(buckets),1);
    const dealBucket=dealPsfPrice?Math.floor(dealPsfPrice/25)*25:null;
    document.getElementById('cp-histogram-wrap').innerHTML=`
      <div style="font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:6px">Price/SF Distribution</div>
      <div style="display:flex;align-items:flex-end;gap:3px;height:60px">
        ${bKeys.map(b=>{
          const h=Math.round((buckets[b]/maxB)*54);
          const isDeal=b===dealBucket;
          return`<div style="display:flex;flex-direction:column;align-items:center;flex:1" title="$${b}‚Äì$${b+25}/SF ¬∑ ${buckets[b]}">
            <div style="font-size:7px;color:var(--text3);margin-bottom:1px">${buckets[b]}</div>
            <div style="width:100%;background:${isDeal?'var(--accent)55':'var(--purple)44'};border-top:2px solid ${isDeal?'var(--accent)':'var(--purple)'};border-radius:2px 2px 0 0;height:${Math.max(h,3)}px"></div>
            <div style="font-size:7px;color:var(--text3);margin-top:2px;white-space:nowrap">$${b}</div>
          </div>`;
        }).join('')}
      </div>`;
  } else {
    document.getElementById('cp-histogram-wrap').innerHTML='';
  }

  // Closed deal comps table
  if(closedDeals.length){
    document.getElementById('cp-similar-comps').innerHTML=`
      <div style="font-size:9px;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;font-weight:700;margin-bottom:6px">Closed Purchase Comps</div>
      <div style="overflow-x:auto">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:5px;font-size:9px;color:var(--text3);font-weight:700;border-bottom:1px solid var(--border);padding-bottom:5px;min-width:400px;text-transform:uppercase;letter-spacing:.07em">
          <span>Deal</span><span>SF</span><span>Price</span><span>$/SF</span><span>Œî vs Yours</span>
        </div>
        ${closedDeals.slice(0,8).map(d=>{
          const dp=parseFloat(d.purchasePrice)||0;
          const ds=parseFloat(d.size)||0;
          const dpsf=dp&&ds?dp/ds:0;
          const diff=dpsf&&dealPsfPrice?dpsf-dealPsfPrice:null;
          const col=diff===null?'var(--text3)':diff>0?'var(--red)':'var(--green)';
          return`<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:5px;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px;min-width:400px;align-items:center">
            <span style="color:var(--text);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.tenantName||d.companyName||'‚Äî'}</span>
            <span style="color:var(--text2)">${ds?ds.toLocaleString()+' SF':'‚Äî'}</span>
            <span style="color:var(--yellow);font-weight:700">${dp?'$'+Math.round(dp).toLocaleString():'‚Äî'}</span>
            <span style="color:var(--accent)">${dpsf?'$'+dpsf.toFixed(0):'-'}</span>
            <span style="color:${col};font-weight:700">${diff!==null?(diff>0?'+$':'-$')+Math.abs(diff).toFixed(0):'‚Äî'}</span>
          </div>`;
        }).join('')}
      </div>`;
  } else {
    document.getElementById('cp-similar-comps').innerHTML=`<div style="font-size:11px;color:var(--text3);padding:8px 0">No closed purchase deals in your CRM yet. Comps are based on lease data.</div>`;
  }
}

</script>

<!-- CRE CALCULATOR MODAL -->
<div id="calc-modal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);overflow-y:auto" onclick="if(event.target===this)closeCalcModal()">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:800px;margin:30px auto;padding:24px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.35)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <div>
        <div style="font-size:20px;font-weight:800;color:var(--text)">üßÆ CRE Calculator</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">Lease ¬∑ Purchase ¬∑ Op Ex ¬∑ Commission ¬∑ Market Comparison</div>
      </div>
      <button onclick="closeCalcModal()" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:22px;padding:4px">‚úï</button>
    </div>

    <!-- Mode Tabs -->
    <div style="display:flex;gap:6px;margin-bottom:18px;border-bottom:1px solid var(--border);padding-bottom:12px" id="calc-tabs">
      <button onclick="setCalcMode('lease')" id="ctab-lease" class="btn primary">üìÑ Lease</button>
      <button onclick="setCalcMode('purchase')" id="ctab-purchase" class="btn ghost">üè¢ Purchase</button>
    </div>

    <!-- LEASE CALC -->
    <div id="calc-lease">
      <div class="form-grid" style="margin-bottom:12px">
        <div class="field"><label>Square Footage (SF)</label><input type="number" id="cl-sf" placeholder="e.g. 2500" oninput="runLeaseCalc()"/></div>
        <div class="field"><label>Base Rate ($ / SF / yr)</label><input type="number" id="cl-psf" placeholder="e.g. 28.00" step="0.01" oninput="runLeaseCalc()"/></div>
        <div class="field"><label>Op Ex ($ / SF / yr)</label><input type="number" id="cl-opex" placeholder="e.g. 5.50 (NNN pass-thru)" step="0.01" oninput="runLeaseCalc()" title="Operating expenses ‚Äî CAM, taxes, insurance. Adds to base rate to show total occupancy cost."/></div>
        <div class="field"><label>Lease Structure</label><select id="cl-structure" onchange="runLeaseCalc()"><option value="">‚Äî Select ‚Äî</option><option>NNN</option><option>Gross</option><option>Modified Gross</option><option>Full Service</option></select></div>
        <div class="field"><label>Lease Term (years)</label><input type="number" id="cl-term" placeholder="e.g. 5" oninput="runLeaseCalc()"/></div>
        <div class="field"><label>Annual Escalation (%)</label><input type="number" id="cl-esc" placeholder="e.g. 3" step="0.1" oninput="runLeaseCalc()"/></div>
        <div class="field"><label>Commission %</label><input type="number" id="cl-comm" placeholder="e.g. 3" step="0.1" value="3" oninput="runLeaseCalc()"/></div>
        <div class="field"><label>Free Rent (months)</label><input type="number" id="cl-freerent" placeholder="e.g. 2" oninput="runLeaseCalc()"/></div>
      </div>
      <div id="cl-results" style="display:none">
        <!-- Summary KPIs -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px">
          <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:12px">Lease Summary</div>
          <div id="cl-kpis" style="display:grid;gap:10px;margin-bottom:12px"></div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px" id="cl-comm-kpis"></div>
        </div>
        <!-- Escalation schedule -->
        <div id="cl-sched-wrap" style="display:none;margin-bottom:12px">
          <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:8px">Escalation Schedule</div>
          <div id="cl-sched" style="font-size:11px"></div>
        </div>
        <!-- Market Evaluator -->
        <div id="cl-market-wrap" style="display:none">
          <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
            <span>‚öñ Market Comparison</span>
            <span id="cl-comp-count" style="font-weight:400"></span>
          </div>
          <div id="cl-market-kpis" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px"></div>
          <div id="cl-rating-wrap" style="margin-bottom:10px"></div>
          <div id="cl-histogram-wrap" style="margin-bottom:10px"></div>
          <div id="cl-similar-comps" style="font-size:11px"></div>
        </div>
      </div>
    </div>

    <!-- PURCHASE CALC -->
    <div id="calc-purchase" style="display:none">
      <div class="form-grid" style="margin-bottom:12px">
        <div class="field"><label>Asking / Sale Price ($)</label><input type="number" id="cp-price" placeholder="e.g. 2500000" oninput="runPurchaseCalc()"/></div>
        <div class="field"><label>Square Footage (SF)</label><input type="number" id="cp-sf" placeholder="e.g. 10000" oninput="runPurchaseCalc()"/></div>
        <div class="field"><label>Acreage</label><input type="number" id="cp-acres" placeholder="e.g. 2.5" step="0.01" oninput="runPurchaseCalc()"/></div>
        <div class="field"><label>Commission %</label><input type="number" id="cp-comm" placeholder="e.g. 3" step="0.1" value="3" oninput="runPurchaseCalc()"/></div>
        <div class="field"><label>CAP Rate (%)</label><input type="number" id="cp-cap" placeholder="e.g. 6.5" step="0.1" oninput="runPurchaseCalc()"/></div>
        <div class="field"><label>NOI (Annual $)</label><input type="number" id="cp-noi" placeholder="Optional ‚Äî or enter CAP+Price" oninput="runPurchaseCalc()"/></div>
      </div>
      <div id="cp-results" style="display:none">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px">
          <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:12px">Purchase Summary</div>
          <div id="cp-kpis" style="display:grid;gap:10px;margin-bottom:10px"></div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px" id="cp-comm-kpis"></div>
        </div>
        <!-- Purchase Market Evaluator -->
        <div id="cp-market-wrap" style="display:none">
          <div style="font-size:9px;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
            <span>‚öñ Market Comparison</span>
            <span id="cp-comp-count" style="font-weight:400"></span>
          </div>
          <div id="cp-market-kpis" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px"></div>
          <div id="cp-rating-wrap" style="margin-bottom:10px"></div>
          <div id="cp-histogram-wrap" style="margin-bottom:10px"></div>
          <div id="cp-similar-comps" style="font-size:11px"></div>
        </div>
      </div>
    </div>

  </div>
</div>

</body>
</html>
